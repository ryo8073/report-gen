# Gherkin シナリオ

## 🔐 認証機能

### ユーザー登録

**Scenario: 正常なユーザー登録**
```gherkin
Feature: ユーザー登録
  As a 新規ユーザー
  I want to アカウントを作成できる
  So that レポート生成サービスを利用できる

Scenario: 有効な情報でユーザー登録
  Given ユーザーが登録ページにアクセスしている
  When ユーザーが以下の情報を入力する:
    | 項目 | 値 |
    | 名前 | 山田太郎 |
    | メールアドレス | yamada@example.com |
    | パスワード | Password123 |
    | パスワード確認 | Password123 |
  And "新規登録"ボタンをクリックする
  Then "アカウント作成成功"メッセージが表示される
  And ログインページにリダイレクトされる
  And データベースにユーザー情報が保存される
```

**Scenario: 重複メールアドレスでの登録**
```gherkin
Scenario: 重複メールアドレスでの登録
  Given ユーザー"yamada@example.com"が既に登録されている
  When ユーザーが同じメールアドレスで登録を試行する
  Then "ユーザーが既に存在します"エラーメッセージが表示される
  And 登録は完了しない
```

**Scenario: 弱いパスワードでの登録**
```gherkin
Scenario: 弱いパスワードでの登録
  Given ユーザーが登録ページにアクセスしている
  When ユーザーが弱いパスワード"123"を入力する
  And "新規登録"ボタンをクリックする
  Then "パスワードは8文字以上で、大文字・小文字・数字を含む必要があります"エラーメッセージが表示される
  And 登録は完了しない
```

### ユーザーログイン

**Scenario: 正常なログイン**
```gherkin
Feature: ユーザーログイン
  As a 登録済みユーザー
  I want to アカウントにログインできる
  So that レポート生成サービスにアクセスできる

Scenario: 有効な認証情報でログイン
  Given ユーザー"yamada@example.com"が登録されている
  And ユーザーがログインページにアクセスしている
  When ユーザーが以下の情報を入力する:
    | 項目 | 値 |
    | メールアドレス | yamada@example.com |
    | パスワード | Password123 |
  And "ログイン"ボタンをクリックする
  Then "ログイン成功"メッセージが表示される
  And メインページにリダイレクトされる
  And セッションが作成される
  And 使用ログにログインアクションが記録される
```

**Scenario: 無効な認証情報でのログイン**
```gherkin
Scenario: 無効な認証情報でのログイン
  Given ユーザー"yamada@example.com"が登録されている
  When ユーザーが間違ったパスワードでログインを試行する
  Then "無効なメールアドレスまたはパスワード"エラーメッセージが表示される
  And ログインは失敗する
  And セッションは作成されない
```

**Scenario: レート制限によるログイン制限**
```gherkin
Scenario: レート制限によるログイン制限
  Given ユーザーが5回連続でログインに失敗している
  When ユーザーが6回目のログインを試行する
  Then "認証試行回数が上限に達しました。15分後に再試行してください"エラーメッセージが表示される
  And ログインは制限される
```

### ログアウト

**Scenario: 正常なログアウト**
```gherkin
Feature: ユーザーログアウト
  As a ログイン済みユーザー
  I want to セキュアにログアウトできる
  So that アカウントのセキュリティを保てる

Scenario: ログイン済みユーザーのログアウト
  Given ユーザーがログインしている
  When ユーザーが"ログアウト"ボタンをクリックする
  Then "ログアウト成功"メッセージが表示される
  And ログインページにリダイレクトされる
  And セッションが無効化される
  And クッキーが削除される
```

## 📄 レポート生成機能

### レポート生成

**Scenario: テキストのみでのレポート生成**
```gherkin
Feature: レポート生成
  As a 認証済みユーザー
  I want to テキストからレポートを生成できる
  So that プロフェッショナルな文書を作成できる

Scenario: テキストのみでのレポート生成
  Given ユーザーがログインしている
  And ユーザーがメインページにアクセスしている
  When ユーザーが以下の情報を入力する:
    | 項目 | 値 |
    | レポート種別 | エグゼクティブサマリー |
    | 入力テキスト | プロジェクトの概要について説明します |
    | 言語 | 日本語 |
  And "レポート生成"ボタンをクリックする
  Then "レポートを生成中..."メッセージが表示される
  And レポートが生成される
  And 生成されたレポートがプレビューに表示される
  And 使用ログにレポート生成アクションが記録される
```

**Scenario: ファイル付きでのレポート生成**
```gherkin
Scenario: ファイル付きでのレポート生成
  Given ユーザーがログインしている
  When ユーザーがPDFファイルをアップロードする
  And レポート種別を"投資分析（4部構成）"に選択する
  And "レポート生成"ボタンをクリックする
  Then PDFからテキストが抽出される
  And レポートが生成される
  And ファイル統計が記録される
```

**Scenario: カスタムプロンプトでのレポート生成**
```gherkin
Scenario: カスタムプロンプトでのレポート生成
  Given ユーザーがログインしている
  When ユーザーがカスタムプロンプトを入力する:
    | 項目 | 値 |
    | カスタムプロンプト | このデータを基に、競合他社との比較分析を行い、優位性を明確にしてください |
  And レポート種別を"比較分析"に選択する
  And "レポート生成"ボタンをクリックする
  Then カスタムプロンプトが反映される
  And 比較分析レポートが生成される
  And カスタムプロンプトが使用ログに記録される
```

**Scenario: 複数ファイル比較分析**
```gherkin
Scenario: 複数ファイル比較分析
  Given ユーザーがログインしている
  When ユーザーが複数のPDFファイルをアップロードする:
    | ファイル名 | 内容 |
    | 会社A_決算書.pdf | 会社Aの決算データ |
    | 会社B_決算書.pdf | 会社Bの決算データ |
  And レポート種別を"比較分析"に選択する
  And "レポート生成"ボタンをクリックする
  Then 複数ファイルが処理される
  And 比較分析レポートが生成される
  And 比較結果が表形式で表示される
  And 推奨事項が含まれる
```

**Scenario: ファイルサイズ制限**
```gherkin
Scenario: ファイルサイズ制限
  Given ユーザーがログインしている
  When ユーザーが5MBのファイルをアップロードしようとする
  Then "ファイルサイズが制限を超えています（最大4.5MB）"エラーメッセージが表示される
  And ファイルはアップロードされない
```

**Scenario: 未認証ユーザーのアクセス**
```gherkin
Scenario: 未認証ユーザーのアクセス
  Given ユーザーがログインしていない
  When ユーザーがレポート生成APIにアクセスする
  Then "認証が必要です"エラーメッセージが返される
  And レポート生成は実行されない
```

## 📊 管理者機能

### システム統計確認

**Scenario: 管理者ダッシュボードの表示**
```gherkin
Feature: 管理者ダッシュボード
  As a 管理者
  I want to システムの使用状況を確認できる
  So that サービスの健全性を監視できる

Scenario: 管理者ダッシュボードの表示
  Given 管理者ユーザーがログインしている
  When 管理者がダッシュボードページにアクセスする
  Then 以下の統計情報が表示される:
    | 項目 | 値 |
    | 総ユーザー数 | 150 |
    | 総リクエスト数 | 1200 |
    | 生成レポート数 | 800 |
    | 総ファイル数 | 2000 |
  And 過去30日の使用状況グラフが表示される
```

**Scenario: 一般ユーザーの管理者ページアクセス**
```gherkin
Scenario: 一般ユーザーの管理者ページアクセス
  Given 一般ユーザーがログインしている
  When 一般ユーザーが管理者ダッシュボードにアクセスする
  Then "管理者権限が必要です"エラーメッセージが表示される
  And メインページにリダイレクトされる
```

### 使用状況監視

**Scenario: 最近のアクティビティ確認**
```gherkin
Feature: 使用状況監視
  As a 管理者
  I want to ユーザーの活動を監視できる
  So that セキュリティと使用パターンを把握できる

Scenario: 最近のアクティビティ確認
  Given 管理者ユーザーがログインしている
  And システムにアクティビティログが存在する
  When 管理者がダッシュボードを表示する
  Then 最近のアクティビティ一覧が表示される
  And 各アクティビティに以下の情報が含まれる:
    | 項目 | 説明 |
    | アクション | レポート生成、ログイン等 |
    | ユーザー名 | 実行したユーザー |
    | 日時 | 実行日時 |
    | 詳細 | レポート種別、ファイル数等 |
```

## 🛡️ セキュリティ機能

### セッション管理

**Scenario: セッション期限切れ**
```gherkin
Feature: セッション管理
  As a システム
  I want to セキュアなセッション管理を提供する
  So that ユーザーセッションの安全性を保てる

Scenario: セッション期限切れ
  Given ユーザーが7日前にログインしている
  When ユーザーがAPIにアクセスする
  Then "セッションが期限切れです"エラーメッセージが返される
  And ログインページにリダイレクトされる
```

### 入力検証

**Scenario: 不正な入力データ**
```gherkin
Feature: 入力検証
  As a システム
  I want to 不正な入力を検証する
  So that セキュリティを保てる

Scenario: 不正な入力データ
  Given ユーザーがログインしている
  When ユーザーが不正なデータを送信する:
    | 項目 | 値 |
    | レポート種別 | <script>alert('xss')</script> |
    | 入力テキスト | ../../etc/passwd |
  Then 入力データがサニタイズされる
  And セキュリティヘッダーが設定される
  And レポート生成が正常に実行される
```

## 📈 使用状況追跡

### 統計記録

**Scenario: 使用統計の記録**
```gherkin
Feature: 使用状況追跡
  As a システム
  I want to ユーザーの使用状況を記録する
  So that サービス改善と監視ができる

Scenario: 使用統計の記録
  Given ユーザーがログインしている
  When ユーザーがレポートを生成する
  Then 以下の情報がログに記録される:
    | 項目 | 値 |
    | ユーザーID | 123 |
    | アクション | report_generated |
    | レポート種別 | エグゼクティブサマリー |
    | ファイル数 | 2 |
    | ファイルサイズ | 1024000 |
    | IPアドレス | 192.168.1.1 |
    | 日時 | 2024-01-01T00:00:00Z |
  And 個人を特定できる情報は最小限に抑えられる
```
