<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå‘ã‘ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="/lib/frontend-error-handler.js"></script>
    <script>
        // Ensure errorHandler is available
        if (typeof window.errorHandler === 'undefined') {
            console.warn('ErrorHandler not loaded, creating fallback');
            window.errorHandler = {
                handleError: (error, context, showNotification = true) => {
                    console.error(`Error in ${context}:`, error);
                    if (showNotification) {
                        alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message || error}`);
                    }
                },
                handleApiResponse: async (response, context) => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response;
                },
                showLoading: (button, text) => {
                    if (button) {
                        button.disabled = true;
                        button.dataset.originalText = button.textContent;
                        button.textContent = text || 'Loading...';
                    }
                },
                hideLoading: (button) => {
                    if (button) {
                        button.disabled = false;
                        button.textContent = button.dataset.originalText || button.textContent;
                    }
                },
                showNotification: (message, type, duration) => {
                    console.log(`${type.toUpperCase()}: ${message}`);
                    // Simple fallback notification
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        padding: 12px 20px;
                        background: ${type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : '#ef4444'};
                        color: white;
                        border-radius: 6px;
                        z-index: 10000;
                        font-size: 14px;
                    `;
                    notification.textContent = message;
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), duration || 3000);
                },
                getUserFriendlyMessage: (error, context) => {
                    return error.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                }
            };
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå‘ã‘ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</h1>
            <p>ãƒ†ã‚­ã‚¹ãƒˆãƒ»ç”»åƒãƒ»PDFã‹ã‚‰ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ¬ãƒãƒ¼ãƒˆã‚’è‡ªå‹•ç”Ÿæˆ</p>
            
            <!-- Navigation Links -->
            <div style="margin-top: var(--space-6); display: flex; gap: var(--space-3); justify-content: center; flex-wrap: wrap;">
                <a href="/investment-analysis.html" class="btn btn-primary" style="text-decoration: none;">
                    ğŸ“Š æŠ•è³‡åˆ†æãƒ¬ãƒãƒ¼ãƒˆ
                </a>
                <a href="/report-history.html" class="btn btn-secondary" style="text-decoration: none;">
                    ğŸ“‹ ãƒ¬ãƒãƒ¼ãƒˆå±¥æ­´
                </a>
            </div>
        </header>

        <!-- Main Form -->
        <div class="card">
            <form id="reportForm">
                <!-- Report Type Selection -->
                <div class="form-group">
                    <label for="reportType" class="form-label">
                        ãƒ¬ãƒãƒ¼ãƒˆç¨®åˆ¥
                    </label>
                    <select id="reportType" name="reportType" class="input-field" required>
                        <option value="">ãƒ¬ãƒãƒ¼ãƒˆç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="jp_investment_4part">æŠ•è³‡åˆ†æï¼ˆ4éƒ¨æ§‹æˆï¼‰</option>
                        <option value="jp_tax_strategy">ç¨å‹™æˆ¦ç•¥ï¼ˆæ¸›ä¾¡å„Ÿå´ï¼‰</option>
                        <option value="jp_inheritance_strategy">ç›¸ç¶šå¯¾ç­–æˆ¦ç•¥</option>
                        <option value="custom">ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</option>
                    </select>
                </div>

                <!-- Custom Prompt (shown when custom is selected) -->
                <div id="customPromptGroup" class="form-group" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2);">
                        <label for="customPrompt" class="form-label">
                            ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
                        </label>
                        <div style="display: flex; gap: var(--space-2);">
                            <button type="button" id="loadPromptBtn" class="btn btn-secondary" style="font-size: var(--font-size-sm); padding: var(--space-1) var(--space-3);">
                                ä¿å­˜æ¸ˆã¿èª­è¾¼
                            </button>
                            <button type="button" id="savePromptBtn" class="btn btn-secondary" style="font-size: var(--font-size-sm); padding: var(--space-1) var(--space-3);">
                                ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿å­˜
                            </button>
                        </div>
                    </div>
                    
                    <textarea 
                        id="customPrompt" 
                        name="customPrompt" 
                        rows="4" 
                        class="input-field"
                        placeholder="ç‹¬è‡ªã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚„åˆ†æè¦æ±‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
                    ></textarea>
                    
                    <div style="margin-top: var(--space-2);">
                        <p style="font-size: var(--font-size-xs); color: var(--color-gray-500);">
                            ä¾‹: "ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«ã€ç«¶åˆä»–ç¤¾ã¨ã®æ¯”è¼ƒåˆ†æã‚’è¡Œã„ã€å„ªä½æ€§ã‚’æ˜ç¢ºã«ã—ã¦ãã ã•ã„"
                        </p>
                    </div>
                </div>

                <!-- Tax Strategy Additional Info (shown when jp_tax_strategy is selected) -->
                <div id="taxStrategyGroup" class="form-group" style="display: none;">
                    <h3 style="font-size: var(--font-size-lg); font-weight: 600; margin-bottom: var(--space-4); color: var(--color-gray-800);">
                        ç¨å‹™æˆ¦ç•¥ã«å¿…è¦ãªæƒ…å ±
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-4);">
                        <div>
                            <label for="annualIncome" class="form-label">å¹´åï¼ˆä¸‡å††ï¼‰</label>
                            <input type="number" id="annualIncome" name="annualIncome" class="input-field" placeholder="1000" min="0">
                        </div>
                        <div>
                            <label for="currentTaxRate" class="form-label">ç¾åœ¨ã®æ‰€å¾—ç¨ç‡ï¼ˆ%ï¼‰</label>
                            <select id="currentTaxRate" name="currentTaxRate" class="input-field">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="20">20%ï¼ˆå¹´å330ä¸‡å††ã€œ695ä¸‡å††ï¼‰</option>
                                <option value="23">23%ï¼ˆå¹´å695ä¸‡å††ã€œ900ä¸‡å††ï¼‰</option>
                                <option value="33">33%ï¼ˆå¹´å900ä¸‡å††ã€œ1800ä¸‡å††ï¼‰</option>
                                <option value="40">40%ï¼ˆå¹´å1800ä¸‡å††ã€œ4000ä¸‡å††ï¼‰</option>
                                <option value="45">45%ï¼ˆå¹´å4000ä¸‡å††è¶…ï¼‰</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-4);">
                        <div>
                            <label for="familyMembers" class="form-label">æ‰¶é¤Šå®¶æ—æ•°</label>
                            <input type="number" id="familyMembers" name="familyMembers" class="input-field" placeholder="2" min="0">
                        </div>
                        <div>
                            <label for="otherDeductions" class="form-label">ãã®ä»–æ‰€å¾—æ§é™¤ï¼ˆä¸‡å††ï¼‰</label>
                            <input type="number" id="otherDeductions" name="otherDeductions" class="input-field" placeholder="200" min="0">
                        </div>
                    </div>
                    
                    <div>
                        <label for="investmentGoal" class="form-label">æŠ•è³‡ç›®æ¨™ãƒ»æœŸé–“</label>
                        <textarea id="investmentGoal" name="investmentGoal" rows="2" class="input-field" placeholder="ä¾‹ï¼š5å¹´é–“ã§å¹´é–“100ä¸‡å††ã®ç¯€ç¨åŠ¹æœã‚’ç›®æŒ‡ã™"></textarea>
                    </div>
                </div>

                <!-- Inheritance Strategy Additional Info (shown when jp_inheritance_strategy is selected) -->
                <div id="inheritanceStrategyGroup" class="form-group" style="display: none;">
                    <h3 style="font-size: var(--font-size-lg); font-weight: 600; margin-bottom: var(--space-4); color: var(--color-gray-800);">
                        ç›¸ç¶šå¯¾ç­–ã«å¿…è¦ãªæƒ…å ±
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-4);">
                        <div>
                            <label for="totalAssets" class="form-label">ç·è³‡ç”£é¡ï¼ˆä¸‡å††ï¼‰</label>
                            <input type="number" id="totalAssets" name="totalAssets" class="input-field" placeholder="10000" min="0">
                        </div>
                        <div>
                            <label for="liquidAssets" class="form-label">ç¾é‡‘ãƒ»é é‡‘ï¼ˆä¸‡å††ï¼‰</label>
                            <input type="number" id="liquidAssets" name="liquidAssets" class="input-field" placeholder="3000" min="0">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-4);">
                        <div>
                            <label for="realEstateAssets" class="form-label">æ—¢å­˜ä¸å‹•ç”£ï¼ˆä¸‡å††ï¼‰</label>
                            <input type="number" id="realEstateAssets" name="realEstateAssets" class="input-field" placeholder="5000" min="0">
                        </div>
                        <div>
                            <label for="otherAssets" class="form-label">ãã®ä»–è³‡ç”£ï¼ˆä¸‡å††ï¼‰</label>
                            <input type="number" id="otherAssets" name="otherAssets" class="input-field" placeholder="2000" min="0">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: var(--space-4);">
                        <label class="form-label">æ³•å®šç›¸ç¶šäººã®æ§‹æˆ</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--space-4);">
                            <div>
                                <label for="spouse" class="form-label" style="font-size: var(--font-size-sm);">é…å¶è€…</label>
                                <select id="spouse" name="spouse" class="input-field">
                                    <option value="0">ãªã—</option>
                                    <option value="1">ã‚ã‚Š</option>
                                </select>
                            </div>
                            <div>
                                <label for="children" class="form-label" style="font-size: var(--font-size-sm);">å­ä¾›ã®äººæ•°</label>
                                <input type="number" id="children" name="children" class="input-field" placeholder="2" min="0" max="10">
                            </div>
                            <div>
                                <label for="parents" class="form-label" style="font-size: var(--font-size-sm);">ä¸¡è¦ª</label>
                                <select id="parents" name="parents" class="input-field">
                                    <option value="0">ãªã—</option>
                                    <option value="1">ç‰‡è¦ª</option>
                                    <option value="2">ä¸¡è¦ª</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label for="inheritanceGoal" class="form-label">ç›¸ç¶šå¯¾ç­–ã®ç›®æ¨™</label>
                        <textarea id="inheritanceGoal" name="inheritanceGoal" rows="2" class="input-field" placeholder="ä¾‹ï¼šç›¸ç¶šç¨ã‚’50%å‰Šæ¸›ã—ã€å††æ»‘ãªè³‡ç”£æ‰¿ç¶™ã‚’å®Ÿç¾ã—ãŸã„"></textarea>
                    </div>
                </div>

                <!-- Input Text -->
                <div class="form-group">
                    <label for="inputText" class="form-label">
                        å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆ
                    </label>
                    <textarea 
                        id="inputText" 
                        name="inputText" 
                        rows="6" 
                        class="input-field"
                        placeholder="åˆ†æã—ãŸã„å†…å®¹ã‚„è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
                    ></textarea>
                </div>

                <!-- File Upload -->
                <div class="form-group">
                    <label for="fileInput" class="form-label">
                        ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ï¼ˆPDFãƒ»ç”»åƒï¼‰
                    </label>
                    <div class="file-upload" id="fileDropZone">
                        <input type="file" id="fileInput" multiple accept=".pdf,.png,.jpg,.jpeg" class="hidden">
                        <div class="file-upload-content">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <p class="mt-2 text-sm text-gray-600">
                                ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯
                                <span class="text-blue-600 hover:text-blue-500 cursor-pointer" onclick="document.getElementById('fileInput').click()">ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</span>
                            </p>
                            <p class="text-xs text-gray-500 mt-1">PDF, PNG, JPG (æœ€å¤§4.5MB)</p>
                        </div>
                    </div>
                    <div id="fileList" class="file-list"></div>
                </div>

                <!-- Options -->
                <div class="form-group">
                    <div style="display: flex; gap: var(--space-4); flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label for="language" class="form-label">
                                è¨€èª
                            </label>
                            <select id="language" name="language" class="input-field">
                                <option value="ja">æ—¥æœ¬èª</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Generate Button -->
                <div style="text-align: center; margin-top: var(--space-8);">
                    <button type="submit" id="generateBtn" class="btn btn-primary">
                        ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
                    </button>
                </div>
            </form>
        </div>

        <!-- Status/Progress -->
        <div id="statusSection" class="hidden status-section">
            <div class="alert-content">
                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 alert-icon"></div>
                <span id="statusText">ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­...</span>
            </div>
        </div>

        <!-- Results -->
        <div id="resultsSection" class="hidden results-section">
            <div class="results-header">
                <h2 class="results-title">ç”Ÿæˆã•ã‚ŒãŸãƒ¬ãƒãƒ¼ãƒˆ</h2>
                <div class="results-actions">
                    <button id="copyBtn" class="btn btn-secondary">
                        ã‚³ãƒ”ãƒ¼
                    </button>
                    <button id="downloadBtn" class="btn btn-secondary">
                        .md ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </button>
                </div>
            </div>
            <div id="preview" class="results-preview prose">
                <!-- Preview content will be inserted here -->
            </div>
        </div>

        <!-- Error Messages -->
        <div id="errorSection" class="hidden error-section">
            <div class="alert-content">
                <svg class="alert-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                </svg>
                <span id="errorText"></span>
            </div>
        </div>
    </div>

    <!-- Custom Prompt Save Modal -->
    <div id="savePromptModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜</h3>
                <button type="button" class="modal-close" onclick="closeSavePromptModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="savePromptForm">
                    <div class="form-group">
                        <label for="promptTitle" class="form-label">ã‚¿ã‚¤ãƒˆãƒ«</label>
                        <input type="text" id="promptTitle" name="promptTitle" class="input-field" placeholder="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«" required maxlength="100">
                    </div>
                    <div class="form-group">
                        <label for="promptDescription" class="form-label">èª¬æ˜ï¼ˆä»»æ„ï¼‰</label>
                        <textarea id="promptDescription" name="promptDescription" rows="2" class="input-field" placeholder="ã“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç”¨é€”ã‚„ç‰¹å¾´"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="promptTags" class="form-label">ã‚¿ã‚°ï¼ˆä»»æ„ï¼‰</label>
                        <input type="text" id="promptTags" name="promptTags" class="input-field" placeholder="ã‚¿ã‚°ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ï¼ˆä¾‹ï¼šåˆ†æ,æ¯”è¼ƒ,æŠ•è³‡ï¼‰">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…å®¹</label>
                        <textarea id="promptPreview" rows="4" class="input-field" readonly style="background-color: var(--color-gray-100);"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeSavePromptModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-primary" onclick="saveCustomPrompt()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Custom Prompt Load Modal -->
    <div id="loadPromptModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ä¿å­˜æ¸ˆã¿ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’èª­è¾¼</h3>
                <button type="button" class="modal-close" onclick="closeLoadPromptModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="promptsList">
                    <div class="loading-message">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeLoadPromptModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-6);
            border-bottom: 1px solid var(--color-gray-200);
        }

        .modal-header h3 {
            margin: 0;
            font-size: var(--font-size-lg);
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--color-gray-500);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: var(--color-gray-700);
        }

        .modal-body {
            padding: var(--space-6);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-3);
            padding: var(--space-6);
            border-top: 1px solid var(--color-gray-200);
        }

        .prompt-item {
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            padding: var(--space-4);
            margin-bottom: var(--space-3);
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .prompt-item:hover {
            border-color: var(--color-primary);
        }

        .prompt-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-2);
        }

        .prompt-item-title {
            font-weight: 600;
            color: var(--color-gray-800);
        }

        .prompt-item-date {
            font-size: var(--font-size-xs);
            color: var(--color-gray-500);
        }

        .prompt-item-description {
            color: var(--color-gray-600);
            font-size: var(--font-size-sm);
            margin-bottom: var(--space-2);
        }

        .prompt-item-tags {
            display: flex;
            gap: var(--space-1);
            flex-wrap: wrap;
        }

        .prompt-tag {
            background-color: var(--color-gray-100);
            color: var(--color-gray-700);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: var(--font-size-xs);
        }

        .prompt-item-actions {
            display: flex;
            gap: var(--space-2);
            margin-top: var(--space-2);
        }

        .prompt-action-btn {
            background: none;
            border: 1px solid var(--color-gray-300);
            padding: var(--space-1) var(--space-2);
            border-radius: 4px;
            font-size: var(--font-size-xs);
            cursor: pointer;
            transition: all 0.2s;
        }

        .prompt-action-btn:hover {
            background-color: var(--color-gray-50);
        }

        .prompt-action-btn.delete {
            color: var(--color-red-600);
            border-color: var(--color-red-300);
        }

        .prompt-action-btn.delete:hover {
            background-color: var(--color-red-50);
        }

        .loading-message {
            text-align: center;
            padding: var(--space-8);
            color: var(--color-gray-500);
        }
    </style>

    <!-- Trial Expired Modal -->
    <div id="trialExpiredModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="color: #dc2626;">è©¦ç”¨æœŸé–“ãŒçµ‚äº†ã—ã¾ã—ãŸ</h3>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: var(--space-4);">
                    <svg width="64" height="64" fill="#dc2626" viewBox="0 0 20 20" style="margin-bottom: var(--space-4);">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                    <p style="font-size: var(--font-size-lg); margin-bottom: var(--space-4);">
                        2é€±é–“ã®è©¦ç”¨æœŸé–“ã¾ãŸã¯15å›ã®åˆ©ç”¨åˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚
                    </p>
                    <p style="color: var(--color-gray-600); margin-bottom: var(--space-6);">
                        å¼•ãç¶šãã‚µãƒ¼ãƒ“ã‚¹ã‚’ã”åˆ©ç”¨ã„ãŸã ãã«ã¯ã€æœ‰æ–™ãƒ—ãƒ©ãƒ³ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚
                    </p>
                    <div style="display: flex; gap: var(--space-3); justify-content: center;">
                        <button onclick="showUpgradeModal()" class="btn btn-primary">
                            æœ‰æ–™ãƒ—ãƒ©ãƒ³ã‚’è¦‹ã‚‹
                        </button>
                        <button onclick="logout()" class="btn btn-secondary">
                            ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upgrade Modal -->
    <div id="upgradeModal" class="modal hidden">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>æœ‰æ–™ãƒ—ãƒ©ãƒ³ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</h3>
                <button type="button" class="modal-close" onclick="closeUpgradeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: var(--space-6);">
                    <p style="font-size: var(--font-size-lg); color: var(--color-gray-700);">
                        ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚’ç„¡åˆ¶é™ã§ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™
                    </p>
                </div>

                <!-- Pricing Plans -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-6);">
                    <!-- Basic Plan -->
                    <div class="pricing-card">
                        <div class="pricing-header">
                            <h4>ãƒ™ãƒ¼ã‚·ãƒƒã‚¯</h4>
                            <div class="pricing-price">Â¥2,980<span>/æœˆ</span></div>
                        </div>
                        <div class="pricing-features">
                            <div class="pricing-feature">âœ“ æœˆ50å›ã¾ã§ç”Ÿæˆ</div>
                            <div class="pricing-feature">âœ“ å…¨ãƒ¬ãƒãƒ¼ãƒˆç¨®åˆ¥å¯¾å¿œ</div>
                            <div class="pricing-feature">âœ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
                            <div class="pricing-feature">âœ“ ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿å­˜</div>
                            <div class="pricing-feature">âœ“ ãƒ¡ãƒ¼ãƒ«ã‚µãƒãƒ¼ãƒˆ</div>
                        </div>
                        <button class="btn btn-primary pricing-btn" onclick="selectPlan('basic')">
                            ãƒ™ãƒ¼ã‚·ãƒƒã‚¯ã‚’é¸æŠ
                        </button>
                    </div>

                    <!-- Pro Plan -->
                    <div class="pricing-card featured">
                        <div class="pricing-badge">ãŠã™ã™ã‚</div>
                        <div class="pricing-header">
                            <h4>ãƒ—ãƒ­</h4>
                            <div class="pricing-price">Â¥4,980<span>/æœˆ</span></div>
                        </div>
                        <div class="pricing-features">
                            <div class="pricing-feature">âœ“ ç„¡åˆ¶é™ç”Ÿæˆ</div>
                            <div class="pricing-feature">âœ“ å…¨ãƒ¬ãƒãƒ¼ãƒˆç¨®åˆ¥å¯¾å¿œ</div>
                            <div class="pricing-feature">âœ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
                            <div class="pricing-feature">âœ“ ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿å­˜</div>
                            <div class="pricing-feature">âœ“ å„ªå…ˆã‚µãƒãƒ¼ãƒˆ</div>
                            <div class="pricing-feature">âœ“ API ã‚¢ã‚¯ã‚»ã‚¹</div>
                        </div>
                        <button class="btn btn-primary pricing-btn" onclick="selectPlan('pro')">
                            ãƒ—ãƒ­ã‚’é¸æŠ
                        </button>
                    </div>

                    <!-- Enterprise Plan -->
                    <div class="pricing-card">
                        <div class="pricing-header">
                            <h4>ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚º</h4>
                            <div class="pricing-price">ãŠå•ã„åˆã‚ã›</div>
                        </div>
                        <div class="pricing-features">
                            <div class="pricing-feature">âœ“ ç„¡åˆ¶é™ç”Ÿæˆ</div>
                            <div class="pricing-feature">âœ“ ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</div>
                            <div class="pricing-feature">âœ“ å°‚ç”¨ã‚µãƒãƒ¼ãƒˆ</div>
                            <div class="pricing-feature">âœ“ ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹å¯¾å¿œ</div>
                            <div class="pricing-feature">âœ“ SLAä¿è¨¼</div>
                        </div>
                        <button class="btn btn-secondary pricing-btn" onclick="contactSales()">
                            ãŠå•ã„åˆã‚ã›
                        </button>
                    </div>
                </div>

                <div style="text-align: center; margin-top: var(--space-6); padding-top: var(--space-6); border-top: 1px solid var(--color-gray-200);">
                    <p style="color: var(--color-gray-600); font-size: var(--font-size-sm);">
                        ã™ã¹ã¦ã®ãƒ—ãƒ©ãƒ³ã§14æ—¥é–“ã®è¿”é‡‘ä¿è¨¼ä»˜ã
                    </p>
                </div>
            </div>
        </div>
    </div>

    <style>
        .pricing-card {
            border: 2px solid var(--color-gray-200);
            border-radius: 12px;
            padding: var(--space-6);
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
        }

        .pricing-card:hover {
            border-color: var(--color-primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .pricing-card.featured {
            border-color: var(--color-primary);
            background: linear-gradient(135deg, #fef7ff, #f3e8ff);
        }

        .pricing-badge {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-primary);
            color: white;
            padding: var(--space-1) var(--space-3);
            border-radius: 20px;
            font-size: var(--font-size-xs);
            font-weight: 600;
        }

        .pricing-header h4 {
            font-size: var(--font-size-xl);
            font-weight: 700;
            margin-bottom: var(--space-2);
            color: var(--color-gray-900);
        }

        .pricing-price {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: var(--space-4);
        }

        .pricing-price span {
            font-size: var(--font-size-sm);
            font-weight: 400;
            color: var(--color-gray-600);
        }

        .pricing-features {
            text-align: left;
            margin-bottom: var(--space-6);
        }

        .pricing-feature {
            padding: var(--space-2) 0;
            color: var(--color-gray-700);
            font-size: var(--font-size-sm);
        }

        .pricing-btn {
            width: 100%;
        }
    </style>

    <script type="module">
        // Authentication check
        let currentUser = null;
        
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/me-firebase', {
                    credentials: 'include'
                });
                
                // Use error handler for API response
                await window.errorHandler.handleApiResponse(response, 'authentication');
                
                const result = await response.json();
                if (result.success && result.user) {
                    currentUser = result.user;
                    updateUIForLoggedInUser();
                } else {
                    console.error('Invalid response format:', result);
                    window.location.href = '/login.html';
                }
            } catch (error) {
                // Enhanced error handling
                window.errorHandler.handleError(error, 'authentication', false);
                
                // Only redirect on auth errors, not network errors
                if (error.status === 401 || error.status === 403) {
                    window.location.href = '/login.html';
                } else {
                    // Show error but don't redirect for network issues
                    window.errorHandler.showNotification(
                        'Unable to verify authentication. Please refresh the page.',
                        'warning'
                    );
                }
            }
        }

        async function updateUIForLoggedInUser() {
            // Add user info to header
            const header = document.querySelector('.header p');
            header.innerHTML = `ã“ã‚“ã«ã¡ã¯ã€${currentUser.name}ã•ã‚“ï¼ãƒ†ã‚­ã‚¹ãƒˆãƒ»ç”»åƒãƒ»PDFã‹ã‚‰ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ¬ãƒãƒ¼ãƒˆã‚’è‡ªå‹•ç”Ÿæˆ`;
            
            // Check and display user status based on role
            await checkAndDisplayUserStatus();
            
            // Add user stats and logout button
            const headerElement = document.querySelector('.header');
            
            // Add token usage stats
            const statsDiv = document.createElement('div');
            statsDiv.id = 'userTokenStats';
            statsDiv.style.cssText = `
                background: var(--color-blue-50);
                border: 1px solid var(--color-blue-200);
                border-radius: 6px;
                padding: var(--space-3);
                margin-top: var(--space-4);
                font-size: var(--font-size-sm);
                color: var(--color-blue-800);
            `;
            statsDiv.innerHTML = '<div style="text-align: center;">Tokenä½¿ç”¨é‡ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
            headerElement.appendChild(statsDiv);
            
            // Load user token stats
            loadUserTokenStats();
            
            const logoutBtn = document.createElement('button');
            logoutBtn.className = 'btn btn-secondary';
            logoutBtn.style.marginTop = 'var(--space-4)';
            logoutBtn.textContent = 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ';
            logoutBtn.onclick = logout;
            headerElement.appendChild(logoutBtn);
        }

        async function checkAndDisplayUserStatus() {
            if (currentUser.role === 'team_member') {
                await displayTeamMemberInfo();
            } else if (currentUser.role === 'user') {
                await checkAndDisplayTrialStatus();
            }
            // Admin users don't need status display
        }

        async function checkAndDisplayTrialStatus() {
            try {
                const response = await fetch('/api/trial/status', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        displayTrialInfo(result.trial);
                    }
                }
            } catch (error) {
                console.error('Failed to check trial status:', error);
            }
        }

        async function displayTeamMemberInfo() {
            const headerElement = document.querySelector('.header');
            
            // Remove existing info if any
            const existingInfo = document.getElementById('userStatusInfo');
            if (existingInfo) {
                existingInfo.remove();
            }

            const statusDiv = document.createElement('div');
            statusDiv.id = 'userStatusInfo';
            statusDiv.style.cssText = `
                background: linear-gradient(135deg, #e0f2fe, #81d4fa);
                border: 1px solid #29b6f6;
                border-radius: 8px;
                padding: var(--space-4);
                margin-top: var(--space-4);
                color: #01579b;
            `;
            
            statusDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                    <strong>ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼</strong>
                </div>
                <div id="teamMemberUsage" style="font-size: var(--font-size-sm);">
                    ä½¿ç”¨çŠ¶æ³ã‚’èª­ã¿è¾¼ã¿ä¸­...
                </div>
            `;
            
            headerElement.appendChild(statusDiv);
            
            // Load team member usage
            await loadTeamMemberUsage();
        }

        async function loadTeamMemberUsage() {
            try {
                // This would be a new API endpoint for team member usage
                const response = await fetch('/api/user/team-usage', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const usage = result.usage;
                        document.getElementById('teamMemberUsage').innerHTML = `
                            ä»Šæœˆã®ä½¿ç”¨çŠ¶æ³: ${usage.usageCount}/${usage.monthlyLimit}å›
                            <div style="margin-top: var(--space-1); font-size: var(--font-size-xs);">
                                æ®‹ã‚Š: ${usage.remainingReports}å›
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Failed to load team member usage:', error);
                document.getElementById('teamMemberUsage').innerHTML = 'ä½¿ç”¨çŠ¶æ³ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ';
            }
        }

        function displayTrialInfo(trialInfo) {
            const headerElement = document.querySelector('.header');
            
            // Remove existing trial info if any
            const existingTrialInfo = document.getElementById('trialInfo');
            if (existingTrialInfo) {
                existingTrialInfo.remove();
            }

            if (trialInfo.subscriptionStatus === 'trial' && trialInfo.isTrialActive) {
                // Show trial status
                const trialInfoDiv = document.createElement('div');
                trialInfoDiv.id = 'trialInfo';
                trialInfoDiv.style.cssText = `
                    background: linear-gradient(135deg, #fef3c7, #fbbf24);
                    border: 1px solid #f59e0b;
                    border-radius: 8px;
                    padding: var(--space-4);
                    margin-top: var(--space-4);
                    color: #92400e;
                `;
                
                trialInfoDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        <strong>è©¦ç”¨æœŸé–“ä¸­</strong>
                    </div>
                    <div style="font-size: var(--font-size-sm);">
                        æ®‹ã‚Š: ${trialInfo.remainingDays}æ—¥ / ${trialInfo.remainingUsage}å›
                        <div style="margin-top: var(--space-2);">
                            <button onclick="showUpgradeModal()" class="btn btn-primary" style="font-size: var(--font-size-sm); padding: var(--space-1) var(--space-3);">
                                æœ‰æ–™ãƒ—ãƒ©ãƒ³ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
                            </button>
                        </div>
                    </div>
                `;
                
                headerElement.appendChild(trialInfoDiv);
            } else if (trialInfo.subscriptionStatus === 'trial_expired' || !trialInfo.canUseService) {
                // Show trial expired message
                showTrialExpiredModal(trialInfo);
            }
        }

        async function logout() {
            const logoutBtn = document.querySelector('button[onclick="logout()"]');
            
            try {
                // Show loading state
                window.errorHandler.showLoading(logoutBtn, 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆä¸­...');
                
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                // Use error handler for API response
                await window.errorHandler.handleApiResponse(response, 'logout');
                
                window.errorHandler.showNotification('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'success', 1000);
                
                // Redirect after short delay
                setTimeout(() => {
                    window.location.href = '/login.html';
                }, 1000);
                
            } catch (error) {
                // Enhanced error handling
                window.errorHandler.handleError(error, 'logout', false);
                
                // Still redirect to login even if logout request failed
                window.errorHandler.showNotification('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™', 'warning', 2000);
                setTimeout(() => {
                    window.location.href = '/login.html';
                }, 2000);
            } finally {
                // Hide loading state
                window.errorHandler.hideLoading(logoutBtn);
            }
        }

        // Check authentication on page load
        checkAuth();

        // Report type change handler
        document.getElementById('reportType').addEventListener('change', function() {
            const customPromptGroup = document.getElementById('customPromptGroup');
            const taxStrategyGroup = document.getElementById('taxStrategyGroup');
            const inheritanceStrategyGroup = document.getElementById('inheritanceStrategyGroup');
            
            // Hide all additional info groups
            customPromptGroup.style.display = 'none';
            taxStrategyGroup.style.display = 'none';
            inheritanceStrategyGroup.style.display = 'none';
            
            // Reset required fields
            document.getElementById('customPrompt').required = false;
            
            // Show relevant group based on selection
            if (this.value === 'custom') {
                customPromptGroup.style.display = 'block';
                document.getElementById('customPrompt').required = true;
            } else if (this.value === 'jp_tax_strategy') {
                taxStrategyGroup.style.display = 'block';
            } else if (this.value === 'jp_inheritance_strategy') {
                inheritanceStrategyGroup.style.display = 'block';
            }
        });

        // File handling
        const fileInput = document.getElementById('fileInput');
        const fileDropZone = document.getElementById('fileDropZone');
        const fileList = document.getElementById('fileList');
        const selectedFiles = [];

        // File drop zone events
        fileDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropZone.classList.add('border-blue-400', 'bg-blue-50');
        });

        fileDropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            fileDropZone.classList.remove('border-blue-400', 'bg-blue-50');
        });

        fileDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropZone.classList.remove('border-blue-400', 'bg-blue-50');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (validateFile(file)) {
                    selectedFiles.push(file);
                    displayFile(file);
                }
            });
        }

        function validateFile(file) {
            const maxSize = 4.5 * 1024 * 1024; // 4.5MB
            const allowedTypes = ['application/pdf', 'image/png', 'image/jpeg', 'image/jpg'];
            
            if (file.size > maxSize) {
                showError(`ãƒ•ã‚¡ã‚¤ãƒ« "${file.name}" ãŒå¤§ãã™ãã¾ã™ï¼ˆæœ€å¤§4.5MBï¼‰`);
                return false;
            }
            
            if (!allowedTypes.includes(file.type)) {
                showError(`ãƒ•ã‚¡ã‚¤ãƒ« "${file.name}" ã®å½¢å¼ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“`);
                return false;
            }
            
            return true;
        }

        function displayFile(file) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <div class="file-info">
                    <svg class="file-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                    </svg>
                    <div class="file-details">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">(${(file.size / 1024 / 1024).toFixed(1)}MB)</div>
                    </div>
                </div>
                <button onclick="removeFile('${file.name}')" class="file-remove">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            `;
            fileList.appendChild(fileItem);
        }

        function removeFile(fileName) {
            const index = selectedFiles.findIndex(f => f.name === fileName);
            if (index > -1) {
                selectedFiles.splice(index, 1);
            }
            // Remove from display
            const fileItems = fileList.querySelectorAll('div');
            fileItems.forEach(item => {
                if (item.textContent.includes(fileName)) {
                    item.remove();
                }
            });
        }

        // Form submission
        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const reportType = formData.get('reportType');
            const inputText = formData.get('inputText');
            const customPrompt = formData.get('customPrompt');
            const language = formData.get('language') || 'ja';

            // Collect additional information based on report type
            let additionalInfo = {};
            let finalInputText = inputText;

            if (reportType === 'custom' && customPrompt) {
                finalInputText = customPrompt + '\n\n' + (inputText || '');
            } else if (reportType === 'jp_tax_strategy') {
                additionalInfo = {
                    annualIncome: formData.get('annualIncome'),
                    currentTaxRate: formData.get('currentTaxRate'),
                    familyMembers: formData.get('familyMembers'),
                    otherDeductions: formData.get('otherDeductions'),
                    investmentGoal: formData.get('investmentGoal')
                };
                
                // Add tax strategy context to input text
                const taxContext = `
ã€æŠ•è³‡å®¶æƒ…å ±ã€‘
å¹´å: ${additionalInfo.annualIncome || 'æœªå…¥åŠ›'}ä¸‡å††
æ‰€å¾—ç¨ç‡: ${additionalInfo.currentTaxRate || 'æœªå…¥åŠ›'}%
æ‰¶é¤Šå®¶æ—æ•°: ${additionalInfo.familyMembers || 'æœªå…¥åŠ›'}äºº
ãã®ä»–æ‰€å¾—æ§é™¤: ${additionalInfo.otherDeductions || 'æœªå…¥åŠ›'}ä¸‡å††
æŠ•è³‡ç›®æ¨™: ${additionalInfo.investmentGoal || 'æœªå…¥åŠ›'}

ã€åˆ†æå¯¾è±¡ãƒ‡ãƒ¼ã‚¿ã€‘
${inputText || ''}`;
                finalInputText = taxContext;
                
            } else if (reportType === 'jp_inheritance_strategy') {
                additionalInfo = {
                    totalAssets: formData.get('totalAssets'),
                    liquidAssets: formData.get('liquidAssets'),
                    realEstateAssets: formData.get('realEstateAssets'),
                    otherAssets: formData.get('otherAssets'),
                    spouse: formData.get('spouse'),
                    children: formData.get('children'),
                    parents: formData.get('parents'),
                    inheritanceGoal: formData.get('inheritanceGoal')
                };
                
                // Add inheritance strategy context to input text
                const inheritanceContext = `
ã€è³‡ç”£æƒ…å ±ã€‘
ç·è³‡ç”£é¡: ${additionalInfo.totalAssets || 'æœªå…¥åŠ›'}ä¸‡å††
ç¾é‡‘ãƒ»é é‡‘: ${additionalInfo.liquidAssets || 'æœªå…¥åŠ›'}ä¸‡å††
æ—¢å­˜ä¸å‹•ç”£: ${additionalInfo.realEstateAssets || 'æœªå…¥åŠ›'}ä¸‡å††
ãã®ä»–è³‡ç”£: ${additionalInfo.otherAssets || 'æœªå…¥åŠ›'}ä¸‡å††

ã€æ³•å®šç›¸ç¶šäººæƒ…å ±ã€‘
é…å¶è€…: ${additionalInfo.spouse === '1' ? 'ã‚ã‚Š' : 'ãªã—'}
å­ä¾›: ${additionalInfo.children || '0'}äºº
ä¸¡è¦ª: ${additionalInfo.parents === '2' ? 'ä¸¡è¦ª' : additionalInfo.parents === '1' ? 'ç‰‡è¦ª' : 'ãªã—'}

ã€ç›¸ç¶šå¯¾ç­–ç›®æ¨™ã€‘
${additionalInfo.inheritanceGoal || 'æœªå…¥åŠ›'}

ã€åˆ†æå¯¾è±¡ãƒ‡ãƒ¼ã‚¿ã€‘
${inputText || ''}`;
                finalInputText = inheritanceContext;
            }

            if (!reportType) {
                showError('ãƒ¬ãƒãƒ¼ãƒˆç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (!finalInputText.trim() && selectedFiles.length === 0) {
                showError('ãƒ†ã‚­ã‚¹ãƒˆã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // Prepare files for upload
            const files = [];
            for (const file of selectedFiles) {
                const base64 = await fileToBase64(file);
                files.push({
                    name: file.name,
                    type: file.type,
                    data: base64  // APIãŒæœŸå¾…ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã«å¤‰æ›´
                });
            }

            const requestData = {
                reportType,
                inputText: finalInputText,
                files,
                additionalInfo,
                options: {
                    language
                }
            };

            const submitBtn = document.querySelector('button[type="submit"]');
            
            try {
                // Show loading state
                window.errorHandler.showLoading(submitBtn, 'ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­...');
                showStatus('ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­...');
                hideError();
                hideResults();
                
                // Show detailed progress
                showDetailedProgress();

                console.log('Sending request:', {
                    reportType: requestData.reportType,
                    inputTextLength: requestData.inputText?.length || 0,
                    filesCount: requestData.files?.length || 0,
                    hasAdditionalInfo: !!requestData.additionalInfo
                });

                const response = await fetch('/api/generate-firebase', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    credentials: 'include',
                    body: JSON.stringify(requestData)
                });

                console.log('Response status:', response.status);

                const result = await response.json();
                
                // Handle API-specific errors
                await handleApiError(response, result);
                hideDetailedProgress();
                displayResults(result);
                hideStatus();
                
                // Show success notification
                window.errorHandler.showNotification('ãƒ¬ãƒãƒ¼ãƒˆãŒæ­£å¸¸ã«ç”Ÿæˆã•ã‚Œã¾ã—ãŸ', 'success', 3000);

            } catch (error) {
                // Enhanced error handling
                hideDetailedProgress();
                window.errorHandler.handleError(error, 'report-generation');
                hideStatus();
                
                // Show legacy error display as fallback
                showError(window.errorHandler.getUserFriendlyMessage(error, 'report-generation'));
            } finally {
                // Hide loading state
                hideDetailedProgress();
                window.errorHandler.hideLoading(submitBtn);
            }
        });

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        function showStatus(message) {
            document.getElementById('statusText').textContent = message;
            document.getElementById('statusSection').classList.remove('hidden');
        }

        function hideStatus() {
            document.getElementById('statusSection').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorSection').classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorSection').classList.add('hidden');
        }

        function hideResults() {
            document.getElementById('resultsSection').classList.add('hidden');
        }

        function showDetailedProgress() {
            const statusText = document.getElementById('statusText');
            let step = 0;
            const steps = [
                'ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æº–å‚™ä¸­...',
                'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ä¸­...',
                'AIãƒ¢ãƒ‡ãƒ«ã«é€ä¿¡ä¸­...',
                'ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­...',
                'æœ€çµ‚èª¿æ•´ä¸­...'
            ];
            
            const progressInterval = setInterval(() => {
                if (step < steps.length) {
                    statusText.textContent = steps[step];
                    step++;
                } else {
                    clearInterval(progressInterval);
                }
            }, 1000);
            
            // Store interval ID to clear it later
            window.currentProgressInterval = progressInterval;
        }

        function hideDetailedProgress() {
            if (window.currentProgressInterval) {
                clearInterval(window.currentProgressInterval);
                window.currentProgressInterval = null;
            }
        }

        function displayResults(result) {
            const preview = document.getElementById('preview');
            const content = result.content || result.markdown || '';
            
            if (!content) {
                preview.innerHTML = '<p style="color: var(--color-red-600);">ãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸãŒã€å†…å®¹ã‚’è¡¨ç¤ºã§ãã¾ã›ã‚“ã€‚</p>';
                document.getElementById('resultsSection').classList.remove('hidden');
                return;
            }

            // Create editable textarea for the report
            preview.innerHTML = `
                <div style="margin-bottom: var(--space-4);">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: var(--space-2);">
                        <span style="font-size: var(--font-size-sm); color: var(--color-gray-600);">
                            ç”Ÿæˆã•ã‚ŒãŸãƒ¬ãƒãƒ¼ãƒˆï¼ˆç·¨é›†å¯èƒ½ï¼‰
                        </span>
                        <div style="font-size: var(--font-size-xs); color: var(--color-gray-500);">
                            ${result.usage ? `
                                Tokenä½¿ç”¨é‡: ${result.usage.totalTokens.toLocaleString()} 
                                (å…¥åŠ›: ${result.usage.promptTokens.toLocaleString()}, 
                                å‡ºåŠ›: ${result.usage.completionTokens.toLocaleString()})
                                <br>æ¨å®šã‚³ã‚¹ãƒˆ: $${result.usage.estimatedCost}
                            ` : ''}
                        </div>
                    </div>
                    <textarea 
                        id="reportContent" 
                        style="
                            width: 100%; 
                            min-height: 400px; 
                            padding: var(--space-4); 
                            border: 1px solid var(--color-gray-300); 
                            border-radius: 6px; 
                            font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif; 
                            font-size: var(--font-size-sm); 
                            line-height: 1.6;
                            resize: vertical;
                            background: white;
                        "
                        placeholder="ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™..."
                    >${content}</textarea>
                </div>
                
                <div style="margin-bottom: var(--space-4);">
                    <h4 style="margin-bottom: var(--space-2); color: var(--color-gray-800);">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h4>
                    <div 
                        id="reportPreview" 
                        style="
                            border: 1px solid var(--color-gray-300); 
                            border-radius: 6px; 
                            padding: var(--space-4); 
                            background: var(--color-gray-50);
                            min-height: 200px;
                            font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif;
                            line-height: 1.6;
                        "
                    ></div>
                </div>
            `;
            
            // Update preview when content changes
            const reportContent = document.getElementById('reportContent');
            const reportPreview = document.getElementById('reportPreview');
            
            function updatePreview() {
                const text = reportContent.value;
                // Simple markdown-like formatting
                let html = text
                    .replace(/\n/g, '<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/^# (.*$)/gm, '<h1 style="font-size: var(--font-size-xl); font-weight: 700; margin: var(--space-4) 0 var(--space-2) 0; color: var(--color-gray-900);">$1</h1>')
                    .replace(/^## (.*$)/gm, '<h2 style="font-size: var(--font-size-lg); font-weight: 600; margin: var(--space-3) 0 var(--space-2) 0; color: var(--color-gray-800);">$1</h2>')
                    .replace(/^### (.*$)/gm, '<h3 style="font-size: var(--font-size-md); font-weight: 600; margin: var(--space-2) 0 var(--space-1) 0; color: var(--color-gray-700);">$1</h3>');
                
                reportPreview.innerHTML = html || '<p style="color: var(--color-gray-500);">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>';
            }
            
            // Initial preview update
            updatePreview();
            
            // Update preview on input
            reportContent.addEventListener('input', updatePreview);
            
            document.getElementById('resultsSection').classList.remove('hidden');

            // Update copy functionality
            const copyBtn = document.getElementById('copyBtn');
            copyBtn.onclick = () => {
                const currentContent = document.getElementById('reportContent').value;
                navigator.clipboard.writeText(currentContent);
                
                // Show temporary feedback
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'ã‚³ãƒ”ãƒ¼æ¸ˆã¿';
                copyBtn.style.background = 'var(--color-green-100)';
                copyBtn.style.color = 'var(--color-green-800)';
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = '';
                    copyBtn.style.color = '';
                }, 2000);
            };

            // Update download functionality
            const downloadBtn = document.getElementById('downloadBtn');
            downloadBtn.onclick = () => {
                const currentContent = document.getElementById('reportContent').value;
                const blob = new Blob([currentContent], { type: 'text/markdown; charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `report_${new Date().toISOString().slice(0, 10)}.md`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Show feedback
                const originalText = downloadBtn.textContent;
                downloadBtn.textContent = 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿';
                setTimeout(() => downloadBtn.textContent = originalText, 2000);
            };
        }

        // Custom Prompt Management
        document.getElementById('savePromptBtn').addEventListener('click', openSavePromptModal);
        document.getElementById('loadPromptBtn').addEventListener('click', openLoadPromptModal);

        function openSavePromptModal() {
            const customPrompt = document.getElementById('customPrompt').value.trim();
            if (!customPrompt) {
                showError('ä¿å­˜ã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            document.getElementById('promptPreview').value = customPrompt;
            document.getElementById('savePromptModal').classList.remove('hidden');
        }

        function closeSavePromptModal() {
            document.getElementById('savePromptModal').classList.add('hidden');
            document.getElementById('savePromptForm').reset();
        }

        async function saveCustomPrompt() {
            const title = document.getElementById('promptTitle').value.trim();
            const description = document.getElementById('promptDescription').value.trim();
            const tagsInput = document.getElementById('promptTags').value.trim();
            const content = document.getElementById('customPrompt').value.trim();

            if (!title || !content) {
                showError('ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…å®¹ã¯å¿…é ˆã§ã™');
                return;
            }

            const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag) : [];

            try {
                const response = await fetch('/api/custom-prompts/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        title,
                        description,
                        content,
                        tags
                    })
                });

                const result = await response.json();

                if (result.success) {
                    window.errorHandler.showNotification('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success', 2000);
                    closeSavePromptModal();
                } else {
                    showError(result.error || 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

            } catch (error) {
                console.error('Save prompt error:', error);
                showError('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        async function openLoadPromptModal() {
            document.getElementById('loadPromptModal').classList.remove('hidden');
            await loadUserPrompts();
        }

        function closeLoadPromptModal() {
            document.getElementById('loadPromptModal').classList.add('hidden');
        }

        async function loadUserPrompts() {
            const promptsList = document.getElementById('promptsList');
            promptsList.innerHTML = '<div class="loading-message">èª­ã¿è¾¼ã¿ä¸­...</div>';

            try {
                const response = await fetch('/api/custom-prompts/list', {
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    displayPrompts(result.prompts);
                } else {
                    promptsList.innerHTML = '<div class="loading-message">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
                }

            } catch (error) {
                console.error('Load prompts error:', error);
                promptsList.innerHTML = '<div class="loading-message">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }

        function displayPrompts(prompts) {
            const promptsList = document.getElementById('promptsList');

            if (prompts.length === 0) {
                promptsList.innerHTML = '<div class="loading-message">ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            promptsList.innerHTML = prompts.map(prompt => `
                <div class="prompt-item" onclick="loadPrompt('${prompt.id}')">
                    <div class="prompt-item-header">
                        <div class="prompt-item-title">${escapeHtml(prompt.title)}</div>
                        <div class="prompt-item-date">${formatDate(prompt.createdAt)}</div>
                    </div>
                    ${prompt.description ? `<div class="prompt-item-description">${escapeHtml(prompt.description)}</div>` : ''}
                    ${prompt.tags && prompt.tags.length > 0 ? `
                        <div class="prompt-item-tags">
                            ${prompt.tags.map(tag => `<span class="prompt-tag">${escapeHtml(tag)}</span>`).join('')}
                        </div>
                    ` : ''}
                    <div class="prompt-item-actions">
                        <button class="prompt-action-btn" onclick="event.stopPropagation(); loadPrompt('${prompt.id}')">èª­è¾¼</button>
                        <button class="prompt-action-btn delete" onclick="event.stopPropagation(); deletePrompt('${prompt.id}', '${escapeHtml(prompt.title)}')">å‰Šé™¤</button>
                    </div>
                </div>
            `).join('');
        }

        async function loadPrompt(promptId) {
            try {
                const response = await fetch(`/api/custom-prompts/list`, {
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    const prompt = result.prompts.find(p => p.id === promptId);
                    if (prompt) {
                        document.getElementById('customPrompt').value = prompt.content;
                        closeLoadPromptModal();
                        window.errorHandler.showNotification('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success', 1500);
                    }
                }

            } catch (error) {
                console.error('Load prompt error:', error);
                showError('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        async function deletePrompt(promptId, promptTitle) {
            if (!confirm(`ã€Œ${promptTitle}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch(`/api/custom-prompts/delete?promptId=${promptId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    window.errorHandler.showNotification('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success', 1500);
                    await loadUserPrompts(); // Reload the list
                } else {
                    showError(result.error || 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

            } catch (error) {
                console.error('Delete prompt error:', error);
                showError('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Trial and Upgrade Management
        function showTrialExpiredModal(trialInfo) {
            document.getElementById('trialExpiredModal').classList.remove('hidden');
            
            // Disable the main form
            const reportForm = document.getElementById('reportForm');
            const formElements = reportForm.querySelectorAll('input, textarea, select, button');
            formElements.forEach(element => {
                element.disabled = true;
            });
        }

        function showUpgradeModal() {
            document.getElementById('upgradeModal').classList.remove('hidden');
            // Close trial expired modal if open
            document.getElementById('trialExpiredModal').classList.add('hidden');
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.add('hidden');
        }

        function selectPlan(planType) {
            // In a real implementation, this would integrate with a payment processor
            alert(`${planType}ãƒ—ãƒ©ãƒ³ãŒé¸æŠã•ã‚Œã¾ã—ãŸã€‚\n\nå®Ÿè£…æ™‚ã«ã¯æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ ï¼ˆStripeç­‰ï¼‰ã«é€£æºã—ã¾ã™ã€‚`);
            
            // For demo purposes, simulate upgrade
            if (confirm('ãƒ‡ãƒ¢ç”¨ï¼šã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                simulateUpgrade(planType);
            }
        }

        function contactSales() {
            // In a real implementation, this would open a contact form or redirect to sales
            alert('å–¶æ¥­ãƒãƒ¼ãƒ ã¸ã®ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ãã¾ã™ã€‚\n\nå®Ÿè£…æ™‚ã«ã¯é©åˆ‡ãªé€£çµ¡å…ˆã«èª˜å°ã—ã¾ã™ã€‚');
        }

        async function simulateUpgrade(planType) {
            try {
                // This would be replaced with actual payment processing
                const response = await fetch('/api/trial/upgrade', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ planType })
                });

                if (response.ok) {
                    window.errorHandler.showNotification('ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success', 3000);
                    closeUpgradeModal();
                    
                    // Re-enable the form
                    const reportForm = document.getElementById('reportForm');
                    const formElements = reportForm.querySelectorAll('input, textarea, select, button');
                    formElements.forEach(element => {
                        element.disabled = false;
                    });
                    
                    // Refresh trial status
                    await checkAndDisplayTrialStatus();
                } else {
                    throw new Error('Upgrade failed');
                }
            } catch (error) {
                console.error('Upgrade error:', error);
                showError('ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // Enhanced error handling for trial limits and API responses
        async function handleApiError(response, result) {
            // Check for trial expiration
            if (result && result.code === 'TRIAL_EXPIRED') {
                showTrialExpiredModal(result.trialInfo);
                throw new Error(result.error);
            }
            
            // Check for no input provided
            if (result && result.code === 'NO_INPUT_PROVIDED') {
                showError('ãƒ†ã‚­ã‚¹ãƒˆã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                throw new Error(result.error);
            }
            
            // Handle other API errors
            if (!response.ok) {
                const errorMessage = result?.error || `HTTP ${response.status}: ${response.statusText}`;
                throw new Error(errorMessage);
            }
            
            return result;
        }

        // User Token Stats
        async function loadUserTokenStats() {
            try {
                const response = await fetch('/api/user/token-usage?timeRange=30', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        displayUserTokenStats(result.usage);
                    }
                } else {
                    document.getElementById('userTokenStats').innerHTML = 
                        '<div style="text-align: center; color: var(--color-gray-500);">Tokenä½¿ç”¨é‡ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>';
                }
            } catch (error) {
                console.error('Failed to load user token stats:', error);
                document.getElementById('userTokenStats').innerHTML = 
                    '<div style="text-align: center; color: var(--color-red-600);">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }

        function displayUserTokenStats(usage) {
            const statsDiv = document.getElementById('userTokenStats');
            const avgCost = usage.totalRecords > 0 ? (usage.totalCost / usage.totalRecords).toFixed(4) : '0.0000';
            
            statsDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: var(--space-3); text-align: center;">
                    <div>
                        <div style="font-weight: 600;">${usage.totalRecords.toLocaleString()}</div>
                        <div style="font-size: var(--font-size-xs); opacity: 0.8;">ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ•°</div>
                    </div>
                    <div>
                        <div style="font-weight: 600;">${usage.totalTokens.toLocaleString()}</div>
                        <div style="font-size: var(--font-size-xs); opacity: 0.8;">ç·Tokenæ•°</div>
                    </div>
                    <div>
                        <div style="font-weight: 600;">$${parseFloat(usage.totalCost).toFixed(4)}</div>
                        <div style="font-size: var(--font-size-xs); opacity: 0.8;">æ¨å®šã‚³ã‚¹ãƒˆ</div>
                    </div>
                    <div>
                        <div style="font-weight: 600;">$${avgCost}</div>
                        <div style="font-size: var(--font-size-xs); opacity: 0.8;">å¹³å‡ã‚³ã‚¹ãƒˆ</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: var(--space-2); font-size: var(--font-size-xs); opacity: 0.7;">
                    éå»30æ—¥é–“ã®ä½¿ç”¨é‡
                </div>
            `;
        }

        // Make removeFile globally accessible
        window.removeFile = removeFile;
    </script>
</body>
</html>
