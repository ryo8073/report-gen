<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>クライアント向けレポート生成</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>クライアント向けレポート生成</h1>
            <p>テキスト・画像・PDFからプロフェッショナルなレポートを自動生成</p>
        </header>

        <!-- Main Form -->
        <div class="card">
            <form id="reportForm">
                <!-- Report Type Selection -->
                <div class="form-group">
                    <label for="reportType" class="form-label">
                        レポート種別
                    </label>
                    <select id="reportType" name="reportType" class="input-field" required>
                        <option value="">レポート種別を選択してください</option>
                        <option value="jp_investment_4part">投資分析（4部構成）</option>
                        <option value="jp_tax_strategy">税務戦略（減価償却）</option>
                        <option value="jp_inheritance_strategy">相続対策戦略</option>
                        <option value="comparison_analysis">比較分析</option>
                        <option value="exec_summary">エグゼクティブサマリー</option>
                        <option value="detailed_analysis">詳細分析</option>
                        <option value="action_plan">アクションプラン</option>
                        <option value="risk_brief">リスクブリーフ</option>
                        <option value="custom">カスタムプロンプト</option>
                    </select>
                </div>

                <!-- Custom Prompt (shown when custom is selected) -->
                <div id="customPromptGroup" class="form-group" style="display: none;">
                    <label for="customPrompt" class="form-label">
                        カスタムプロンプト
                    </label>
                    <textarea 
                        id="customPrompt" 
                        name="customPrompt" 
                        rows="4" 
                        class="input-field"
                        placeholder="独自のプロンプトや分析要求を入力してください..."
                    ></textarea>
                    <div style="margin-top: var(--space-2);">
                        <p style="font-size: var(--font-size-xs); color: var(--color-gray-500);">
                            例: "このデータを基に、競合他社との比較分析を行い、優位性を明確にしてください"
                        </p>
                    </div>
                </div>

                <!-- Input Text -->
                <div class="form-group">
                    <label for="inputText" class="form-label">
                        入力テキスト
                    </label>
                    <textarea 
                        id="inputText" 
                        name="inputText" 
                        rows="6" 
                        class="input-field"
                        placeholder="分析したい内容や質問を入力してください..."
                    ></textarea>
                </div>

                <!-- File Upload -->
                <div class="form-group">
                    <label for="fileInput" class="form-label">
                        ファイル添付（PDF・画像）
                    </label>
                    <div class="file-upload" id="fileDropZone">
                        <input type="file" id="fileInput" multiple accept=".pdf,.png,.jpg,.jpeg" class="hidden">
                        <div class="file-upload-content">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <p class="mt-2 text-sm text-gray-600">
                                ファイルをドラッグ&ドロップまたは
                                <span class="text-blue-600 hover:text-blue-500 cursor-pointer" onclick="document.getElementById('fileInput').click()">クリックして選択</span>
                            </p>
                            <p class="text-xs text-gray-500 mt-1">PDF, PNG, JPG (最大4.5MB)</p>
                        </div>
                    </div>
                    <div id="fileList" class="file-list"></div>
                </div>

                <!-- Options -->
                <div class="form-group">
                    <div style="display: flex; gap: var(--space-4); flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label for="language" class="form-label">
                                言語
                            </label>
                            <select id="language" name="language" class="input-field">
                                <option value="ja">日本語</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px; display: flex; align-items: end;">
                            <label style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-4) 0;">
                                <input type="checkbox" id="structured" name="structured" style="width: 18px; height: 18px; accent-color: var(--color-primary);">
                                <span style="font-size: var(--font-size-sm); color: var(--color-gray-700);">構造化出力</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Generate Button -->
                <div style="text-align: center; margin-top: var(--space-8);">
                    <button type="submit" id="generateBtn" class="btn btn-primary">
                        レポート生成
                    </button>
                </div>
            </form>
        </div>

        <!-- Status/Progress -->
        <div id="statusSection" class="hidden status-section">
            <div class="alert-content">
                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 alert-icon"></div>
                <span id="statusText">レポートを生成中...</span>
            </div>
        </div>

        <!-- Results -->
        <div id="resultsSection" class="hidden results-section">
            <div class="results-header">
                <h2 class="results-title">生成されたレポート</h2>
                <div class="results-actions">
                    <button id="copyBtn" class="btn btn-secondary">
                        コピー
                    </button>
                    <button id="downloadBtn" class="btn btn-secondary">
                        .md ダウンロード
                    </button>
                </div>
            </div>
            <div id="preview" class="results-preview prose">
                <!-- Preview content will be inserted here -->
            </div>
        </div>

        <!-- Error Messages -->
        <div id="errorSection" class="hidden error-section">
            <div class="alert-content">
                <svg class="alert-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                </svg>
                <span id="errorText"></span>
            </div>
        </div>
    </div>

    <script type="module">
        // Authentication check
        let currentUser = null;
        
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/me-firebase', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    currentUser = result.user;
                    updateUIForLoggedInUser();
                } else {
                    // Not authenticated, redirect to login
                    window.location.href = '/login.html';
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/login.html';
            }
        }

        function updateUIForLoggedInUser() {
            // Add user info to header
            const header = document.querySelector('.header p');
            header.innerHTML = `こんにちは、${currentUser.name}さん！テキスト・画像・PDFからプロフェッショナルなレポートを自動生成`;
            
            // Add logout button
            const headerElement = document.querySelector('.header');
            const logoutBtn = document.createElement('button');
            logoutBtn.className = 'btn btn-secondary';
            logoutBtn.style.marginTop = 'var(--space-4)';
            logoutBtn.textContent = 'ログアウト';
            logoutBtn.onclick = logout;
            headerElement.appendChild(logoutBtn);
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/login.html';
            } catch (error) {
                console.error('Logout failed:', error);
                window.location.href = '/login.html';
            }
        }

        // Check authentication on page load
        checkAuth();

        // Report type change handler
        document.getElementById('reportType').addEventListener('change', function() {
            const customPromptGroup = document.getElementById('customPromptGroup');
            if (this.value === 'custom') {
                customPromptGroup.style.display = 'block';
                document.getElementById('customPrompt').required = true;
            } else {
                customPromptGroup.style.display = 'none';
                document.getElementById('customPrompt').required = false;
            }
        });

        // File handling
        const fileInput = document.getElementById('fileInput');
        const fileDropZone = document.getElementById('fileDropZone');
        const fileList = document.getElementById('fileList');
        const selectedFiles = [];

        // File drop zone events
        fileDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropZone.classList.add('border-blue-400', 'bg-blue-50');
        });

        fileDropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            fileDropZone.classList.remove('border-blue-400', 'bg-blue-50');
        });

        fileDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropZone.classList.remove('border-blue-400', 'bg-blue-50');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (validateFile(file)) {
                    selectedFiles.push(file);
                    displayFile(file);
                }
            });
        }

        function validateFile(file) {
            const maxSize = 4.5 * 1024 * 1024; // 4.5MB
            const allowedTypes = ['application/pdf', 'image/png', 'image/jpeg', 'image/jpg'];
            
            if (file.size > maxSize) {
                showError(`ファイル "${file.name}" が大きすぎます（最大4.5MB）`);
                return false;
            }
            
            if (!allowedTypes.includes(file.type)) {
                showError(`ファイル "${file.name}" の形式がサポートされていません`);
                return false;
            }
            
            return true;
        }

        function displayFile(file) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <div class="file-info">
                    <svg class="file-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                    </svg>
                    <div class="file-details">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">(${(file.size / 1024 / 1024).toFixed(1)}MB)</div>
                    </div>
                </div>
                <button onclick="removeFile('${file.name}')" class="file-remove">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            `;
            fileList.appendChild(fileItem);
        }

        function removeFile(fileName) {
            const index = selectedFiles.findIndex(f => f.name === fileName);
            if (index > -1) {
                selectedFiles.splice(index, 1);
            }
            // Remove from display
            const fileItems = fileList.querySelectorAll('div');
            fileItems.forEach(item => {
                if (item.textContent.includes(fileName)) {
                    item.remove();
                }
            });
        }

        // Form submission
        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const reportType = formData.get('reportType');
            const inputText = formData.get('inputText');
            const customPrompt = formData.get('customPrompt');
            const language = formData.get('language') || 'ja';
            const structured = formData.get('structured') === 'on';

            // Handle custom prompt
            let finalInputText = inputText;
            if (reportType === 'custom' && customPrompt) {
                finalInputText = customPrompt + '\n\n' + (inputText || '');
            }

            if (!reportType) {
                showError('レポート種別を選択してください');
                return;
            }

            if (!finalInputText.trim() && selectedFiles.length === 0) {
                showError('テキストまたはファイルを入力してください');
                return;
            }

            // Prepare files for upload
            const files = [];
            for (const file of selectedFiles) {
                const base64 = await fileToBase64(file);
                files.push({
                    name: file.name,
                    type: file.type,
                    base64: base64
                });
            }

            const requestData = {
                reportType,
                inputText: finalInputText,
                files,
                options: {
                    language,
                    structured
                }
            };

            try {
                showStatus('レポートを生成中...');
                hideError();
                hideResults();

                const response = await fetch('/api/generate-firebase', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                const result = await response.json();
                displayResults(result);
                hideStatus();

            } catch (error) {
                console.error('Error:', error);
                showError(`エラーが発生しました: ${error.message}`);
                hideStatus();
            }
        });

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        function showStatus(message) {
            document.getElementById('statusText').textContent = message;
            document.getElementById('statusSection').classList.remove('hidden');
        }

        function hideStatus() {
            document.getElementById('statusSection').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorSection').classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorSection').classList.add('hidden');
        }

        function hideResults() {
            document.getElementById('resultsSection').classList.add('hidden');
        }

        function displayResults(result) {
            const preview = document.getElementById('preview');
            preview.innerHTML = result.markdown ? 
                result.markdown.replace(/\n/g, '<br>') : 
                '<p>レポートが生成されましたが、内容を表示できません。</p>';
            
            document.getElementById('resultsSection').classList.remove('hidden');

            // Copy functionality
            document.getElementById('copyBtn').addEventListener('click', () => {
                navigator.clipboard.writeText(result.markdown || '');
                // Show temporary feedback
                const btn = document.getElementById('copyBtn');
                const originalText = btn.textContent;
                btn.textContent = 'コピー済み';
                setTimeout(() => btn.textContent = originalText, 2000);
            });

            // Download functionality
            document.getElementById('downloadBtn').addEventListener('click', () => {
                const blob = new Blob([result.markdown || ''], { type: 'text/markdown; charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `report_${new Date().toISOString().slice(0, 10)}.md`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }

        // Make removeFile globally accessible
        window.removeFile = removeFile;
    </script>
</body>
</html>
