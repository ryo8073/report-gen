<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>クライアント向けレポート生成</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/lib/enhanced-results-layout.css">
    <link rel="stylesheet" href="/lib/print-preview-styles.css">
    <script src="/lib/frontend-error-handler.js"></script>
    <script src="/lib/business-document-formatter.js"></script>
    <script src="/lib/template-selection-system.js"></script>
    <script src="/lib/markdown-renderer.js"></script>
    <script src="/lib/print-preview-manager.js"></script>
    
    <!-- Enhanced Editor Components -->
    <script src="/lib/accessibility-manager.js"></script>
    <script src="/lib/formatting-toolbar.js"></script>
    <script src="/lib/rich-text-editor.js"></script>
    <!-- Import Maps for Tiptap packages (allows bare imports in browser) -->
    <script type="importmap">
    {
        "imports": {
            "@tiptap/core": "/node_modules/@tiptap/core/dist/index.js",
            "@tiptap/starter-kit": "/node_modules/@tiptap/starter-kit/dist/index.js",
            "@tiptap/pm/": "/node_modules/@tiptap/pm/",
            "@tiptap/pm/transform": "/node_modules/@tiptap/pm/transform/dist/index.js",
            "tiptap-markdown": "/node_modules/tiptap-markdown/dist/index.js",
            "@tiptap/extension-table": "/node_modules/@tiptap/extension-table/dist/index.js",
            "@tiptap/extension-table-row": "/node_modules/@tiptap/extension-table-row/dist/index.js",
            "@tiptap/extension-table-cell": "/node_modules/@tiptap/extension-table-cell/dist/index.js",
            "@tiptap/extension-table-header": "/node_modules/@tiptap/extension-table-header/dist/index.js",
            "@tiptap/extension-underline": "/node_modules/@tiptap/extension-underline/dist/index.js",
            "@tiptap/extension-text-align": "/node_modules/@tiptap/extension-text-align/dist/index.js",
            "prosemirror-": "/node_modules/prosemirror-/",
            "prosemirror-state": "/node_modules/prosemirror-state/dist/index.js",
            "prosemirror-model": "/node_modules/prosemirror-model/dist/index.js",
            "prosemirror-transform": "/node_modules/prosemirror-transform/dist/index.js",
            "prosemirror-view": "/node_modules/prosemirror-view/dist/index.js",
            "prosemirror-markdown": "/node_modules/prosemirror-markdown/dist/index.js",
            "markdown-it": "/node_modules/markdown-it/dist/index.js"
        }
    }
    </script>
    <!-- Clean Tiptap WYSIWYG Editor - Zero-based rebuild -->
    <link rel="stylesheet" href="/lib/tiptap-editor-styles.css">
    <script type="module" src="/lib/tiptap-editor-clean.js"></script>
    <!-- Keep old implementations as fallback temporarily -->
    <script src="/lib/tiptap-wysiwyg-editor.js"></script>
    <script src="/lib/enhanced-wysiwyg-editor.js"></script>
    <script src="/lib/tab-navigation.js"></script>
    <script src="/lib/content-state.js"></script>
    <script src="/lib/enhanced-results-layout.js"></script>
    <link rel="stylesheet" href="/lib/accessibility-styles.css">
    <link rel="stylesheet" href="/lib/enhanced-wysiwyg-editor.css">
    <link rel="stylesheet" href="/lib/tiptap-wysiwyg-editor.css">
    <!-- Advanced PDF Export Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="/lib/pdf-export-manager.js"></script>
    
    <!-- Word Export Dependencies -->
    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
    <script src="/lib/word-export-manager-browser.js"></script>
    <script src="/lib/header-footer-manager.js"></script>
    <link rel="stylesheet" href="/lib/template-styles.css">
    
    <!-- Performance Optimization Dependencies -->
    <script src="/lib/performance-optimization-manager.js"></script>
    <script src="/lib/optimized-pdf-export-manager.js"></script>
    <script src="/lib/optimized-word-export-manager.js"></script>
    <script src="/lib/performance-monitor-dashboard.js"></script>
    
    <!-- Prompt Template Manager - Critical for ensuring reports reflect latest prompts -->
    <script src="/lib/prompt-template-manager.js"></script>
    
    <!-- Simple Report Renderer - Fallback for reliable report display -->
    <script src="/lib/simple-report-renderer.js"></script>

    <script>
        // SUPPRESS SUPABASE AUTH ERRORS EARLY - BEFORE ANY OTHER SCRIPTS
        (function() {
            // Intercept and suppress Supabase-related errors before they appear
            const originalConsoleError = console.error;
            console.error = function(...args) {
                const message = args.join(' ');
                if (message.includes('supabase') || 
                    message.includes('Failed to get session') ||
                    message.includes('refresh_token') ||
                    message.includes('auth/v1/token')) {
                    // Suppress these errors silently
                    return;
                }
                originalConsoleError.apply(console, args);
            };
            
            // Suppress fetch errors for Supabase
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                const url = args[0];
                if (typeof url === 'string' && url.includes('supabase.co/auth')) {
                    // Return a resolved promise with empty response instead of making the request
                    return Promise.resolve(new Response(JSON.stringify({}), {
                        status: 200,
                        headers: { 'Content-Type': 'application/json' }
                    }));
                }
                return originalFetch.apply(this, args);
            };
            
            // Disable Supabase client if it exists
            if (typeof window.supabase !== 'undefined') {
                try {
                    if (window.supabase.auth) {
                        window.supabase.auth.getSession = () => Promise.resolve({ data: { session: null }, error: null });
                        window.supabase.auth.refreshSession = () => Promise.resolve({ data: { session: null }, error: null });
                        window.supabase.auth.getUser = () => Promise.resolve({ data: { user: null }, error: null });
                    }
                } catch (e) {}
            }
        })();
        
        // Ensure errorHandler is available
        if (typeof window.errorHandler === 'undefined') {
            console.warn('ErrorHandler not loaded, creating fallback');
            window.errorHandler = {
                handleError: (error, context, showNotification = true) => {
                    console.error(`Error in ${context}:`, error);
                    if (showNotification) {
                        alert(`エラーが発生しました: ${error.message || error}`);
                    }
                },
                handleApiResponse: async (response, context) => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response;
                },
                showLoading: (button, text) => {
                    if (button) {
                        button.disabled = true;
                        button.dataset.originalText = button.textContent;
                        button.textContent = text || 'Loading...';
                    }
                },
                hideLoading: (button) => {
                    if (button) {
                        button.disabled = false;
                        button.textContent = button.dataset.originalText || button.textContent;
                    }
                },
                showNotification: (message, type, duration) => {
                    console.log(`${type.toUpperCase()}: ${message}`);
                    // Simple fallback notification
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        padding: 12px 20px;
                        background: ${type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : '#ef4444'};
                        color: white;
                        border-radius: 6px;
                        z-index: 10000;
                        font-size: 14px;
                    `;
                    notification.textContent = message;
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), duration || 3000);
                },
                getUserFriendlyMessage: (error, context) => {
                    return error.message || 'エラーが発生しました';
                }
            };
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>クライアント向けレポート生成</h1>
            <p>テキスト・画像・PDFからプロフェッショナルなレポートを自動生成</p>
            
            <!-- Navigation Links -->
            <div style="margin-top: var(--space-6); display: flex; gap: var(--space-3); justify-content: center; flex-wrap: wrap;">
                <a href="/investment-analysis.html" class="btn btn-primary" style="text-decoration: none;">
                    📊 投資分析レポート（専用フォーム）
                </a>
            </div>
        </header>

        <!-- Main Form -->
        <div class="card">
            <form id="reportForm">
                <!-- Report Type Selection -->
                <div class="form-group">
                    <label for="reportType" class="form-label">
                        レポート種別
                    </label>
                    <select id="reportType" name="reportType" class="input-field" required>
                        <option value="">レポート種別を選択してください</option>
                        <option value="jp_investment_4part">投資分析レポート（4部構成）</option>
                        <option value="jp_tax_strategy">税務戦略レポート（減価償却活用）</option>
                        <option value="jp_inheritance_strategy">相続対策戦略レポート</option>
                        <option value="comparison_analysis">比較分析レポート</option>
                        <option value="custom">カスタムレポート</option>
                    </select>
                </div>

                <!-- Custom Prompt (shown when custom is selected) -->
                <div id="customPromptGroup" class="form-group" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2);">
                        <label for="customPrompt" class="form-label">
                            カスタムプロンプト
                        </label>
                        <div style="display: flex; gap: var(--space-2);">
                            <button type="button" id="loadPromptBtn" class="btn btn-secondary" style="font-size: var(--font-size-sm); padding: var(--space-1) var(--space-3);">
                                保存済み読込
                            </button>
                            <button type="button" id="savePromptBtn" class="btn btn-secondary" style="font-size: var(--font-size-sm); padding: var(--space-1) var(--space-3);">
                                プロンプト保存
                            </button>
                        </div>
                    </div>
                    
                    <textarea 
                        id="customPrompt" 
                        name="customPrompt" 
                        rows="4" 
                        class="input-field"
                        placeholder="独自のプロンプトや分析要求を入力してください..."
                    ></textarea>
                    
                    <div style="margin-top: var(--space-2);">
                        <p style="font-size: var(--font-size-xs); color: var(--color-gray-500);">
                            例: "このデータを基に、競合他社との比較分析を行い、優位性を明確にしてください"
                        </p>
                    </div>
                </div>

                <!-- Tax Strategy Additional Info (shown when jp_tax_strategy is selected) -->
                <div id="taxStrategyGroup" class="form-group" style="display: none;">
                    <h3 style="font-size: var(--font-size-lg); font-weight: 600; margin-bottom: var(--space-4); color: var(--color-gray-800);">
                        税務戦略に必要な情報
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-4);">
                        <div>
                            <label for="annualIncome" class="form-label">年収（万円）</label>
                            <input type="number" id="annualIncome" name="annualIncome" class="input-field" placeholder="1000" min="0">
                        </div>
                        <div>
                            <label for="currentTaxRate" class="form-label">現在の所得税率（%）</label>
                            <select id="currentTaxRate" name="currentTaxRate" class="input-field">
                                <option value="">選択してください</option>
                                <option value="20">20%（年収330万円〜695万円）</option>
                                <option value="23">23%（年収695万円〜900万円）</option>
                                <option value="33">33%（年収900万円〜1800万円）</option>
                                <option value="40">40%（年収1800万円〜4000万円）</option>
                                <option value="45">45%（年収4000万円超）</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-4);">
                        <div>
                            <label for="familyMembers" class="form-label">扶養家族数</label>
                            <input type="number" id="familyMembers" name="familyMembers" class="input-field" placeholder="2" min="0">
                        </div>
                        <div>
                            <label for="otherDeductions" class="form-label">その他所得控除（万円）</label>
                            <input type="number" id="otherDeductions" name="otherDeductions" class="input-field" placeholder="200" min="0">
                        </div>
                    </div>
                    
                    <div>
                        <label for="investmentGoal" class="form-label">投資目標・期間</label>
                        <textarea id="investmentGoal" name="investmentGoal" rows="2" class="input-field" placeholder="例：5年間で年間100万円の節税効果を目指す"></textarea>
                    </div>
                </div>

                <!-- Inheritance Strategy Additional Info (shown when jp_inheritance_strategy is selected) -->
                <div id="inheritanceStrategyGroup" class="form-group" style="display: none;">
                    <h3 style="font-size: var(--font-size-lg); font-weight: 600; margin-bottom: var(--space-4); color: var(--color-gray-800);">
                        相続対策に必要な情報
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-4);">
                        <div>
                            <label for="totalAssets" class="form-label">総資産額（万円）</label>
                            <input type="number" id="totalAssets" name="totalAssets" class="input-field" placeholder="10000" min="0">
                        </div>
                        <div>
                            <label for="liquidAssets" class="form-label">現金・預金（万円）</label>
                            <input type="number" id="liquidAssets" name="liquidAssets" class="input-field" placeholder="3000" min="0">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-4);">
                        <div>
                            <label for="realEstateAssets" class="form-label">既存不動産（万円）</label>
                            <input type="number" id="realEstateAssets" name="realEstateAssets" class="input-field" placeholder="5000" min="0">
                        </div>
                        <div>
                            <label for="otherAssets" class="form-label">その他資産（万円）</label>
                            <input type="number" id="otherAssets" name="otherAssets" class="input-field" placeholder="2000" min="0">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: var(--space-4);">
                        <label class="form-label">法定相続人の構成</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--space-4);">
                            <div>
                                <label for="spouse" class="form-label" style="font-size: var(--font-size-sm);">配偶者</label>
                                <select id="spouse" name="spouse" class="input-field">
                                    <option value="0">なし</option>
                                    <option value="1">あり</option>
                                </select>
                            </div>
                            <div>
                                <label for="children" class="form-label" style="font-size: var(--font-size-sm);">子供の人数</label>
                                <input type="number" id="children" name="children" class="input-field" placeholder="2" min="0" max="10">
                            </div>
                            <div>
                                <label for="parents" class="form-label" style="font-size: var(--font-size-sm);">両親</label>
                                <select id="parents" name="parents" class="input-field">
                                    <option value="0">なし</option>
                                    <option value="1">片親</option>
                                    <option value="2">両親</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label for="inheritanceGoal" class="form-label">相続対策の目標</label>
                        <textarea id="inheritanceGoal" name="inheritanceGoal" rows="2" class="input-field" placeholder="例：相続税を50%削減し、円滑な資産承継を実現したい"></textarea>
                    </div>
                </div>

                <!-- Comparison Analysis Section (shown when comparison_analysis is selected) -->
                <div id="comparisonSection" class="form-group" style="display: none;">
                    <h3 style="font-size: var(--font-size-lg); font-weight: 600; margin-bottom: var(--space-4); color: var(--color-gray-800);">
                        比較分析設定
                    </h3>
                    
                    <div class="comparison-uploads" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-6); margin-bottom: var(--space-6);">
                        <div class="property-upload">
                            <h4 style="font-size: var(--font-size-md); font-weight: 600; margin-bottom: var(--space-3); color: var(--color-gray-700);">物件A</h4>
                            
                            <div style="margin-bottom: var(--space-3);">
                                <label for="propertyAFiles" class="form-label" style="font-size: var(--font-size-sm);">📎 ファイル添付</label>
                                <input type="file" id="propertyAFiles" multiple accept=".pdf,.png,.jpg,.jpeg,.gif,.webp,.xlsx,.xls,.csv,.txt,.docx,.doc" class="input-field" style="padding: var(--space-2);">
                                <p style="font-size: 11px; color: #6b7280; margin-top: 4px;">PDF・画像・Excel・CSV・Word・テキスト (最大4.5MB)</p>
                            </div>
                            
                            <div>
                                <label for="propertyAText" class="form-label" style="font-size: var(--font-size-sm);">物件情報</label>
                                <textarea id="propertyAText" rows="4" class="input-field" placeholder="物件Aの詳細情報を入力してください..."></textarea>
                            </div>
                        </div>
                        
                        <div class="property-upload">
                            <h4 style="font-size: var(--font-size-md); font-weight: 600; margin-bottom: var(--space-3); color: var(--color-gray-700);">物件B</h4>
                            
                            <div style="margin-bottom: var(--space-3);">
                                <label for="propertyBFiles" class="form-label" style="font-size: var(--font-size-sm);">📎 ファイル添付</label>
                                <input type="file" id="propertyBFiles" multiple accept=".pdf,.png,.jpg,.jpeg,.gif,.webp,.xlsx,.xls,.csv,.txt,.docx,.doc" class="input-field" style="padding: var(--space-2);">
                                <p style="font-size: 11px; color: #6b7280; margin-top: 4px;">PDF・画像・Excel・CSV・Word・テキスト (最大4.5MB)</p>
                            </div>
                            
                            <div>
                                <label for="propertyBText" class="form-label" style="font-size: var(--font-size-sm);">物件情報</label>
                                <textarea id="propertyBText" rows="4" class="input-field" placeholder="物件Bの詳細情報を入力してください..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="comparison-criteria" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
                        <div>
                            <label for="comparisonCriteria" class="form-label">比較項目</label>
                            <textarea id="comparisonCriteria" rows="3" class="input-field" placeholder="比較したい項目を指定してください（例：収益性、立地、リスク等）..."></textarea>
                        </div>
                        
                        <div>
                            <label for="resultFormat" class="form-label">結果表示形式</label>
                            <textarea id="resultFormat" rows="3" class="input-field" placeholder="結果をどのように表示したいかを指定してください（例：表形式、グラフ、推奨順位等）..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Input Text -->
                <div class="form-group">
                    <label for="inputText" class="form-label">
                        入力テキスト
                    </label>
                    <textarea 
                        id="inputText" 
                        name="inputText" 
                        rows="6" 
                        class="input-field"
                        placeholder="分析したい内容や質問を入力してください..."
                    ></textarea>
                </div>

                <!-- File Upload -->
                <div class="form-group">
                    <label for="fileInput" class="form-label">
                        📎 ファイル添付
                    </label>
                    <div class="file-upload" id="fileDropZone">
                        <input type="file" id="fileInput" multiple accept=".pdf,.png,.jpg,.jpeg,.gif,.webp,.xlsx,.xls,.csv,.txt,.docx,.doc" class="hidden">
                        <div class="file-upload-content">
                            <div style="display: flex; justify-content: center; margin-bottom: 12px;">
                                <div style="display: flex; gap: 8px; font-size: 24px;">
                                    📄 🖼️ 📊 📝
                                </div>
                            </div>
                            <p style="margin: 8px 0; font-size: 14px; color: #374151; font-weight: 500;">
                                ファイルをドラッグ&ドロップまたは
                                <span style="color: #2563eb; cursor: pointer; text-decoration: underline;" onclick="document.getElementById('fileInput').click()">クリックして選択</span>
                            </p>
                            <div style="margin-top: 12px; padding: 8px; background: #f3f4f6; border-radius: 6px;">
                                <p style="font-size: 12px; color: #6b7280; margin: 0; line-height: 1.4;">
                                    <strong>対応ファイル:</strong><br>
                                    📄 PDF・Word・テキスト<br>
                                    🖼️ PNG・JPG・GIF・WebP<br>
                                    📊 Excel・CSV<br>
                                    <span style="color: #ef4444;">最大4.5MB</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div id="fileList" class="file-list"></div>
                </div>

                <!-- Options -->
                <div class="form-group">
                    <div style="display: flex; gap: var(--space-4); flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label for="language" class="form-label">
                                言語
                            </label>
                            <select id="language" name="language" class="input-field">
                                <option value="ja">日本語</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Generate Button -->
                <div style="text-align: center; margin-top: var(--space-8);">
                    <button type="submit" id="generateBtn" class="btn btn-primary">
                        レポート生成
                    </button>
                </div>
            </form>
        </div>

        <!-- Enhanced Status/Progress -->
        <div id="statusSection" class="hidden status-section">
            <div class="progress-container">
                <!-- Progress Header -->
                <div class="progress-header">
                    <div class="progress-title">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 progress-spinner"></div>
                        <span id="statusText">レポートを生成中...</span>
                    </div>
                    <div class="progress-time">
                        <span id="progressTime">00:00</span>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="progress-bar-container">
                    <div class="progress-bar">
                        <div id="progressBarFill" class="progress-bar-fill"></div>
                    </div>
                    <div class="progress-percentage">
                        <span id="progressPercentage">0%</span>
                    </div>
                </div>
                
                <!-- Progress Steps -->
                <div class="progress-steps">
                    <div id="step1" class="progress-step active">
                        <div class="step-icon">
                            <div class="step-number">1</div>
                            <div class="step-spinner hidden animate-spin">⟳</div>
                            <div class="step-check hidden">✓</div>
                        </div>
                        <div class="step-content">
                            <div class="step-title">リクエスト準備</div>
                            <div class="step-description">入力データを処理中...</div>
                        </div>
                    </div>
                    
                    <div id="step2" class="progress-step">
                        <div class="step-icon">
                            <div class="step-number">2</div>
                            <div class="step-spinner hidden animate-spin">⟳</div>
                            <div class="step-check hidden">✓</div>
                        </div>
                        <div class="step-content">
                            <div class="step-title">ファイル処理</div>
                            <div class="step-description">アップロードされたファイルを解析中...</div>
                        </div>
                    </div>
                    
                    <div id="step3" class="progress-step">
                        <div class="step-icon">
                            <div class="step-number">3</div>
                            <div class="step-spinner hidden animate-spin">⟳</div>
                            <div class="step-check hidden">✓</div>
                        </div>
                        <div class="step-content">
                            <div class="step-title">AI分析</div>
                            <div class="step-description">AIモデルがレポートを生成中...</div>
                        </div>
                    </div>
                    
                    <div id="step4" class="progress-step">
                        <div class="step-icon">
                            <div class="step-number">4</div>
                            <div class="step-spinner hidden animate-spin">⟳</div>
                            <div class="step-check hidden">✓</div>
                        </div>
                        <div class="step-content">
                            <div class="step-title">最終調整</div>
                            <div class="step-description">レポートを整形中...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Details -->
                <div class="progress-details">
                    <div class="detail-item">
                        <span class="detail-label">処理時間:</span>
                        <span id="processingTime" class="detail-value">計算中...</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">推定残り時間:</span>
                        <span id="estimatedTime" class="detail-value">計算中...</span>
                    </div>
                </div>
                
                <!-- Cancel Button -->
                <div class="progress-actions">
                    <button id="cancelProgress" class="btn btn-secondary progress-cancel-btn">
                        キャンセル
                    </button>
                </div>
            </div>
        </div>

        <!-- Enhanced Results Section -->
        <div id="resultsSection" class="hidden results-section">
            <!-- Enhanced Results Layout Container -->
            <div id="enhancedResultsContainer" class="enhanced-results-container">
                <!-- This will be populated by the EnhancedResultsLayout component -->
            </div>
            
            <!-- Legacy preview for backward compatibility -->
            <div id="preview" class="results-preview prose hidden">
                <!-- Preview content will be inserted here -->
            </div>
        </div>

        <!-- Error Messages -->
        <div id="errorSection" class="hidden error-section">
            <div class="alert-content">
                <svg class="alert-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                </svg>
                <span id="errorText"></span>
            </div>
        </div>
    </div>

    <!-- Custom Prompt Save Modal -->
    <div id="savePromptModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>カスタムプロンプトを保存</h3>
                <button type="button" class="modal-close" onclick="closeSavePromptModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="savePromptForm">
                    <div class="form-group">
                        <label for="promptTitle" class="form-label">タイトル</label>
                        <input type="text" id="promptTitle" name="promptTitle" class="input-field" placeholder="プロンプトのタイトル" required maxlength="100">
                    </div>
                    <div class="form-group">
                        <label for="promptDescription" class="form-label">説明（任意）</label>
                        <textarea id="promptDescription" name="promptDescription" rows="2" class="input-field" placeholder="このプロンプトの用途や特徴"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="promptTags" class="form-label">タグ（任意）</label>
                        <input type="text" id="promptTags" name="promptTags" class="input-field" placeholder="タグをカンマ区切りで入力（例：分析,比較,投資）">
                    </div>
                    <div class="form-group">
                        <label class="form-label">プロンプト内容</label>
                        <textarea id="promptPreview" rows="4" class="input-field" readonly style="background-color: var(--color-gray-100);"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeSavePromptModal()">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="saveCustomPrompt()">保存</button>
            </div>
        </div>
    </div>

    <!-- Custom Prompt Load Modal -->
    <div id="loadPromptModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>保存済みプロンプトを読込</h3>
                <button type="button" class="modal-close" onclick="closeLoadPromptModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="promptsList">
                    <div class="loading-message">読み込み中...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeLoadPromptModal()">閉じる</button>
            </div>
        </div>
    </div>

    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-6);
            border-bottom: 1px solid var(--color-gray-200);
        }

        .modal-header h3 {
            margin: 0;
            font-size: var(--font-size-lg);
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--color-gray-500);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: var(--color-gray-700);
        }

        .modal-body {
            padding: var(--space-6);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-3);
            padding: var(--space-6);
            border-top: 1px solid var(--color-gray-200);
        }

        .prompt-item {
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            padding: var(--space-4);
            margin-bottom: var(--space-3);
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .prompt-item:hover {
            border-color: var(--color-primary);
        }

        .prompt-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-2);
        }

        .prompt-item-title {
            font-weight: 600;
            color: var(--color-gray-800);
        }

        .prompt-item-date {
            font-size: var(--font-size-xs);
            color: var(--color-gray-500);
        }

        .prompt-item-description {
            color: var(--color-gray-600);
            font-size: var(--font-size-sm);
            margin-bottom: var(--space-2);
        }

        .prompt-item-tags {
            display: flex;
            gap: var(--space-1);
            flex-wrap: wrap;
        }

        .prompt-tag {
            background-color: var(--color-gray-100);
            color: var(--color-gray-700);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: var(--font-size-xs);
        }

        .prompt-item-actions {
            display: flex;
            gap: var(--space-2);
            margin-top: var(--space-2);
        }

        .prompt-action-btn {
            background: none;
            border: 1px solid var(--color-gray-300);
            padding: var(--space-1) var(--space-2);
            border-radius: 4px;
            font-size: var(--font-size-xs);
            cursor: pointer;
            transition: all 0.2s;
        }

        .prompt-action-btn:hover {
            background-color: var(--color-gray-50);
        }

        .prompt-action-btn.delete {
            color: var(--color-red-600);
            border-color: var(--color-red-300);
        }

        .prompt-action-btn.delete:hover {
            background-color: var(--color-red-50);
        }

        .loading-message {
            text-align: center;
            padding: var(--space-8);
            color: var(--color-gray-500);
        }

        /* File Preview Styles */
        .file-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .file-preview-btn {
            background: var(--color-blue-50);
            color: var(--color-blue-600);
            border: 1px solid var(--color-blue-200);
            border-radius: 6px;
            padding: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-preview-btn:hover {
            background: var(--color-blue-100);
            color: var(--color-blue-700);
        }

        .file-type-badge {
            font-size: 11px;
            color: var(--color-green-600);
            background: var(--color-green-50);
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 2px;
        }

        .pdf-icon {
            color: var(--color-red-600);
        }

        /* Preview Modal Content Styles */
        .image-preview-container {
            text-align: center;
        }

        .preview-image {
            max-width: 100%;
            max-height: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .image-info, .pdf-info {
            text-align: left;
            background: var(--color-gray-50);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .pdf-preview-container {
            text-align: center;
            padding: 40px 20px;
        }

        .pdf-icon-large {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        .pdf-icon-large svg {
            color: var(--color-red-600);
        }

        .pdf-label {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: bold;
            color: white;
        }

        .ai-analysis-note {
            background: var(--color-blue-50);
            border: 1px solid var(--color-blue-200);
            border-radius: 6px;
            padding: 12px;
            margin-top: 16px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 14px;
            color: var(--color-blue-800);
        }

        .ai-analysis-note svg {
            color: var(--color-blue-600);
            flex-shrink: 0;
            margin-top: 2px;
        }

        .pdf-capabilities {
            margin-top: 20px;
        }

        .pdf-capabilities h4 {
            margin-bottom: 12px;
            color: var(--color-gray-800);
            font-size: 16px;
        }

        .pdf-capabilities ul {
            list-style: none;
            padding: 0;
        }

        .pdf-capabilities li {
            padding: 6px 0;
            color: var(--color-gray-700);
            font-size: 14px;
        }

        /* Format Tools Styles */
        .format-tools-bar {
            background: var(--color-gray-50);
            border: 1px solid var(--color-gray-200);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
        }

        .format-tools-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .format-tools-section label {
            font-size: 14px;
            font-weight: 500;
            color: var(--color-gray-700);
            white-space: nowrap;
        }

        .format-tools-section select {
            padding: 4px 8px;
            border: 1px solid var(--color-gray-300);
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        .format-btn {
            padding: 6px 10px;
            border: 1px solid var(--color-gray-300);
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .format-btn:hover {
            background: var(--color-gray-100);
            border-color: var(--color-gray-400);
        }

        /* Rich Text Editor Styles */
        .report-editor {
            min-height: 400px;
            padding: 20px;
            border: 1px solid var(--color-gray-300);
            border-radius: 8px;
            background: white;
            font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
            font-size: 14px;
            line-height: 1.8;
            color: var(--color-gray-800);
            outline: none;
            overflow-y: auto;
        }

        .report-editor:focus {
            border-color: var(--color-blue-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .report-editor[placeholder]:empty:before {
            content: attr(placeholder);
            color: var(--color-gray-400);
            font-style: italic;
        }

        /* Theme Styles */
        .report-editor.theme-dark {
            background: #1a1a1a;
            color: #e0e0e0;
            border-color: #404040;
        }

        .report-editor.theme-sepia {
            background: #f4f1e8;
            color: #5c4b37;
            border-color: #d4c5a9;
        }

        .report-editor.theme-high-contrast {
            background: #000000;
            color: #ffffff;
            border-color: #ffffff;
        }

        /* Rich Text Formatting */
        .report-editor h1 {
            font-size: 24px;
            font-weight: bold;
            margin: 24px 0 16px 0;
            color: var(--color-gray-900);
            border-bottom: 2px solid var(--color-gray-200);
            padding-bottom: 8px;
        }

        .report-editor h2 {
            font-size: 20px;
            font-weight: bold;
            margin: 20px 0 12px 0;
            color: var(--color-gray-800);
        }

        .report-editor h3 {
            font-size: 18px;
            font-weight: bold;
            margin: 16px 0 8px 0;
            color: var(--color-gray-800);
        }

        .report-editor p {
            margin: 12px 0;
        }

        .report-editor ul, .report-editor ol {
            margin: 12px 0;
            padding-left: 24px;
        }

        .report-editor li {
            margin: 4px 0;
        }

        .report-editor strong {
            font-weight: bold;
            color: var(--color-gray-900);
        }

        .report-editor em {
            font-style: italic;
        }

        .report-editor .highlight {
            background-color: #ffeb3b;
            padding: 2px 4px;
            border-radius: 2px;
        }

        /* Export Button Styles */
        #exportGoogleDocsBtn {
            background: #4285f4;
            color: white;
            border: none;
        }

        #exportGoogleDocsBtn:hover {
            background: #3367d6;
        }
    </style>

    <!-- Trial Expired Modal -->
    <div id="trialExpiredModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="color: #dc2626;">試用期間が終了しました</h3>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: var(--space-4);">
                    <svg width="64" height="64" fill="#dc2626" viewBox="0 0 20 20" style="margin-bottom: var(--space-4);">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                    <p style="font-size: var(--font-size-lg); margin-bottom: var(--space-4);">
                        2週間の試用期間または15回の利用制限に達しました。
                    </p>
                    <p style="color: var(--color-gray-600); margin-bottom: var(--space-6);">
                        引き続きサービスをご利用いただくには、有料プランにアップグレードしてください。
                    </p>
                    <div style="display: flex; gap: var(--space-3); justify-content: center;">
                        <button onclick="showUpgradeModal()" class="btn btn-primary">
                            有料プランを見る
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upgrade Modal -->
    <div id="upgradeModal" class="modal hidden">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>有料プランにアップグレード</h3>
                <button type="button" class="modal-close" onclick="closeUpgradeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: var(--space-6);">
                    <p style="font-size: var(--font-size-lg); color: var(--color-gray-700);">
                        プロフェッショナルなレポート生成を無制限でご利用いただけます
                    </p>
                </div>

                <!-- Pricing Plans -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-6);">
                    <!-- Basic Plan -->
                    <div class="pricing-card">
                        <div class="pricing-header">
                            <h4>ベーシック</h4>
                            <div class="pricing-price">¥2,980<span>/月</span></div>
                        </div>
                        <div class="pricing-features">
                            <div class="pricing-feature">✓ 月50回まで生成</div>
                            <div class="pricing-feature">✓ 全レポート種別対応</div>
                            <div class="pricing-feature">✓ ファイルアップロード</div>
                            <div class="pricing-feature">✓ カスタムプロンプト保存</div>
                            <div class="pricing-feature">✓ メールサポート</div>
                        </div>
                        <button class="btn btn-primary pricing-btn" onclick="selectPlan('basic')">
                            ベーシックを選択
                        </button>
                    </div>

                    <!-- Pro Plan -->
                    <div class="pricing-card featured">
                        <div class="pricing-badge">おすすめ</div>
                        <div class="pricing-header">
                            <h4>プロ</h4>
                            <div class="pricing-price">¥4,980<span>/月</span></div>
                        </div>
                        <div class="pricing-features">
                            <div class="pricing-feature">✓ 無制限生成</div>
                            <div class="pricing-feature">✓ 全レポート種別対応</div>
                            <div class="pricing-feature">✓ ファイルアップロード</div>
                            <div class="pricing-feature">✓ カスタムプロンプト保存</div>
                            <div class="pricing-feature">✓ 優先サポート</div>
                            <div class="pricing-feature">✓ API アクセス</div>
                        </div>
                        <button class="btn btn-primary pricing-btn" onclick="selectPlan('pro')">
                            プロを選択
                        </button>
                    </div>

                    <!-- Enterprise Plan -->
                    <div class="pricing-card">
                        <div class="pricing-header">
                            <h4>エンタープライズ</h4>
                            <div class="pricing-price">お問い合わせ</div>
                        </div>
                        <div class="pricing-features">
                            <div class="pricing-feature">✓ 無制限生成</div>
                            <div class="pricing-feature">✓ カスタムテンプレート</div>
                            <div class="pricing-feature">✓ 専用サポート</div>
                            <div class="pricing-feature">✓ オンプレミス対応</div>
                            <div class="pricing-feature">✓ SLA保証</div>
                        </div>
                        <button class="btn btn-secondary pricing-btn" onclick="contactSales()">
                            お問い合わせ
                        </button>
                    </div>
                </div>

                <div style="text-align: center; margin-top: var(--space-6); padding-top: var(--space-6); border-top: 1px solid var(--color-gray-200);">
                    <p style="color: var(--color-gray-600); font-size: var(--font-size-sm);">
                        すべてのプランで14日間の返金保証付き
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- File Preview Modal -->
    <div id="filePreviewModal" class="modal hidden">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="previewModalTitle">ファイルプレビュー</h3>
                <button onclick="closePreviewModal()" class="modal-close">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="previewModalContent" class="modal-body">
                <!-- Content will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <style>
        .pricing-card {
            border: 2px solid var(--color-gray-200);
            border-radius: 12px;
            padding: var(--space-6);
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
        }

        .pricing-card:hover {
            border-color: var(--color-primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .pricing-card.featured {
            border-color: var(--color-primary);
            background: linear-gradient(135deg, #fef7ff, #f3e8ff);
        }

        .pricing-badge {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-primary);
            color: white;
            padding: var(--space-1) var(--space-3);
            border-radius: 20px;
            font-size: var(--font-size-xs);
            font-weight: 600;
        }

        .pricing-header h4 {
            font-size: var(--font-size-xl);
            font-weight: 700;
            margin-bottom: var(--space-2);
            color: var(--color-gray-900);
        }

        .pricing-price {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: var(--space-4);
        }

        .pricing-price span {
            font-size: var(--font-size-sm);
            font-weight: 400;
            color: var(--color-gray-600);
        }

        .pricing-features {
            text-align: left;
            margin-bottom: var(--space-6);
        }

        .pricing-feature {
            padding: var(--space-2) 0;
            color: var(--color-gray-700);
            font-size: var(--font-size-sm);
        }

        .pricing-btn {
            width: 100%;
        }

        /* Enhanced Report Display Styles */
        .report-display-container {
            border: 1px solid var(--color-gray-200);
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .report-tabs {
            display: flex;
            border-bottom: 1px solid var(--color-gray-200);
            background: var(--color-gray-50);
        }

        .tab-button {
            flex: 1;
            padding: var(--space-3) var(--space-4);
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--color-gray-600);
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .tab-button:hover {
            background: var(--color-gray-100);
            color: var(--color-gray-800);
        }

        .tab-button.active {
            background: white;
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .word-count-display {
            padding: var(--space-2) var(--space-4);
            background: var(--color-gray-50);
            border-bottom: 1px solid var(--color-gray-200);
            font-size: var(--font-size-xs);
        }

        .word-count-stats {
            display: flex;
            gap: var(--space-4);
            color: var(--color-gray-600);
        }

        .report-view {
            display: none;
            min-height: 400px;
        }

        .report-view.active {
            display: block;
        }

        .report-textarea {
            width: 100%;
            min-height: 400px;
            padding: var(--space-4);
            border: none;
            resize: vertical;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: var(--font-size-sm);
            line-height: 1.6;
            background: white;
            outline: none;
        }

        /* Basic Results Display Styles */
        .basic-results-display {
            border: 1px solid var(--color-gray-200);
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .results-header {
            background: var(--color-gray-50);
            padding: var(--space-4);
            border-bottom: 1px solid var(--color-gray-200);
        }

        .results-header h3 {
            margin: 0;
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--color-gray-800);
        }

        .results-content {
            padding: 0;
        }

        .results-content .report-textarea {
            border: none;
            border-radius: 0;
            font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
            font-size: 14px;
            line-height: 1.8;
            color: var(--color-gray-800);
        }

        .results-actions {
            background: var(--color-gray-50);
            padding: var(--space-4);
            border-top: 1px solid var(--color-gray-200);
            display: flex;
            gap: var(--space-3);
            justify-content: flex-end;
        }

        .enhanced-results-container {
            margin-top: var(--space-6);
        }

        /* Enhanced Basic Results Display */
        .results-info {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .info-badge {
            background: var(--color-blue-100);
            color: var(--color-blue-800);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: var(--font-size-xs);
            font-weight: 500;
        }

        .content-tabs {
            display: flex;
            border-bottom: 1px solid var(--color-gray-200);
            background: var(--color-gray-50);
        }

        .content-tab {
            flex: 1;
            padding: var(--space-3) var(--space-4);
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--color-gray-600);
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .content-tab:hover {
            background: var(--color-gray-100);
            color: var(--color-gray-800);
        }

        .content-tab.active {
            background: white;
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-content {
            position: relative;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .formatted-content {
            padding: var(--space-4);
            min-height: 400px;
            background: white;
            overflow-y: auto;
            font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
            line-height: 1.8;
        }

        .formatted-content h1 {
            font-size: 24px;
            font-weight: bold;
            margin: 24px 0 16px 0;
            color: var(--color-gray-900);
            border-bottom: 2px solid var(--color-gray-200);
            padding-bottom: 8px;
        }

        .formatted-content h2 {
            font-size: 20px;
            font-weight: bold;
            margin: 20px 0 12px 0;
            color: var(--color-gray-800);
        }

        .formatted-content h3 {
            font-size: 18px;
            font-weight: bold;
            margin: 16px 0 8px 0;
            color: var(--color-gray-800);
        }

        .formatted-content p {
            margin: 12px 0;
            color: var(--color-gray-700);
        }

        .formatted-content ul, .formatted-content ol {
            margin: 12px 0;
            padding-left: 24px;
        }

        .formatted-content li {
            margin: 4px 0;
            color: var(--color-gray-700);
        }

        .formatted-content strong {
            font-weight: bold;
            color: var(--color-gray-900);
        }

        .formatted-content em {
            font-style: italic;
        }

        .simple-results-display {
            padding: var(--space-4);
        }

        .simple-results-display h3 {
            margin: 0 0 var(--space-4) 0;
            color: var(--color-gray-800);
        }

        .report-preview {
            padding: var(--space-4);
            min-height: 400px;
            background: white;
            overflow-y: auto;
        }

        .split-view {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 0;
        }

        .split-view.active {
            display: grid;
        }

        .split-panel {
            border-right: 1px solid var(--color-gray-200);
        }

        .split-panel:last-child {
            border-right: none;
        }

        .split-panel-title {
            padding: var(--space-2) var(--space-4);
            margin: 0;
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--color-gray-700);
            background: var(--color-gray-50);
            border-bottom: 1px solid var(--color-gray-200);
        }

        .split-textarea {
            min-height: 360px;
        }

        .split-preview {
            min-height: 360px;
        }

        /* Markdown Styling */
        .markdown-h1 {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            margin: var(--space-6) 0 var(--space-4) 0;
            color: var(--color-gray-900);
            border-bottom: 2px solid var(--color-gray-200);
            padding-bottom: var(--space-2);
        }

        .markdown-h2 {
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin: var(--space-5) 0 var(--space-3) 0;
            color: var(--color-gray-800);
        }

        .markdown-h3 {
            font-size: var(--font-size-lg);
            font-weight: 600;
            margin: var(--space-4) 0 var(--space-2) 0;
            color: var(--color-gray-800);
        }

        .markdown-paragraph {
            margin: var(--space-3) 0;
            line-height: 1.7;
            color: var(--color-gray-700);
        }

        .markdown-list {
            margin: var(--space-3) 0;
            padding-left: var(--space-5);
        }

        .markdown-list-item {
            margin: var(--space-1) 0;
            line-height: 1.6;
            color: var(--color-gray-700);
        }

        .markdown-code-block {
            background: var(--color-gray-100);
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            padding: var(--space-4);
            margin: var(--space-3) 0;
            overflow-x: auto;
        }

        .markdown-code-block code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: var(--font-size-sm);
            color: var(--color-gray-800);
        }

        .markdown-inline-code {
            background: var(--color-gray-100);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: var(--font-size-sm);
            color: var(--color-gray-800);
        }

        .markdown-link {
            color: var(--color-primary);
            text-decoration: underline;
        }

        .markdown-link:hover {
            color: var(--color-primary-dark);
        }
    </style>

    <script type="module">
        // Trial site - no authentication needed with enhanced error suppression
        let currentUser = null;

        // Trial site - ready to use immediately with enhanced authentication suppression
        try {
            console.log('Trial site loaded - no authentication required');
            
            // Suppress any authentication object references that might cause errors
            if (typeof window !== 'undefined') {
                // Prevent authentication-related errors by providing null checks
                window.currentUser = null;
                
                // Disable any authentication token refresh mechanisms
                try {
                    if (window.supabase) {
                        console.log('Supabase detected - disabling for trial mode');
                        // Safely disable Supabase auth methods to prevent token refresh
                        if (window.supabase.auth) {
                            window.supabase.auth.getSession = () => Promise.resolve({ data: { session: null }, error: null });
                            window.supabase.auth.refreshSession = () => Promise.resolve({ data: { session: null }, error: null });
                            window.supabase.auth.getUser = () => Promise.resolve({ data: { user: null }, error: null });
                        }
                        window.supabase = null;
                    }
                } catch (supabaseError) {
                    console.log('Trial mode - Supabase suppression completed:', supabaseError.message || 'Unknown supabase error');
                }
                
                // Suppress Firebase auth if present
                try {
                    if (window.firebase) {
                        console.log('Firebase detected - disabling for trial mode');
                        // Safely disable Firebase auth methods to prevent token refresh
                        if (window.firebase.auth) {
                            window.firebase.auth = () => ({
                                currentUser: null,
                                onAuthStateChanged: () => () => {},
                                signOut: () => Promise.resolve(),
                                getIdToken: () => Promise.resolve(null)
                            });
                        }
                        window.firebase = null;
                    }
                } catch (firebaseError) {
                    console.log('Trial mode - Firebase suppression completed:', firebaseError.message || 'Unknown firebase error');
                }

                // Disable any global authentication state checkers and token refresh mechanisms
                try {
                    window.checkAuthState = () => Promise.resolve(null);
                    window.refreshToken = () => Promise.resolve(null);
                    window.getAuthToken = () => Promise.resolve(null);
                    
                    // Override common authentication methods that might cause 400 errors
                    window.refreshAuthToken = () => Promise.resolve(null);
                    window.validateSession = () => Promise.resolve(false);
                    window.getSession = () => Promise.resolve(null);
                    window.renewSession = () => Promise.resolve(null);
                    
                    // Disable automatic token refresh intervals
                    if (window.tokenRefreshInterval) {
                        clearInterval(window.tokenRefreshInterval);
                        window.tokenRefreshInterval = null;
                    }
                    if (window.authCheckInterval) {
                        clearInterval(window.authCheckInterval);
                        window.authCheckInterval = null;
                    }
                } catch (globalAuthError) {
                    console.log('Trial mode - Global auth functions suppressed:', globalAuthError.message || 'Unknown global auth error');
                }
            }
        } catch (error) {
            // Suppress all authentication initialization errors
            console.log('Trial mode - authentication suppressed:', error.message || 'Unknown auth error');
        }

        // Enhanced global authentication error suppression for trial site
        window.addEventListener('error', function(event) {
            const error = event.error;
            const errorMessage = error ? error.message : '';
            const errorStack = error ? error.stack : '';
            const errorSource = event.filename || '';
            
            if (error && (
                errorMessage.includes('auth') ||
                errorMessage.includes('token') ||
                errorMessage.includes('supabase') ||
                errorMessage.includes('firebase') ||
                errorMessage.includes('400') ||
                errorMessage.includes('401') ||
                errorMessage.includes('403') ||
                errorMessage.includes('refresh') ||
                errorMessage.includes('session') ||
                errorMessage.includes('credential') ||
                errorMessage.includes('setupFocusRestoration') ||
                errorMessage.includes('applyDocumentTemplate') ||
                errorMessage.includes('initializeTemplateSystem') ||
                errorStack.includes('auth') ||
                errorStack.includes('supabase') ||
                errorStack.includes('firebase') ||
                errorSource.includes('content.js')
            )) {
                console.log('Trial mode - suppressing error:', errorMessage || 'Error suppressed');
                event.preventDefault();
                event.stopPropagation();
                return false;
            }
        });

        // Enhanced suppression of unhandled promise rejections related to authentication
        window.addEventListener('unhandledrejection', function(event) {
            const reason = event.reason;
            const reasonMessage = reason && reason.message ? reason.message : (typeof reason === 'string' ? reason : '');
            const reasonStack = reason && reason.stack ? reason.stack : '';
            
            if (reason && (
                (typeof reason === 'string' && (
                    reason.includes('auth') ||
                    reason.includes('token') ||
                    reason.includes('400') ||
                    reason.includes('401') ||
                    reason.includes('403') ||
                    reason.includes('refresh') ||
                    reason.includes('session') ||
                    reason.includes('supabase') ||
                    reason.includes('firebase') ||
                    reason.includes('credential') ||
                    reason.includes('Bad Request') ||
                    reason.includes('Unauthorized')
                )) ||
                (reasonMessage && (
                    reasonMessage.includes('auth') ||
                    reasonMessage.includes('token') ||
                    reasonMessage.includes('400') ||
                    reasonMessage.includes('401') ||
                    reasonMessage.includes('403') ||
                    reasonMessage.includes('refresh') ||
                    reasonMessage.includes('session') ||
                    reasonMessage.includes('supabase') ||
                    reasonMessage.includes('firebase') ||
                    reasonMessage.includes('credential') ||
                    reasonMessage.includes('Bad Request') ||
                    reasonMessage.includes('Unauthorized') ||
                    reasonMessage.includes('setupFocusRestoration') ||
                    reasonMessage.includes('applyDocumentTemplate') ||
                    reasonMessage.includes('initializeTemplateSystem')
                )) ||
                (reasonStack && (
                    reasonStack.includes('auth') ||
                    reasonStack.includes('supabase') ||
                    reasonStack.includes('firebase') ||
                    reasonStack.includes('token') ||
                    reasonStack.includes('content.js')
                ))
            )) {
                console.log('Trial mode - suppressing promise rejection:', reasonMessage || reason || 'Promise rejection suppressed');
                event.preventDefault();
                return false;
            }
        });

        // Report type change handler
        document.getElementById('reportType').addEventListener('change', function() {
            const customPromptGroup = document.getElementById('customPromptGroup');
            const taxStrategyGroup = document.getElementById('taxStrategyGroup');
            const inheritanceStrategyGroup = document.getElementById('inheritanceStrategyGroup');
            const comparisonSection = document.getElementById('comparisonSection');
            const standardUpload = document.getElementById('inputText').closest('.form-group');
            const fileUploadSection = document.getElementById('fileInput').closest('.form-group');
            
            // Hide all additional info groups
            customPromptGroup.style.display = 'none';
            taxStrategyGroup.style.display = 'none';
            inheritanceStrategyGroup.style.display = 'none';
            comparisonSection.style.display = 'none';
            
            // Reset required fields
            document.getElementById('customPrompt').required = false;
            
            // Show/hide standard upload sections based on report type
            if (this.value === 'comparison_analysis') {
                // Hide standard upload sections for comparison analysis
                standardUpload.style.display = 'none';
                fileUploadSection.style.display = 'none';
                comparisonSection.style.display = 'block';
            } else {
                // Show standard upload sections for other report types
                standardUpload.style.display = 'block';
                fileUploadSection.style.display = 'block';
                
                // Show relevant group based on selection
                if (this.value === 'custom') {
                    customPromptGroup.style.display = 'block';
                    document.getElementById('customPrompt').required = true;
                } else if (this.value === 'jp_tax_strategy') {
                    taxStrategyGroup.style.display = 'block';
                } else if (this.value === 'jp_inheritance_strategy') {
                    inheritanceStrategyGroup.style.display = 'block';
                }
            }
            
            // Update form validation based on report type
            updateFormValidation(this.value);
        });

        // Form validation function
        function updateFormValidation(reportType) {
            // Reset all validation states
            const inputText = document.getElementById('inputText');
            const propertyAText = document.getElementById('propertyAText');
            const propertyBText = document.getElementById('propertyBText');
            
            // Remove any existing validation attributes
            inputText.removeAttribute('required');
            if (propertyAText) propertyAText.removeAttribute('required');
            if (propertyBText) propertyBText.removeAttribute('required');
            
            if (reportType === 'comparison_analysis') {
                // For comparison analysis, at least one property must have data
                // We'll handle this in the form submission validation
            } else if (reportType === 'custom') {
                // Custom reports require custom prompt
                document.getElementById('customPrompt').required = true;
            } else {
                // Standard reports require input text or files
                // We'll handle this in the form submission validation
            }
        }

        function validateComparisonForm() {
            const propertyAText = document.getElementById('propertyAText').value.trim();
            const propertyBText = document.getElementById('propertyBText').value.trim();
            const propertyAFiles = document.getElementById('propertyAFiles').files.length;
            const propertyBFiles = document.getElementById('propertyBFiles').files.length;
            
            const hasPropertyAData = propertyAText || propertyAFiles > 0;
            const hasPropertyBData = propertyBText || propertyBFiles > 0;
            
            if (!hasPropertyAData) {
                showError('物件Aの情報（テキストまたはファイル）を入力してください');
                return false;
            }
            
            if (!hasPropertyBData) {
                showError('物件Bの情報（テキストまたはファイル）を入力してください');
                return false;
            }
            
            return true;
        }

        function validateStandardForm() {
            const inputText = document.getElementById('inputText').value.trim();
            const hasFiles = selectedFiles.length > 0;
            
            if (!inputText && !hasFiles) {
                showError('テキストまたはファイルを入力してください');
                return false;
            }
            
            return true;
        }

        // File handling
        const fileInput = document.getElementById('fileInput');
        const fileDropZone = document.getElementById('fileDropZone');
        const fileList = document.getElementById('fileList');
        const selectedFiles = [];

        // Initialize file upload functionality
        console.log('Initializing file upload functionality');
        console.log('Elements found:', {
            fileInput: !!fileInput,
            fileDropZone: !!fileDropZone,
            fileList: !!fileList
        });

        // Add click handler to file drop zone
        if (fileDropZone) {
            fileDropZone.addEventListener('click', (e) => {
                // Don't trigger if clicking on the span that already has onclick
                if (e.target.tagName !== 'SPAN') {
                    console.log('File drop zone clicked');
                    fileInput.click();
                }
            });
        }

        // File drop zone events
        let dragCounter = 0;

        if (fileDropZone) {
            fileDropZone.addEventListener('dragenter', (e) => {
                e.preventDefault();
                dragCounter++;
                fileDropZone.classList.add('border-blue-400', 'bg-blue-50');
            });

            fileDropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
            });

            fileDropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dragCounter--;
                if (dragCounter === 0) {
                    fileDropZone.classList.remove('border-blue-400', 'bg-blue-50');
                }
            });

            fileDropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dragCounter = 0;
                fileDropZone.classList.remove('border-blue-400', 'bg-blue-50');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    console.log('Files dropped:', files.length);
                    handleFiles(files);
                }
            });
        }

        if (fileInput) {
            fileInput.addEventListener('change', (e) => {
                console.log('File input changed, files:', e.target.files.length);
                handleFiles(e.target.files);
            });
        }

        function handleFiles(files) {
            console.log('handleFiles called with', files.length, 'files');
            
            if (!files || files.length === 0) {
                console.log('No files to process');
                return;
            }

            Array.from(files).forEach((file, index) => {
                console.log(`Processing file ${index + 1}:`, {
                    name: file.name,
                    size: file.size,
                    type: file.type
                });
                
                try {
                    if (validateFile(file)) {
                        selectedFiles.push(file);
                        displayFile(file);
                        console.log(`File ${file.name} added successfully`);
                    }
                } catch (error) {
                    console.error('Error processing file:', file.name, error);
                    showError(`ファイル "${file.name}" の処理中にエラーが発生しました`);
                }
            });
        }

        function validateFile(file) {
            console.log('Validating file:', file.name, 'Type:', file.type, 'Size:', file.size);
            
            const maxSize = 4.5 * 1024 * 1024; // 4.5MB
            const allowedTypes = [
                'application/pdf',
                'image/png', 
                'image/jpeg', 
                'image/jpg',
                'image/gif',
                'image/webp',
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
                'application/vnd.ms-excel', // .xls
                'text/csv',
                'text/plain',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // .docx
                'application/msword' // .doc
            ];
            
            // Check file size
            if (file.size > maxSize) {
                console.log('File too large:', file.size, 'bytes');
                showError(`ファイル "${file.name}" が大きすぎます（最大4.5MB）`);
                return false;
            }
            
            // Check file type
            const isAllowedType = allowedTypes.includes(file.type) || file.type.startsWith('image/');
            if (!isAllowedType) {
                console.log('File type not allowed:', file.type);
                showError(`ファイル "${file.name}" の形式がサポートされていません（対応形式: PDF, 画像, Excel, CSV, Word, テキスト）`);
                return false;
            }
            
            console.log('File validation passed for:', file.name);
            return true;
        }

        function displayFile(file) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            
            // Generate unique ID for this file
            const fileId = `file_${Date.now()}_${Math.random().toString(36).substring(2)}`;
            
            // Determine file type icon and preview capability
            const isImage = file.type.startsWith('image/');
            const isPDF = file.type === 'application/pdf';
            const canPreview = isImage || isPDF;
            
            const fileIcon = isPDF ? 
                `<svg class="file-icon pdf-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M4 18h12V6l-4-4H4v16zM9 2h2v4h4v2H9V2z"/>
                    <text x="10" y="14" text-anchor="middle" font-size="6" fill="white">PDF</text>
                </svg>` :
                `<svg class="file-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                </svg>`;
            
            fileItem.innerHTML = `
                <div class="file-info">
                    ${fileIcon}
                    <div class="file-details">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">(${(file.size / 1024 / 1024).toFixed(1)}MB)</div>
                        ${canPreview ? `<div class="file-type-badge">${isPDF ? 'PDF' : '画像'} - AI読み取り対応</div>` : ''}
                    </div>
                </div>
                <div class="file-actions">
                    ${canPreview ? `<button onclick="previewFile('${fileId}')" class="file-preview-btn" title="プレビュー">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                        </svg>
                    </button>` : ''}
                    <button onclick="removeFile('${file.name}')" class="file-remove" title="削除">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            // Store file reference for preview
            fileItem.dataset.fileId = fileId;
            fileItem.fileReference = file;
            
            if (fileList) {
                fileList.appendChild(fileItem);
            } else {
                console.error('File list element not found');
            }
        }

        // File preview functionality
        function previewFile(fileId) {
            const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
            if (!fileItem || !fileItem.fileReference) {
                console.error('File not found for preview');
                return;
            }
            
            const file = fileItem.fileReference;
            const modal = document.getElementById('filePreviewModal');
            const modalTitle = document.getElementById('previewModalTitle');
            const modalContent = document.getElementById('previewModalContent');
            
            modalTitle.textContent = `${file.name} のプレビュー`;
            
            if (file.type.startsWith('image/')) {
                // Image preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    modalContent.innerHTML = `
                        <div class="image-preview-container">
                            <img src="${e.target.result}" alt="${file.name}" class="preview-image">
                            <div class="image-info">
                                <p><strong>ファイル名:</strong> ${file.name}</p>
                                <p><strong>サイズ:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                                <p><strong>形式:</strong> ${file.type}</p>
                                <div class="ai-analysis-note">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                    </svg>
                                    この画像はAIが自動的に読み取り、投資分析レポートに反映されます
                                </div>
                            </div>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf') {
                // PDF preview
                modalContent.innerHTML = `
                    <div class="pdf-preview-container">
                        <div class="pdf-icon-large">
                            <svg width="64" height="64" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M4 18h12V6l-4-4H4v16zM9 2h2v4h4v2H9V2z"/>
                            </svg>
                            <div class="pdf-label">PDF</div>
                        </div>
                        <div class="pdf-info">
                            <h3>${file.name}</h3>
                            <p><strong>サイズ:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                            <p><strong>形式:</strong> PDF文書</p>
                            <div class="ai-analysis-note">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                </svg>
                                このPDFはAIが自動的に読み取り、投資分析レポートに反映されます
                            </div>
                            <div class="pdf-capabilities">
                                <h4>AI読み取り機能:</h4>
                                <ul>
                                    <li>✓ 投資指標の自動抽出（FCR、DCR、BER、IRR、NPV等）</li>
                                    <li>✓ 物件情報の読み取り（所在地、構造、築年数等）</li>
                                    <li>✓ 財務データの分析（収入、支出、キャッシュフロー等）</li>
                                    <li>✓ 表やグラフの内容理解</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            modal.classList.remove('hidden');
        }
        
        // Close modal functionality
        function closePreviewModal() {
            document.getElementById('filePreviewModal').classList.add('hidden');
        }

        function removeFile(fileName) {
            const index = selectedFiles.findIndex(f => f.name === fileName);
            if (index > -1) {
                selectedFiles.splice(index, 1);
            }
            // Remove from display
            if (fileList) {
                const fileItems = fileList.querySelectorAll('div');
                fileItems.forEach(item => {
                    if (item.textContent.includes(fileName)) {
                        item.remove();
                    }
                });
            } else {
                console.error('File list element not found for removal');
            }
        }

        // Comparison analysis file handling
        const propertyAFiles = [];
        const propertyBFiles = [];

        // Property A file handling
        document.getElementById('propertyAFiles').addEventListener('change', (e) => {
            handleComparisonFiles(e.target.files, 'A');
        });

        // Property B file handling
        document.getElementById('propertyBFiles').addEventListener('change', (e) => {
            handleComparisonFiles(e.target.files, 'B');
        });

        function handleComparisonFiles(files, property) {
            const fileArray = property === 'A' ? propertyAFiles : propertyBFiles;
            
            Array.from(files).forEach(file => {
                if (validateFile(file)) {
                    fileArray.push(file);
                    displayComparisonFile(file, property);
                }
            });
        }

        function displayComparisonFile(file, property) {
            const fileInput = document.getElementById(`property${property}Files`);
            const container = fileInput.parentElement;
            
            // Create or get file list container
            let fileListContainer = container.querySelector('.comparison-file-list');
            if (!fileListContainer) {
                fileListContainer = document.createElement('div');
                fileListContainer.className = 'comparison-file-list';
                fileListContainer.style.cssText = 'margin-top: var(--space-2);';
                container.appendChild(fileListContainer);
            }
            
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.style.cssText = `
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: var(--space-2);
                background: var(--color-gray-50);
                border: 1px solid var(--color-gray-200);
                border-radius: 4px;
                margin-bottom: var(--space-1);
                font-size: var(--font-size-sm);
            `;
            
            fileItem.innerHTML = `
                <div style="display: flex; align-items: center; gap: var(--space-2);">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20" style="color: var(--color-gray-500);">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                    </svg>
                    <span>${file.name}</span>
                    <span style="color: var(--color-gray-500);">(${(file.size / 1024 / 1024).toFixed(1)}MB)</span>
                </div>
                <button onclick="removeComparisonFile('${file.name}', '${property}')" style="
                    background: none;
                    border: none;
                    cursor: pointer;
                    color: var(--color-gray-500);
                    padding: 2px;
                    border-radius: 2px;
                " onmouseover="this.style.color='var(--color-red-600)'" onmouseout="this.style.color='var(--color-gray-500)'">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            `;
            
            fileListContainer.appendChild(fileItem);
        }

        function removeComparisonFile(fileName, property) {
            const fileArray = property === 'A' ? propertyAFiles : propertyBFiles;
            const index = fileArray.findIndex(f => f.name === fileName);
            
            if (index > -1) {
                fileArray.splice(index, 1);
            }
            
            // Remove from display
            const container = document.getElementById(`property${property}Files`).parentElement;
            const fileListContainer = container.querySelector('.comparison-file-list');
            
            if (fileListContainer) {
                const fileItems = fileListContainer.querySelectorAll('.file-item');
                fileItems.forEach(item => {
                    if (item.textContent.includes(fileName)) {
                        item.remove();
                    }
                });
                
                // Remove container if empty
                if (fileListContainer.children.length === 0) {
                    fileListContainer.remove();
                }
            }
        }

        // Form submission
        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const reportType = formData.get('reportType');
            const inputText = formData.get('inputText');
            const customPrompt = formData.get('customPrompt');
            const language = formData.get('language') || 'ja';
            
            // CRITICAL: Ensure we use the latest prompt template
            let promptTemplate = '';
            if (typeof PromptTemplateManager !== 'undefined' && reportType !== 'custom') {
                try {
                    const templateManager = new PromptTemplateManager();
                    promptTemplate = await templateManager.loadTemplate(reportType);
                    console.log(`Loaded latest template for ${reportType}:`, promptTemplate.substring(0, 100) + '...');
                } catch (error) {
                    console.error('Error loading prompt template:', error);
                    window.errorHandler.showNotification('プロンプトテンプレートの読み込みに失敗しました', 'warning', 3000);
                }
            }

            // Collect additional information based on report type
            let additionalInfo = {};
            let finalInputText = inputText;

            if (reportType === 'custom' && customPrompt) {
                finalInputText = customPrompt + '\n\n' + (inputText || '');
            } else if (reportType === 'jp_tax_strategy') {
                additionalInfo = {
                    annualIncome: formData.get('annualIncome'),
                    currentTaxRate: formData.get('currentTaxRate'),
                    familyMembers: formData.get('familyMembers'),
                    otherDeductions: formData.get('otherDeductions'),
                    investmentGoal: formData.get('investmentGoal')
                };
                
                // Add tax strategy context to input text
                const taxContext = `
【投資家情報】
年収: ${additionalInfo.annualIncome || '未入力'}万円
所得税率: ${additionalInfo.currentTaxRate || '未入力'}%
扶養家族数: ${additionalInfo.familyMembers || '未入力'}人
その他所得控除: ${additionalInfo.otherDeductions || '未入力'}万円
投資目標: ${additionalInfo.investmentGoal || '未入力'}

【分析対象データ】
${inputText || ''}`;
                finalInputText = taxContext;
                
            } else if (reportType === 'jp_inheritance_strategy') {
                additionalInfo = {
                    totalAssets: formData.get('totalAssets'),
                    liquidAssets: formData.get('liquidAssets'),
                    realEstateAssets: formData.get('realEstateAssets'),
                    otherAssets: formData.get('otherAssets'),
                    spouse: formData.get('spouse'),
                    children: formData.get('children'),
                    parents: formData.get('parents'),
                    inheritanceGoal: formData.get('inheritanceGoal')
                };
                
                // Add inheritance strategy context to input text
                const inheritanceContext = `
【資産情報】
総資産額: ${additionalInfo.totalAssets || '未入力'}万円
現金・預金: ${additionalInfo.liquidAssets || '未入力'}万円
既存不動産: ${additionalInfo.realEstateAssets || '未入力'}万円
その他資産: ${additionalInfo.otherAssets || '未入力'}万円

【法定相続人情報】
配偶者: ${additionalInfo.spouse === '1' ? 'あり' : 'なし'}
子供: ${additionalInfo.children || '0'}人
両親: ${additionalInfo.parents === '2' ? '両親' : additionalInfo.parents === '1' ? '片親' : 'なし'}

【相続対策目標】
${additionalInfo.inheritanceGoal || '未入力'}

【分析対象データ】
${inputText || ''}`;
                finalInputText = inheritanceContext;
            }

            if (!reportType) {
                showError('レポート種別を選択してください');
                return;
            }

            // Validate based on report type
            if (reportType === 'comparison_analysis') {
                if (!validateComparisonForm()) {
                    return;
                }
            } else {
                if (!validateStandardForm()) {
                    return;
                }
            }

            // Prepare request data based on report type
            let requestData;
            
            if (reportType === 'comparison_analysis') {
                // Prepare files for Property A
                const propertyAFilesData = [];
                for (const file of propertyAFiles) {
                    const base64 = await fileToBase64(file);
                    propertyAFilesData.push({
                        name: file.name,
                        type: file.type,
                        data: base64
                    });
                }
                
                // Prepare files for Property B
                const propertyBFilesData = [];
                for (const file of propertyBFiles) {
                    const base64 = await fileToBase64(file);
                    propertyBFilesData.push({
                        name: file.name,
                        type: file.type,
                        data: base64
                    });
                }
                
                requestData = {
                    reportType,
                    propertyA: {
                        inputText: document.getElementById('propertyAText').value,
                        files: propertyAFilesData
                    },
                    propertyB: {
                        inputText: document.getElementById('propertyBText').value,
                        files: propertyBFilesData
                    },
                    comparisonCriteria: document.getElementById('comparisonCriteria').value || '収益性、リスク、立地を中心とした総合比較',
                    resultFormat: document.getElementById('resultFormat').value || '表形式での比較と推奨順位',
                    additionalInfo,
                    promptTemplate: promptTemplate, // CRITICAL: Include latest prompt template
                    options: {
                        language
                    }
                };
            } else {
                // Prepare files for standard reports
                const files = [];
                for (const file of selectedFiles) {
                    const base64 = await fileToBase64(file);
                    files.push({
                        name: file.name,
                        type: file.type,
                        data: base64
                    });
                }
                
                requestData = {
                    reportType,
                    inputText: finalInputText,
                    files,
                    additionalInfo,
                    promptTemplate: promptTemplate, // CRITICAL: Include latest prompt template
                    options: {
                        language
                    }
                };
            }

            const submitBtn = document.querySelector('button[type="submit"]');
            
            try {
                // Show loading state
                window.errorHandler.showLoading(submitBtn, 'レポート生成中...');
                showStatus('レポートを生成中...');
                hideError();
                hideResults();
                
                // Adjust progress timing based on input complexity
                adjustProgressSpeed(selectedFiles.length, finalInputText.length);
                
                // Show enhanced detailed progress
                showDetailedProgress();
                startEstimationTimer();
                
                // Handle long-running request notifications
                handleLongRunningRequest();

                console.log('Sending request:', {
                    reportType: requestData.reportType,
                    inputTextLength: requestData.inputText?.length || 0,
                    filesCount: requestData.files?.length || 0,
                    hasAdditionalInfo: !!requestData.additionalInfo
                });
                console.log('Full request data:', requestData);
                
                // Debug file data structure
                if (requestData.files && requestData.files.length > 0) {
                    console.log('File details:', requestData.files.map(f => ({
                        name: f.name,
                        type: f.type,
                        dataLength: f.data ? f.data.length : 0,
                        dataPreview: f.data ? f.data.substring(0, 50) + '...' : 'no data'
                    })));
                }

                // Enhanced fetch with timeout and abort controller
                const timeoutId = setTimeout(() => {
                    if (progressState.abortController) {
                        progressState.abortController.abort();
                    }
                }, 120000); // 2 minute timeout

                // Enhanced API call with authentication error suppression
                let response;
                try {
                    response = await fetch('/api/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json; charset=utf-8'
                        },
                        body: JSON.stringify(requestData),
                        signal: progressState.abortController?.signal
                    });
                } catch (fetchError) {
                    // Suppress authentication-related fetch errors
                    if (fetchError.message && (
                        fetchError.message.includes('auth') ||
                        fetchError.message.includes('400') ||
                        fetchError.message.includes('401') ||
                        fetchError.message.includes('403') ||
                        fetchError.message.includes('token')
                    )) {
                        console.log('Trial mode - suppressing API authentication error:', fetchError.message);
                        throw new Error('API request failed - authentication suppressed for trial mode');
                    }
                    throw fetchError;
                }

                clearTimeout(timeoutId);
                console.log('Response status:', response.status);

                const result = await response.json();
                
                // Handle API-specific errors
                await handleApiError(response, result);
                
                // Complete progress animation
                completeProgress();
                
                // Display results after progress completes
                setTimeout(() => {
                    displayResults(result);
                    hideStatus();
                    
                    // Scroll to results section with smooth animation
                    const resultsSection = document.getElementById('resultsSection');
                    if (resultsSection) {
                        resultsSection.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                    }
                    
                    // Show success notification with service info
                    const aiService = result.report?.aiService || 'openai';
                    const serviceNotification = result.report?.serviceNotification;
                    
                    let notificationMessage = 'レポートが正常に生成されました';
                    if (serviceNotification) {
                        notificationMessage += ' (バックアップサービス使用)';
                        // Show additional info about backup service usage
                        setTimeout(() => {
                            window.errorHandler.showNotification(serviceNotification.message, 'info', 5000);
                        }, 3500);
                    }
                    
                    window.errorHandler.showNotification(notificationMessage, 'success', 3000);
                }, 1500);

            } catch (error) {
                // Enhanced error handling
                hideDetailedProgress();
                
                if (error.name === 'AbortError') {
                    // Request was cancelled
                    console.log('Request was cancelled');
                    return; // Don't show error for cancelled requests
                } else if (error.message?.includes('timeout')) {
                    showError('リクエストがタイムアウトしました。もう一度お試しください。');
                    window.errorHandler.showNotification('リクエストがタイムアウトしました', 'error', 5000);
                } else {
                    window.errorHandler.handleError(error, 'report-generation');
                    showError(window.errorHandler.getUserFriendlyMessage(error, 'report-generation'));
                }
                
                hideStatus();
            } finally {
                // Hide loading state
                window.errorHandler.hideLoading(submitBtn);
            }
        });

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        function showStatus(message) {
            document.getElementById('statusText').textContent = message;
            document.getElementById('statusSection').classList.remove('hidden');
        }

        function hideStatus() {
            document.getElementById('statusSection').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorSection').classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorSection').classList.add('hidden');
        }

        function hideResults() {
            document.getElementById('resultsSection').classList.add('hidden');
        }

        // Simple Report Renderer fallback system
        let simpleReportRenderer = null;
        
        function initializeSimpleReportFallback(content) {
            try {
                console.log('Initializing SimpleReportRenderer fallback');
                const container = document.getElementById('enhancedResultsContainer');
                if (!container) {
                    console.error('Container not found for SimpleReportRenderer fallback');
                    return;
                }
                
                // Clear container
                container.innerHTML = '';
                
                // Check if SimpleReportRenderer is available
                if (typeof SimpleReportRenderer !== 'undefined') {
                    // Use SimpleReportRenderer for reliable display
                    if (simpleReportRenderer) {
                        simpleReportRenderer.destroy();
                    }
                    
                    simpleReportRenderer = new SimpleReportRenderer(container, {
                        enableCopy: true,
                        enableExport: true,
                        enablePrint: true,
                        showWordCount: true,
                        showReadingTime: true,
                        enableResponsive: true
                    });
                    
                    simpleReportRenderer.setContent(content, {
                        title: '生成されたレポート',
                        generatedAt: new Date()
                    });
                    
                    console.log('SimpleReportRenderer fallback initialized successfully');
                } else {
                    // Final fallback - basic HTML display
                    console.warn('SimpleReportRenderer not available, using basic HTML fallback');
                    container.innerHTML = `
                        <div style="
                            padding: 20px;
                            background: white;
                            border: 1px solid #e5e7eb;
                            border-radius: 8px;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        ">
                            <h3 style="margin: 0 0 16px 0; color: #111827;">生成されたレポート</h3>
                            <div style="
                                background: #f9fafb;
                                padding: 16px;
                                border-radius: 6px;
                                border: 1px solid #e5e7eb;
                                white-space: pre-wrap;
                                font-family: inherit;
                                line-height: 1.6;
                                color: #374151;
                                max-height: 500px;
                                overflow-y: auto;
                            ">${content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                            <button onclick="
                                navigator.clipboard.writeText(\`${content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)
                                .then(() => alert('クリップボードにコピーしました'))
                                .catch(() => alert('コピーに失敗しました'));
                            " style="
                                margin-top: 12px;
                                padding: 8px 16px;
                                background: #3b82f6;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 14px;
                            ">📋 コピー</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('SimpleReportRenderer fallback failed:', error);
                // Absolute final fallback
                const container = document.getElementById('enhancedResultsContainer');
                if (container) {
                    container.innerHTML = `
                        <div style="padding: 20px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; color: #991b1b;">
                            <h3 style="margin: 0 0 12px 0;">表示エラー</h3>
                            <p style="margin: 0;">レポートの表示中にエラーが発生しました。ページを再読み込みしてお試しください。</p>
                        </div>
                    `;
                }
            }
        }

        // Initialize Enhanced Results Layout
        let enhancedResultsLayout = null;
        
        function initializeEnhancedResults(content) {
            try {
                const container = document.getElementById('enhancedResultsContainer');
                if (!container) {
                    console.error('Enhanced results container not found');
                    return;
                }

                // Check if enhanced results layout is available
                const hasEnhancedLayout = typeof EnhancedResultsLayout !== 'undefined';
                console.log('Enhanced layout availability:', hasEnhancedLayout);
                
                if (hasEnhancedLayout) {
                    // Initialize the enhanced results layout if not already done
                    if (!enhancedResultsLayout) {
                        try {
                            enhancedResultsLayout = new EnhancedResultsLayout(container, {
                                enableBusinessFormatting: true,
                                enablePDFExport: true,
                                enableFormatControls: true,
                                enableAccessibility: true,
                                defaultView: 'preview'
                            });
                            
                            console.log('Enhanced results layout created successfully');
                        } catch (initError) {
                            console.error('Error creating enhanced results layout:', initError);
                            enhancedResultsLayout = null;
                        }
                    }

                    // Set the content in the enhanced layout
                    if (enhancedResultsLayout && typeof enhancedResultsLayout.setContent === 'function') {
                        try {
                            enhancedResultsLayout.setContent(content);
                            console.log('Content set in enhanced results layout');
                            return; // Success - exit early
                        } catch (contentError) {
                            console.error('Error setting content in enhanced layout:', contentError);
                        }
                    }
                }

                // Fallback to SimpleReportRenderer for reliable display
                console.log('Enhanced layout failed, using SimpleReportRenderer fallback');
                initializeSimpleReportFallback(content);
                
            } catch (error) {
                console.error('Error initializing enhanced results:', error);
                // Ultimate fallback - use SimpleReportRenderer for maximum reliability
                initializeSimpleReportFallback(content);
            }
        }



        // Enhanced Progress Management
        let progressState = {
            startTime: null,
            currentStep: 0,
            isActive: false,
            estimatedDuration: 45000, // 45 seconds estimated
            intervals: {
                timer: null,
                progress: null,
                estimation: null
            },
            abortController: null
        };

        function showDetailedProgress() {
            progressState.startTime = Date.now();
            progressState.currentStep = 0;
            progressState.isActive = true;
            progressState.abortController = new AbortController();
            
            // Reset all progress elements
            resetProgressElements();
            
            // Start progress animations
            startProgressTimer();
            startProgressBar();
            startStepProgression();
            
            // Setup cancel button
            setupCancelButton();
            
            console.log('Enhanced progress started');
        }

        function hideDetailedProgress() {
            progressState.isActive = false;
            
            // Clear all intervals
            Object.values(progressState.intervals).forEach(interval => {
                if (interval) clearInterval(interval);
            });
            
            // Reset intervals object
            progressState.intervals = { timer: null, progress: null, estimation: null };
            
            console.log('Enhanced progress stopped');
        }

        function resetProgressElements() {
            // Reset progress bar
            const progressBarFill = document.getElementById('progressBarFill');
            const progressPercentage = document.getElementById('progressPercentage');
            if (progressBarFill) progressBarFill.style.width = '0%';
            if (progressPercentage) progressPercentage.textContent = '0%';
            
            // Reset all steps
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step${i}`);
                if (step) {
                    step.classList.remove('active', 'completed');
                    const spinner = step.querySelector('.step-spinner');
                    const check = step.querySelector('.step-check');
                    const number = step.querySelector('.step-number');
                    
                    if (spinner) spinner.classList.add('hidden');
                    if (check) check.classList.add('hidden');
                    if (number) number.style.display = 'block';
                }
            }
            
            // Activate first step
            const firstStep = document.getElementById('step1');
            if (firstStep) {
                firstStep.classList.add('active');
                const spinner = firstStep.querySelector('.step-spinner');
                const number = firstStep.querySelector('.step-number');
                if (spinner) spinner.classList.remove('hidden');
                if (number) number.style.display = 'none';
            }
        }

        function startProgressTimer() {
            const progressTimeEl = document.getElementById('progressTime');
            const processingTimeEl = document.getElementById('processingTime');
            
            progressState.intervals.timer = setInterval(() => {
                if (!progressState.isActive) return;
                
                const elapsed = Date.now() - progressState.startTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (progressTimeEl) progressTimeEl.textContent = timeString;
                if (processingTimeEl) processingTimeEl.textContent = timeString;
            }, 1000);
        }

        function startProgressBar() {
            const progressBarFill = document.getElementById('progressBarFill');
            const progressPercentage = document.getElementById('progressPercentage');
            let progress = 0;
            
            progressState.intervals.progress = setInterval(() => {
                if (!progressState.isActive) return;
                
                const elapsed = Date.now() - progressState.startTime;
                const baseProgress = Math.min((elapsed / progressState.estimatedDuration) * 100, 95);
                
                // Add some randomness to make it feel more realistic
                const randomFactor = Math.random() * 2 - 1; // -1 to 1
                progress = Math.min(baseProgress + randomFactor, 95);
                
                if (progressBarFill) progressBarFill.style.width = `${progress}%`;
                if (progressPercentage) progressPercentage.textContent = `${Math.round(progress)}%`;
            }, 500);
        }

        function startStepProgression() {
            const steps = [
                { id: 'step1', duration: 3000, message: 'リクエストを準備中...' },
                { id: 'step2', duration: 8000, message: 'ファイルを処理中...' },
                { id: 'step3', duration: 25000, message: 'AIモデルがレポートを生成中...' },
                { id: 'step4', duration: 9000, message: 'レポートを整形中...' }
            ];
            
            let currentStepIndex = 0;
            
            const progressToNextStep = () => {
                if (!progressState.isActive || currentStepIndex >= steps.length) return;
                
                const currentStep = steps[currentStepIndex];
                const statusText = document.getElementById('statusText');
                
                // Update status message
                if (statusText) statusText.textContent = currentStep.message;
                
                // Complete current step and move to next
                setTimeout(() => {
                    if (!progressState.isActive) return;
                    
                    completeStep(currentStep.id);
                    currentStepIndex++;
                    
                    if (currentStepIndex < steps.length) {
                        activateStep(steps[currentStepIndex].id);
                        progressToNextStep();
                    }
                }, currentStep.duration);
            };
            
            // Start the progression
            progressToNextStep();
        }

        function activateStep(stepId) {
            const step = document.getElementById(stepId);
            if (!step) return;
            
            step.classList.add('active');
            const spinner = step.querySelector('.step-spinner');
            const number = step.querySelector('.step-number');
            
            if (spinner) spinner.classList.remove('hidden');
            if (number) number.style.display = 'none';
        }

        function completeStep(stepId) {
            const step = document.getElementById(stepId);
            if (!step) return;
            
            step.classList.remove('active');
            step.classList.add('completed');
            
            const spinner = step.querySelector('.step-spinner');
            const check = step.querySelector('.step-check');
            const number = step.querySelector('.step-number');
            
            if (spinner) spinner.classList.add('hidden');
            if (check) check.classList.remove('hidden');
            if (number) number.style.display = 'none';
        }

        function updateEstimatedTime() {
            const estimatedTimeEl = document.getElementById('estimatedTime');
            if (!estimatedTimeEl || !progressState.isActive) return;
            
            const elapsed = Date.now() - progressState.startTime;
            const remaining = Math.max(0, progressState.estimatedDuration - elapsed);
            
            if (remaining > 0) {
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                estimatedTimeEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            } else {
                estimatedTimeEl.textContent = '間もなく完了';
            }
        }

        function setupCancelButton() {
            const cancelBtn = document.getElementById('cancelProgress');
            if (!cancelBtn) return;
            
            cancelBtn.onclick = () => {
                if (confirm('レポート生成をキャンセルしますか？')) {
                    cancelProgress();
                }
            };
        }

        function cancelProgress() {
            if (progressState.abortController) {
                progressState.abortController.abort();
            }
            
            hideDetailedProgress();
            hideStatus();
            
            // Re-enable form
            const submitBtn = document.querySelector('button[type="submit"]');
            if (submitBtn) {
                window.errorHandler.hideLoading(submitBtn);
            }
            
            showError('レポート生成がキャンセルされました');
            
            window.errorHandler.showNotification('レポート生成をキャンセルしました', 'warning', 3000);
        }

        function completeProgress() {
            // Complete all remaining steps
            for (let i = 1; i <= 4; i++) {
                completeStep(`step${i}`);
            }
            
            // Set progress to 100%
            const progressBarFill = document.getElementById('progressBarFill');
            const progressPercentage = document.getElementById('progressPercentage');
            if (progressBarFill) progressBarFill.style.width = '100%';
            if (progressPercentage) progressPercentage.textContent = '100%';
            
            // Update status
            const statusText = document.getElementById('statusText');
            if (statusText) statusText.textContent = 'レポート生成完了！';
            
            // Hide progress after a short delay
            setTimeout(() => {
                hideDetailedProgress();
            }, 1500);
        }

        // Start estimation timer
        function startEstimationTimer() {
            progressState.intervals.estimation = setInterval(updateEstimatedTime, 1000);
        }

        function displayResults(result) {
            // Handle both old and new API response formats
            const content = result.report?.content || result.content || result.markdown || '';
            
            if (!content) {
                // Initialize enhanced results layout with empty content
                initializeEnhancedResults('レポートが生成されましたが、内容を表示できません。');
                document.getElementById('resultsSection').classList.remove('hidden');
                return;
            }

            // Initialize enhanced results layout with content
            initializeEnhancedResults(content);
            
            // Initialize the enhanced report display
            if (window.initializeReportDisplay) {
                window.initializeReportDisplay();
            }
            
            // Show usage information if available
            const usage = result.report?.usage || result.usage;
            if (usage) {
                const usageInfo = document.createElement('div');
                usageInfo.className = 'usage-info';
                usageInfo.style.cssText = `
                    padding: var(--space-2) var(--space-4);
                    background: var(--color-gray-50);
                    border-bottom: 1px solid var(--color-gray-200);
                    font-size: var(--font-size-xs);
                    color: var(--color-gray-600);
                    text-align: right;
                `;
                usageInfo.innerHTML = `
                    Token使用量: ${usage.totalTokens.toLocaleString()} 
                    (入力: ${usage.promptTokens.toLocaleString()}, 
                    出力: ${usage.completionTokens.toLocaleString()})
                    ${usage.estimatedCost ? ` | 推定コスト: ${usage.estimatedCost}` : ''}
                `;
                
                const reportContainer = document.querySelector('.report-display-container');
                if (reportContainer) {
                    // Remove existing usage info
                    const existingUsage = reportContainer.querySelector('.usage-info');
                    if (existingUsage) {
                        existingUsage.remove();
                    }
                    reportContainer.insertBefore(usageInfo, reportContainer.firstChild);
                }
            }
            
            // Legacy preview is hidden, using enhanced display above
            const preview = document.getElementById('preview');
            if (preview) {
                preview.style.display = 'none';
            }
            
            // Remove old preview content setup
            /*
                <div style="margin-bottom: var(--space-4);">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: var(--space-2);">
                        <span style="font-size: var(--font-size-sm); color: var(--color-gray-600);">
                            生成されたレポート（編集可能）
                        </span>
                        <div style="font-size: var(--font-size-xs); color: var(--color-gray-500);">
                            ${result.usage ? `
                                Token使用量: ${result.usage.totalTokens.toLocaleString()} 
                                (入力: ${result.usage.promptTokens.toLocaleString()}, 
                                出力: ${result.usage.completionTokens.toLocaleString()})
                                <br>推定コスト: $${result.usage.estimatedCost}
                            ` : ''}
                        </div>
                    </div>
                    <textarea 
                        id="reportContent" 
                        class="report-textarea"
                        placeholder="レポート内容がここに表示されます..."
                    >${content}</textarea>
                </div>
                
                <div style="margin-bottom: var(--space-4);">
                    <h4 style="margin-bottom: var(--space-2); color: var(--color-gray-800);">プレビュー</h4>
                    <div id="reportPreview" class="report-preview"></div>
                </div>
            */
            
            document.getElementById('resultsSection').classList.remove('hidden');

            // Enhanced copy functionality
            const copyBtn = document.getElementById('copyBtn');
            if (copyBtn) {
                copyBtn.onclick = () => {
                    const currentContent = window.getCurrentReportContent ? window.getCurrentReportContent() : content;
                    navigator.clipboard.writeText(currentContent).then(() => {
                        if (window.showButtonFeedback) {
                            window.showButtonFeedback(copyBtn, 'コピー済み', 'success');
                        }
                    }).catch(() => {
                        if (window.showButtonFeedback) {
                            window.showButtonFeedback(copyBtn, 'コピー失敗', 'error');
                        }
                    });
                };
            }

            // Enhanced download functionality
            const downloadBtn = document.getElementById('downloadBtn');
            if (downloadBtn) {
                downloadBtn.onclick = () => {
                    const currentContent = window.getCurrentReportContent ? window.getCurrentReportContent() : content;
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    const filename = `report_${timestamp}.md`;
                    
                    const blob = new Blob([currentContent], { type: 'text/markdown; charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    if (window.showButtonFeedback) {
                        window.showButtonFeedback(downloadBtn, 'ダウンロード済み', 'success');
                    }
                };
            }

            // PDF Download functionality
            const downloadPdfBtn = document.getElementById('downloadPdfBtn');
            if (downloadPdfBtn) {
                downloadPdfBtn.onclick = () => {
                    const currentContent = window.getCurrentReportContent ? window.getCurrentReportContent() : content;
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    const filename = `report_${timestamp}.pdf`;
                    
                    // Create a new window for PDF generation
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>投資分析レポート</title>
                            <meta charset="utf-8">
                            <style>
                                body {
                                    font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
                                    line-height: 1.6;
                                    margin: 40px;
                                    color: #333;
                                }
                                h1, h2, h3, h4, h5, h6 {
                                    color: #2c3e50;
                                    margin-top: 24px;
                                    margin-bottom: 16px;
                                }
                                h1 { font-size: 24px; border-bottom: 2px solid #3498db; padding-bottom: 8px; }
                                h2 { font-size: 20px; border-bottom: 1px solid #bdc3c7; padding-bottom: 4px; }
                                h3 { font-size: 18px; }
                                p { margin-bottom: 12px; }
                                ul, ol { margin-bottom: 12px; padding-left: 24px; }
                                li { margin-bottom: 4px; }
                                strong { color: #2c3e50; }
                                table { border-collapse: collapse; width: 100%; margin: 16px 0; }
                                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                                th { background-color: #f8f9fa; font-weight: bold; }
                                .header { text-align: center; margin-bottom: 40px; }
                                .footer { margin-top: 40px; text-align: center; font-size: 12px; color: #666; }
                                @media print {
                                    body { margin: 20px; }
                                    .no-print { display: none; }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <h1>投資分析レポート</h1>
                                <p>生成日時: ${new Date().toLocaleString('ja-JP')}</p>
                            </div>
                            <div class="content">
                                ${markdownToHtml(currentContent)}
                            </div>
                            <div class="footer">
                                <p>このレポートは投資分析システムにより生成されました</p>
                            </div>
                        </body>
                        </html>
                    `);
                    printWindow.document.close();
                    
                    // Wait for content to load, then print
                    setTimeout(() => {
                        printWindow.print();
                        printWindow.close();
                    }, 500);
                    
                    if (window.showButtonFeedback) {
                        window.showButtonFeedback(downloadPdfBtn, 'PDF生成中', 'success');
                    }
                };
            }

            // Enhanced PDF Export functionality with performance optimizations
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            if (exportPdfBtn && typeof OptimizedPDFExportManager !== 'undefined') {
                const pdfExportManager = new OptimizedPDFExportManager({
                    defaultFilename: 'business-report',
                    businessFormatting: true,
                    enableLazyLoading: true,
                    enableCaching: true,
                    enableChunkedProcessing: true,
                    enableMemoryOptimization: true
                });

                exportPdfBtn.onclick = async () => {
                    try {
                        // Show loading state
                        const originalHTML = exportPdfBtn.innerHTML;
                        exportPdfBtn.innerHTML = `
                            <svg class="icon animate-spin" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 12a9 9 0 11-6.219-8.56"/>
                            </svg>
                            PDF出力中...
                        `;
                        exportPdfBtn.disabled = true;

                        // Get current content and settings
                        const currentContent = window.getCurrentReportContent ? window.getCurrentReportContent() : content;
                        
                        // Get PDF export settings
                        const pageSize = document.getElementById('pageSizeSelect')?.value || 'A4';
                        const orientation = document.getElementById('orientationSelect')?.value || 'portrait';
                        const margins = document.getElementById('marginsSelect')?.value || 'normal';
                        const headerText = document.getElementById('headerText')?.value || '';
                        const footerText = document.getElementById('footerText')?.value || '';
                        const showPageNumbers = document.getElementById('showPageNumbers')?.checked || false;
                        const showDate = document.getElementById('showDate')?.checked || false;

                        // Check if business formatting is enabled
                        const isBusinessFormatting = document.body.classList.contains('business-formatting-enabled');

                        // Render content with appropriate formatting
                        let htmlContent;
                        if (typeof MarkdownRenderer !== 'undefined') {
                            const renderer = new MarkdownRenderer();
                            htmlContent = renderer.render(currentContent, isBusinessFormatting);
                        } else {
                            // Fallback to simple HTML conversion
                            htmlContent = `<div class="${isBusinessFormatting ? 'business-document' : ''}">${currentContent.replace(/\n/g, '<br>')}</div>`;
                        }

                        // Export options
                        const exportOptions = {
                            title: 'ビジネスレポート',
                            pageSize: pageSize,
                            orientation: orientation,
                            margins: margins,
                            header: headerText,
                            footer: footerText,
                            showPageNumbers: showPageNumbers,
                            showDate: showDate,
                            businessFormatting: isBusinessFormatting,
                            includeHeaders: headerText || showDate,
                            includeFooters: footerText || showPageNumbers
                        };

                        // Record export start time for performance monitoring
                        const exportStartTime = performance.now();
                        
                        // Register with performance monitor if available
                        if (performanceDashboard && pdfExportManager.performanceManager) {
                            performanceDashboard.registerPerformanceManager(pdfExportManager.performanceManager);
                        }
                        
                        // Export to PDF
                        const success = await pdfExportManager.exportToPDF(htmlContent, exportOptions);
                        
                        // Record export time for performance monitoring
                        const exportTime = performance.now() - exportStartTime;
                        if (performanceDashboard) {
                            performanceDashboard.recordExportTime(exportTime, 'pdf');
                        }
                        
                        if (success && window.showButtonFeedback) {
                            window.showButtonFeedback(exportPdfBtn, 'PDF出力完了', 'success');
                        } else if (!success && window.showButtonFeedback) {
                            window.showButtonFeedback(exportPdfBtn, 'PDF出力失敗', 'error');
                        }

                    } catch (error) {
                        console.error('PDF export error:', error);
                        if (window.showButtonFeedback) {
                            window.showButtonFeedback(exportPdfBtn, 'PDF出力エラー', 'error');
                        }
                    } finally {
                        // Restore button state
                        exportPdfBtn.innerHTML = `
                            <svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14,2 14,8 20,8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                            </svg>
                            PDF出力
                        `;
                        exportPdfBtn.disabled = false;
                    }
                };
            }

            // Enhanced Word Export functionality with performance optimizations
            const exportWordBtn = document.getElementById('exportWordBtn');
            if (exportWordBtn && typeof OptimizedWordExportManager !== 'undefined') {
                const wordExportManager = new OptimizedWordExportManager({
                    defaultFilename: 'business-report',
                    businessFormatting: true,
                    enableLazyLoading: true,
                    enableCaching: true,
                    enableChunkedProcessing: true,
                    enableMemoryOptimization: true
                });

                exportWordBtn.onclick = async () => {
                    try {
                        // Show loading state
                        const originalHTML = exportWordBtn.innerHTML;
                        exportWordBtn.innerHTML = `
                            <svg class="icon animate-spin" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 12a9 9 0 11-6.219-8.56"/>
                            </svg>
                            Word出力中...
                        `;
                        exportWordBtn.disabled = true;

                        // Get current content and settings
                        const currentContent = window.getCurrentReportContent ? window.getCurrentReportContent() : content;
                        
                        // Get export settings (reuse PDF settings for consistency)
                        const pageSize = document.getElementById('pageSizeSelect')?.value || 'A4';
                        const orientation = document.getElementById('orientationSelect')?.value || 'portrait';
                        
                        // Get header/footer data
                        let headerFooterData = {};
                        if (window.headerFooterManager && window.headerFooterManager.getExportData) {
                            const exportData = window.headerFooterManager.getExportData();
                            headerFooterData = exportData.headerFooterData || {};
                        }

                        // Prepare HTML content for export
                        let htmlContent = currentContent;
                        if (typeof currentContent === 'string') {
                            // If it's markdown, convert to HTML first
                            if (window.markdownRenderer && window.markdownRenderer.renderToHTML) {
                                htmlContent = window.markdownRenderer.renderToHTML(currentContent);
                            }
                        }

                        // Export options
                        const exportOptions = {
                            title: 'ビジネスレポート',
                            pageSize: pageSize,
                            orientation: orientation,
                            includeHeaders: true,
                            includeFooters: true,
                            showPageNumbers: true,
                            showDate: false,
                            headerFooterData: headerFooterData,
                            businessFormatting: true,
                            convertRelativeUrls: true,
                            includeTimestamp: true
                        };

                        // Record export start time for performance monitoring
                        const exportStartTime = performance.now();
                        
                        // Register with performance monitor if available
                        if (performanceDashboard && wordExportManager.performanceManager) {
                            performanceDashboard.registerPerformanceManager(wordExportManager.performanceManager);
                        }
                        
                        // Export to Word
                        const success = await wordExportManager.exportToWord(htmlContent, exportOptions);
                        
                        // Record export time for performance monitoring
                        const exportTime = performance.now() - exportStartTime;
                        if (performanceDashboard) {
                            performanceDashboard.recordExportTime(exportTime, 'word');
                        }
                        
                        if (success && window.showButtonFeedback) {
                            window.showButtonFeedback(exportWordBtn, 'Word出力完了', 'success');
                        } else if (!success && window.showButtonFeedback) {
                            window.showButtonFeedback(exportWordBtn, 'Word出力失敗', 'error');
                        }

                    } catch (error) {
                        console.error('Word export error:', error);
                        if (window.showButtonFeedback) {
                            window.showButtonFeedback(exportWordBtn, 'Word出力エラー', 'error');
                        }
                    } finally {
                        // Restore button state
                        exportWordBtn.innerHTML = `
                            <svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14,2 14,8 20,8"></polyline>
                                <line x1="12" y1="18" x2="12" y2="12"></line>
                                <line x1="9" y1="15" x2="12" y2="12"></line>
                                <line x1="15" y1="15" x2="12" y2="12"></line>
                            </svg>
                            Word出力
                        `;
                        exportWordBtn.disabled = false;
                    }
                };
            }

            // Performance monitoring button functionality
            const performanceBtn = document.getElementById('performanceBtn');
            if (performanceBtn) {
                performanceBtn.onclick = () => {
                    if (performanceDashboard) {
                        performanceDashboard.toggle();
                    } else {
                        alert('パフォーマンス監視ダッシュボードが利用できません');
                    }
                };
            }

            // Print functionality
            const printBtn = document.getElementById('printBtn');
            if (printBtn) {
                printBtn.onclick = () => {
                    const currentContent = window.getCurrentReportContent ? window.getCurrentReportContent() : content;
                    
                    // Create a new window for printing
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>投資分析レポート - 印刷</title>
                            <meta charset="utf-8">
                            <style>
                                body {
                                    font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
                                    line-height: 1.6;
                                    margin: 0;
                                    padding: 20px;
                                    color: #333;
                                }
                                h1, h2, h3, h4, h5, h6 {
                                    color: #2c3e50;
                                    margin-top: 24px;
                                    margin-bottom: 16px;
                                    page-break-after: avoid;
                                }
                                h1 { font-size: 24px; border-bottom: 2px solid #3498db; padding-bottom: 8px; }
                                h2 { font-size: 20px; border-bottom: 1px solid #bdc3c7; padding-bottom: 4px; }
                                h3 { font-size: 18px; }
                                p { margin-bottom: 12px; }
                                ul, ol { margin-bottom: 12px; padding-left: 24px; }
                                li { margin-bottom: 4px; }
                                strong { color: #2c3e50; }
                                table { 
                                    border-collapse: collapse; 
                                    width: 100%; 
                                    margin: 16px 0;
                                    page-break-inside: avoid;
                                }
                                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                                th { background-color: #f8f9fa; font-weight: bold; }
                                .header { text-align: center; margin-bottom: 40px; }
                                .footer { 
                                    margin-top: 40px; 
                                    text-align: center; 
                                    font-size: 12px; 
                                    color: #666;
                                    page-break-inside: avoid;
                                }
                                @media print {
                                    body { margin: 0; padding: 15mm; }
                                    .no-print { display: none; }
                                    h1, h2, h3 { page-break-after: avoid; }
                                    table { page-break-inside: avoid; }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <h1>投資分析レポート</h1>
                                <p>生成日時: ${new Date().toLocaleString('ja-JP')}</p>
                            </div>
                            <div class="content">
                                ${markdownToHtml(currentContent)}
                            </div>
                            <div class="footer">
                                <p>このレポートは投資分析システムにより生成されました</p>
                            </div>
                        </body>
                        </html>
                    `);
                    printWindow.document.close();
                    
                    // Wait for content to load, then print
                    setTimeout(() => {
                        printWindow.print();
                    }, 500);
                    
                    if (window.showButtonFeedback) {
                        window.showButtonFeedback(printBtn, '印刷中', 'success');
                    }
                };
            }
        }

        // Format Tools Functions
        function toggleFormatTools() {
            const toolbar = document.getElementById('formatToolsBar');
            const button = document.getElementById('formatToolsBtn');
            
            if (toolbar.classList.contains('hidden')) {
                toolbar.classList.remove('hidden');
                button.textContent = '書式非表示';
            } else {
                toolbar.classList.add('hidden');
                button.textContent = '書式設定';
            }
        }

        function applyBold() {
            document.execCommand('bold', false, null);
            updateMarkdownFromEditor();
        }

        function applyItalic() {
            document.execCommand('italic', false, null);
            updateMarkdownFromEditor();
        }

        function applyHighlight() {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');
                span.className = 'highlight';
                try {
                    range.surroundContents(span);
                    updateMarkdownFromEditor();
                } catch (e) {
                    // Fallback for complex selections
                    document.execCommand('hiliteColor', false, '#ffeb3b');
                    updateMarkdownFromEditor();
                }
            }
        }

        function resetFormat() {
            const editor = document.getElementById('reportContent');
            
            // Reset to default styles
            editor.style.fontSize = '14px';
            editor.style.lineHeight = '1.8';
            editor.classList.remove('theme-dark', 'theme-sepia', 'theme-high-contrast');
            
            // Reset select values
            document.getElementById('fontSizeSelect').value = '14px';
            document.getElementById('lineHeightSelect').value = '1.8';
            document.getElementById('themeSelect').value = 'default';
            
            // Remove inline formatting
            const content = editor.innerHTML;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            
            // Remove formatting tags but keep structure
            const formattedContent = tempDiv.textContent || tempDiv.innerText || '';
            editor.innerHTML = markdownToHtml(formattedContent);
            
            updateMarkdownFromEditor();
        }

        function handlePaste(event) {
            event.preventDefault();
            const text = (event.clipboardData || window.clipboardData).getData('text');
            document.execCommand('insertText', false, text);
            updateMarkdownFromEditor();
        }

        function updateWordCount() {
            // Word count functionality removed - this is now a no-op function
            // to prevent errors from existing references
            return;
        }

        function updateMarkdownFromEditor() {
            // Markdown conversion functionality removed
            return;
        }

        function htmlToMarkdown(html) {
            // Simple HTML to Markdown conversion
            let markdown = html
                .replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n\n')
                .replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n\n')
                .replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n\n')
                .replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**')
                .replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**')
                .replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*')
                .replace(/<i[^>]*>(.*?)<\/i>/gi, '*$1*')
                .replace(/<span class="highlight"[^>]*>(.*?)<\/span>/gi, '==$1==')
                .replace(/<p[^>]*>(.*?)<\/p>/gi, '$1\n\n')
                .replace(/<br[^>]*>/gi, '\n')
                .replace(/<li[^>]*>(.*?)<\/li>/gi, '- $1\n')
                .replace(/<ul[^>]*>(.*?)<\/ul>/gi, '$1\n')
                .replace(/<ol[^>]*>(.*?)<\/ol>/gi, '$1\n')
                .replace(/<[^>]+>/g, '') // Remove remaining HTML tags
                .replace(/\n\s*\n\s*\n/g, '\n\n') // Clean up extra newlines
                .trim();
            
            return markdown;
        }

        // Google Docs Export Function
        function exportToGoogleDocs() {
            const editor = document.getElementById('reportContent');
            const content = editor.innerHTML;
            const title = 'Investment Analysis Report';
            
            // Create a clean HTML document for Google Docs
            const cleanHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="utf-8">
                    <title>${title}</title>
                    <style>
                        body {
                            font-family: 'Arial', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
                            line-height: 1.6;
                            margin: 40px;
                            color: #333;
                        }
                        h1, h2, h3 { color: #2c3e50; margin-top: 24px; }
                        h1 { font-size: 24px; border-bottom: 2px solid #3498db; padding-bottom: 8px; }
                        h2 { font-size: 20px; }
                        h3 { font-size: 18px; }
                        p { margin-bottom: 12px; }
                        ul, ol { margin-bottom: 12px; padding-left: 24px; }
                        li { margin-bottom: 4px; }
                        .highlight { background-color: #ffeb3b; padding: 2px 4px; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <p><em>Generated on: ${new Date().toLocaleString('ja-JP')}</em></p>
                    ${content}
                </body>
                </html>
            `;
            
            // Create blob and download
            const blob = new Blob([cleanHtml], { type: 'text/html; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `investment-report-${new Date().toISOString().slice(0, 10)}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Show instructions for Google Docs import
            setTimeout(() => {
                alert(`HTMLファイルがダウンロードされました。\n\nGoogle Docsで開く方法:\n1. Google Docsを開く\n2. 「ファイル」→「インポート」を選択\n3. ダウンロードしたHTMLファイルを選択\n4. 「インポート」をクリック\n\nこれでGoogle Docsで編集できます！`);
            }, 500);
            
            if (window.showButtonFeedback) {
                window.showButtonFeedback(document.getElementById('exportGoogleDocsBtn'), 'エクスポート完了', 'success');
            }
        }

        // Enhanced getCurrentReportContent function
        window.getCurrentReportContent = function() {
            const editor = document.getElementById('reportContent');
            
            // Return content from textarea
            if (editor && editor.value) {
                return editor.value;
            }
            return '';
        };

        // Markdown to HTML converter for PDF/Print functionality
        function markdownToHtml(markdown) {
            if (!markdown) return '';
            
            let html = markdown
                // Headers
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                
                // Bold and Italic
                .replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                
                // Lists
                .replace(/^\* (.*$)/gim, '<li>$1</li>')
                .replace(/^- (.*$)/gim, '<li>$1</li>')
                .replace(/^\d+\. (.*$)/gim, '<li>$1</li>')
                
                // Line breaks
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            // Wrap in paragraphs
            html = '<p>' + html + '</p>';
            
            // Fix lists
            html = html.replace(/(<li>.*?<\/li>)/gs, (match) => {
                return '<ul>' + match + '</ul>';
            });
            
            // Clean up empty paragraphs
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p><br><\/p>/g, '');
            
            return html;
        }

        // Custom Prompt Management - Disabled for trial
        document.getElementById('savePromptBtn').addEventListener('click', function() {
            window.errorHandler.showNotification('プロンプト保存機能は有料版で利用可能です', 'warning', 3000);
        });
        
        document.getElementById('loadPromptBtn').addEventListener('click', function() {
            window.errorHandler.showNotification('プロンプト読込機能は有料版で利用可能です', 'warning', 3000);
        });

        // Trial and Upgrade Management
        function showTrialExpiredModal(trialInfo) {
            document.getElementById('trialExpiredModal').classList.remove('hidden');
            
            // Disable the main form
            const reportForm = document.getElementById('reportForm');
            const formElements = reportForm.querySelectorAll('input, textarea, select, button');
            formElements.forEach(element => {
                element.disabled = true;
            });
        }

        function showUpgradeModal() {
            document.getElementById('upgradeModal').classList.remove('hidden');
            // Close trial expired modal if open
            document.getElementById('trialExpiredModal').classList.add('hidden');
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.add('hidden');
        }

        function selectPlan(planType) {
            // In a real implementation, this would integrate with a payment processor
            alert(`${planType}プランが選択されました。\n\n実装時には決済システム（Stripe等）に連携します。`);
            
            // For demo purposes, simulate upgrade
            if (confirm('デモ用：アップグレードをシミュレートしますか？')) {
                simulateUpgrade(planType);
            }
        }

        function contactSales() {
            // In a real implementation, this would open a contact form or redirect to sales
            alert('営業チームへのお問い合わせフォームを開きます。\n\n実装時には適切な連絡先に誘導します。');
        }

        async function simulateUpgrade(planType) {
            try {
                // Trial site - disable upgrade API calls to prevent authentication errors
                console.log('Trial mode - upgrade functionality disabled');
                window.errorHandler.showNotification('Trial mode - upgrade functionality disabled', 'info', 3000);
                closeUpgradeModal();
                return;
                
                // Original upgrade code disabled to prevent authentication errors
                /*
                const response = await fetch('/api/trial/upgrade', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ planType })
                });
                */

                if (response.ok) {
                    window.errorHandler.showNotification('アップグレードが完了しました！', 'success', 3000);
                    closeUpgradeModal();
                    
                    // Re-enable the form
                    const reportForm = document.getElementById('reportForm');
                    const formElements = reportForm.querySelectorAll('input, textarea, select, button');
                    formElements.forEach(element => {
                        element.disabled = false;
                    });
                    
                    // Refresh trial status - Disabled for trial site to prevent auth errors
                    try {
                        // await checkAndDisplayTrialStatus(); // Disabled to prevent 400 errors
                        console.log('Trial status refresh disabled for trial site');
                    } catch (error) {
                        // Suppress any authentication-related errors
                        console.log('Trial mode - authentication disabled');
                    }
                } else {
                    throw new Error('Upgrade failed');
                }
            } catch (error) {
                console.error('Upgrade error:', error);
                showError('アップグレード処理中にエラーが発生しました');
            }
        }

        // Enhanced error handling for trial limits and API responses
        async function handleApiError(response, result) {
            // Check for trial expiration
            if (result && result.code === 'TRIAL_EXPIRED') {
                showTrialExpiredModal(result.trialInfo);
                throw new Error(result.error);
            }
            
            // Check for no input provided
            if (result && result.code === 'NO_INPUT_PROVIDED') {
                showError('テキストまたはファイルを入力してください');
                throw new Error(result.error);
            }
            
            // Handle other API errors
            if (!response.ok) {
                console.error('API Error Details:', {
                    status: response.status,
                    statusText: response.statusText,
                    result: result,
                    error: result?.error
                });
                
                let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                
                if (result?.error) {
                    if (typeof result.error === 'string') {
                        errorMessage = result.error;
                    } else if (result.error.message) {
                        errorMessage = result.error.message;
                    } else {
                        errorMessage = JSON.stringify(result.error);
                    }
                }
                
                showError(`エラーが発生しました: ${errorMessage}`);
                throw new Error(errorMessage);
            }
            
            return result;
        }

        // User Token Stats - Disabled for trial site
        async function loadUserTokenStats() {
            try {
                // Trial site - skip authentication-based token stats
                const statsDiv = document.getElementById('userTokenStats');
                if (statsDiv) {
                    statsDiv.innerHTML = '<div style="text-align: center; color: var(--color-gray-500);">Trial mode - token stats disabled</div>';
                }
                return;
                
                // Original authentication code disabled to prevent 400 errors
                /*
                const response = await fetch('/api/user/token-usage?timeRange=30', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        displayUserTokenStats(result.usage);
                    }
                } else {
                    document.getElementById('userTokenStats').innerHTML = 
                        '<div style="text-align: center; color: var(--color-gray-500);">Token使用量を取得できませんでした</div>';
                }
                */
            } catch (error) {
                // Suppress authentication errors in trial mode
                console.log('Trial mode - authentication disabled');
                const statsDiv = document.getElementById('userTokenStats');
                if (statsDiv) {
                    statsDiv.innerHTML = '<div style="text-align: center; color: var(--color-gray-500);">Trial mode - token stats disabled</div>';
                }
            }
        }

        function displayUserTokenStats(usage) {
            const statsDiv = document.getElementById('userTokenStats');
            const avgCost = usage.totalRecords > 0 ? (usage.totalCost / usage.totalRecords).toFixed(4) : '0.0000';
            
            statsDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: var(--space-3); text-align: center;">
                    <div>
                        <div style="font-weight: 600;">${usage.totalRecords.toLocaleString()}</div>
                        <div style="font-size: var(--font-size-xs); opacity: 0.8;">レポート生成数</div>
                    </div>
                    <div>
                        <div style="font-weight: 600;">${usage.totalTokens.toLocaleString()}</div>
                        <div style="font-size: var(--font-size-xs); opacity: 0.8;">総Token数</div>
                    </div>
                    <div>
                        <div style="font-weight: 600;">$${parseFloat(usage.totalCost).toFixed(4)}</div>
                        <div style="font-size: var(--font-size-xs); opacity: 0.8;">推定コスト</div>
                    </div>
                    <div>
                        <div style="font-weight: 600;">$${avgCost}</div>
                        <div style="font-size: var(--font-size-xs); opacity: 0.8;">平均コスト</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: var(--space-2); font-size: var(--font-size-xs); opacity: 0.7;">
                    過去30日間の使用量
                </div>
            `;
        }

        // Enhanced Progress Utilities
        function adjustProgressSpeed(filesCount, inputLength) {
            // Adjust estimated duration based on input complexity
            let baseDuration = 30000; // 30 seconds base
            
            // Add time for files
            baseDuration += filesCount * 5000; // 5 seconds per file
            
            // Add time for long text
            if (inputLength > 1000) {
                baseDuration += Math.min((inputLength - 1000) / 100 * 1000, 15000); // Up to 15 extra seconds
            }
            
            progressState.estimatedDuration = Math.min(baseDuration, 90000); // Max 90 seconds
            console.log(`Adjusted progress duration to ${progressState.estimatedDuration}ms`);
        }

        function handleProgressError(error) {
            hideDetailedProgress();
            
            // Update status to show error state
            const statusText = document.getElementById('statusText');
            if (statusText) {
                statusText.textContent = 'エラーが発生しました';
            }
            
            // Mark current step as failed
            const activeStep = document.querySelector('.progress-step.active');
            if (activeStep) {
                activeStep.classList.remove('active');
                activeStep.classList.add('error');
                
                const icon = activeStep.querySelector('.step-icon');
                if (icon) {
                    icon.style.borderColor = 'var(--color-error)';
                    icon.style.background = 'var(--color-error)';
                    icon.innerHTML = '✕';
                }
            }
            
            setTimeout(() => {
                hideStatus();
            }, 3000);
        }

        // Progress state management
        function getProgressState() {
            return { ...progressState };
        }

        function isProgressActive() {
            return progressState.isActive;
        }

        // Enhanced error handling for long requests
        function handleLongRunningRequest() {
            // Show additional message after 30 seconds
            setTimeout(() => {
                if (progressState.isActive) {
                    const statusText = document.getElementById('statusText');
                    if (statusText) {
                        statusText.textContent = 'レポート生成には時間がかかる場合があります...';
                    }
                    
                    window.errorHandler.showNotification(
                        '複雑なレポートのため、通常より時間がかかっています', 
                        'info', 
                        5000
                    );
                }
            }, 30000);
            
            // Show patience message after 60 seconds
            setTimeout(() => {
                if (progressState.isActive) {
                    window.errorHandler.showNotification(
                        'もうしばらくお待ちください。高品質なレポートを生成中です', 
                        'info', 
                        5000
                    );
                }
            }, 60000);
        }

        // Format control functions
        function applyFontSize() {
            const fontSize = document.getElementById('fontSizeSelect').value;
            const textarea = document.getElementById('reportContent');
            if (textarea) {
                textarea.style.fontSize = fontSize;
            }
        }

        function applyLineHeight() {
            const lineHeight = document.getElementById('lineHeightSelect').value;
            const textarea = document.getElementById('reportContent');
            if (textarea) {
                textarea.style.lineHeight = lineHeight;
            }
        }

        function applyTheme() {
            const theme = document.getElementById('themeSelect').value;
            const textarea = document.getElementById('reportContent');
            if (textarea) {
                switch(theme) {
                    case 'dark':
                        textarea.style.background = '#1f2937';
                        textarea.style.color = '#f9fafb';
                        break;
                    case 'sepia':
                        textarea.style.background = '#fef7ed';
                        textarea.style.color = '#92400e';
                        break;
                    default:
                        textarea.style.background = 'white';
                        textarea.style.color = '#374151';
                }
            }
        }

        function toggleEditMode() {
            const textarea = document.getElementById('reportContent');
            const btn = document.getElementById('editModeBtn');
            if (textarea && btn) {
                if (textarea.readOnly) {
                    textarea.readOnly = false;
                    btn.textContent = '読み取り専用';
                    btn.style.background = '#ef4444';
                } else {
                    textarea.readOnly = true;
                    btn.textContent = '編集モード';
                    btn.style.background = '#3b82f6';
                }
            }
        }

        function toggleBusinessFormatting() {
            const btn = document.getElementById('businessFormatBtn');
            const pdfControls = document.getElementById('pdfExportControls');
            const isEnabled = document.body.classList.contains('business-formatting-enabled');
            
            if (isEnabled) {
                // Disable business formatting
                document.body.classList.remove('business-formatting-enabled');
                if (btn) {
                    btn.textContent = 'ビジネス書式';
                    btn.style.background = '#059669';
                }
                if (pdfControls) {
                    pdfControls.style.display = 'none';
                }
                
                // Remove business styling from content
                const contentElements = document.querySelectorAll('.business-document, .business-styled');
                contentElements.forEach(el => {
                    el.classList.remove('business-document', 'business-styled');
                });
                
            } else {
                // Enable business formatting
                document.body.classList.add('business-formatting-enabled');
                if (btn) {
                    btn.textContent = '標準書式';
                    btn.style.background = '#dc2626';
                }
                if (pdfControls) {
                    pdfControls.style.display = 'block';
                }
                
                // Apply business styling to content
                const reportContent = document.getElementById('reportContent');
                const reportPreview = document.getElementById('reportPreview');
                
                if (reportContent && reportContent.value) {
                    // Re-render content with business formatting
                    updateReportPreview(reportContent.value, true);
                }

        // Template selection system variables
        let templateSystem = null;
        let documentFormatter = null;

        // Initialize template system
        function initializeTemplateSystem() {
            try {
                // Check for required dependencies
                if (typeof TemplateSelectionSystem === 'undefined') {
                    console.warn('TemplateSelectionSystem not available, skipping template system initialization');
                    return false;
                }
                
                if (typeof BusinessDocumentFormatter === 'undefined') {
                    console.warn('BusinessDocumentFormatter not available, skipping template system initialization');
                    return false;
                }
                
                // Initialize template system
                templateSystem = new TemplateSelectionSystem();
                documentFormatter = new BusinessDocumentFormatter();
                
                templateSystem.initialize({
                    onTemplateChange: handleTemplateChange
                });
                
                console.log('Template system initialized successfully');
                return true;
            } catch (error) {
                console.warn('Failed to initialize template system:', error.message);
                return false;
            }
        }

        // Apply document template
        function applyDocumentTemplate() {
            const templateSelect = document.getElementById('templateSelect');
            if (!templateSelect || !templateSystem) return;
            
            const selectedTemplate = templateSelect.value;
            const reportContent = document.getElementById('reportContent');
            const reportPreview = document.getElementById('reportPreview');
            
            // Apply template to preview if it exists
            if (reportPreview) {
                templateSystem.applyTemplate(selectedTemplate, reportPreview);
                if (documentFormatter) {
                    documentFormatter.applyStandardStyling(reportPreview);
                }
            }
            
            // Apply template to main content area
            if (reportContent && reportContent.value) {
                updateReportPreview(reportContent.value, true);
            }
            
            console.log(`Applied template: ${selectedTemplate}`);
        }

        // Handle template change
        function handleTemplateChange(templateName, template, previousTemplate) {
            console.log(`Template changed from ${previousTemplate} to ${templateName}`);
            
            // Update any preview content
            const reportPreview = document.getElementById('reportPreview');
            if (reportPreview && documentFormatter) {
                documentFormatter.applyStandardStyling(reportPreview);
            }
        }

        // Show template preview modal
        function showTemplatePreview() {
            if (!templateSystem) {
                alert('テンプレートシステムが初期化されていません');
                return;
            }
            
            const templates = templateSystem.getTemplates();
            const currentTemplate = templateSystem.getCurrentTemplateName();
            
            let modalContent = `
                <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
                    <h2 style="text-align: center; margin-bottom: 20px;">テンプレート詳細</h2>
                    <div style="display: grid; gap: 20px;">
            `;
            
            Object.keys(templates).forEach(templateName => {
                const template = templates[templateName];
                const isActive = templateName === currentTemplate;
                
                modalContent += `
                    <div style="border: 2px solid ${isActive ? '#3b82f6' : '#e5e7eb'}; border-radius: 8px; padding: 16px; ${isActive ? 'background: #eff6ff;' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h3 style="margin: 0; color: ${isActive ? '#1e40af' : '#1f2937'};">${template.name}</h3>
                            ${isActive ? '<span style="background: #3b82f6; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">選択中</span>' : ''}
                        </div>
                        <p style="margin: 8px 0; color: #6b7280; font-size: 14px;">${template.description}</p>
                        <div style="margin: 12px 0;">
                            <strong>特徴:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px; font-size: 14px;">
                                <li>フォント: ${template.styles.fontFamily === 'serif' ? 'セリフ体 (Times New Roman)' : 'サンセリフ体 (Arial)'}</li>
                                <li>配置: ${template.styles.textAlign === 'justify' ? '両端揃え' : '左揃え'}</li>
                                <li>行間: ${template.styles.lineHeight === 'tight' ? '狭い' : template.styles.lineHeight === 'relaxed' ? '広い' : '標準'}</li>
                            </ul>
                        </div>
                        ${!isActive ? `<button onclick="selectTemplateFromPreview('${templateName}')" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">このテンプレートを選択</button>` : ''}
                    </div>
                `;
            });
            
            modalContent += `
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="closeTemplatePreview()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">閉じる</button>
                    </div>
                </div>
            `;
            
            // Create and show modal
            const modal = document.createElement('div');
            modal.id = 'templatePreviewModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            const modalDialog = document.createElement('div');
            modalDialog.style.cssText = `
                background: white;
                border-radius: 8px;
                max-width: 90vw;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            `;
            modalDialog.innerHTML = modalContent;
            
            modal.appendChild(modalDialog);
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeTemplatePreview();
                }
            });
        }

        // Select template from preview modal
        function selectTemplateFromPreview(templateName) {
            const templateSelect = document.getElementById('templateSelect');
            if (templateSelect) {
                templateSelect.value = templateName;
                applyDocumentTemplate();
            }
            closeTemplatePreview();
        }

        // Close template preview modal
        function closeTemplatePreview() {
            const modal = document.getElementById('templatePreviewModal');
            if (modal) {
                modal.remove();
            }
        }
            }
        }

        function updateReportPreview(content, useBusinessFormatting = false) {
            const reportPreview = document.getElementById('reportPreview');
            if (!reportPreview || !content) return;

            try {
                if (typeof MarkdownRenderer !== 'undefined') {
                    const renderer = new MarkdownRenderer();
                    const html = renderer.render(content, useBusinessFormatting);
                    reportPreview.innerHTML = html;
                } else {
                    // Fallback rendering
                    const className = useBusinessFormatting ? 'business-document' : '';
                    reportPreview.innerHTML = `<div class="${className}">${content.replace(/\n/g, '<br>')}</div>`;
                }

                // Apply template styling if template system is available
                if (templateSystem && useBusinessFormatting) {
                    const templateSelect = document.getElementById('templateSelect');
                    const selectedTemplate = templateSelect ? templateSelect.value : 'simple';
                    
                    // Apply current template to the preview
                    templateSystem.applyTemplate(selectedTemplate, reportPreview);
                    
                    // Apply business document formatting
                    if (documentFormatter) {
                        documentFormatter.applyStandardStyling(reportPreview);
                    }
                }
            } catch (error) {
                console.error('Error updating report preview:', error);
                reportPreview.innerHTML = `<div class="error">プレビューの更新に失敗しました: ${error.message}</div>`;
            }
        }

        // Performance Optimization Variables
        let performanceManager = null;
        let optimizedPdfExporter = null;
        let optimizedWordExporter = null;
        let performanceDashboard = null;
        
        // Initialize Header/Footer Manager
        let headerFooterManager = null;
        
        // Initialize performance optimization system
        function initializePerformanceOptimizations() {
            try {
                // Initialize performance monitoring dashboard
                if (typeof PerformanceMonitorDashboard !== 'undefined') {
                    performanceDashboard = new PerformanceMonitorDashboard({
                        position: 'bottom-right',
                        autoHide: true,
                        autoHideDelay: 10000,
                        showMemoryChart: true,
                        showCacheMetrics: true,
                        showLibraryMetrics: true,
                        minimized: true
                    });
                    
                    // Add keyboard shortcut to toggle performance monitor (Ctrl+Shift+P)
                    document.addEventListener('keydown', function(e) {
                        if (e.ctrlKey && e.shiftKey && e.key === 'P') {
                            e.preventDefault();
                            performanceDashboard.toggle();
                        }
                    });
                    
                    console.log('Performance monitoring dashboard initialized (Ctrl+Shift+P to toggle)');
                } else {
                    console.warn('PerformanceMonitorDashboard not available');
                }
                
                // Preload export libraries for better performance
                if (typeof PerformanceOptimizationManager !== 'undefined') {
                    const preloadManager = new PerformanceOptimizationManager({
                        lazyLoadThreshold: 50,
                        preloadDelay: 3000
                    });
                    
                    // Preload PDF and Word libraries after a delay
                    setTimeout(() => {
                        preloadManager.preloadLibraries('all');
                    }, 3000);
                    
                    console.log('Library preloading scheduled');
                }
                
            } catch (error) {
                console.error('Failed to initialize performance optimizations:', error);
            }
        }

        // Initialize performance optimizations and other managers when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize performance optimization system
            initializePerformanceOptimizations();
            
            // Initialize existing managers
            try {
                if (typeof HeaderFooterManager !== 'undefined') {
                    headerFooterManager = new HeaderFooterManager({
                        enableLogo: true,
                        enablePageNumbers: true,
                        enableDateInsertion: true,
                        defaultHeaderText: '',
                        defaultFooterText: '',
                        logoMaxWidth: 120,
                        logoMaxHeight: 40
                    });
                    
                    console.log('Header/Footer Manager initialized successfully');
                    
                    // Make it globally accessible
                    window.headerFooterManager = headerFooterManager;
                } else {
                    console.warn('HeaderFooterManager not available');
                }
            } catch (error) {
                console.error('Failed to initialize Header/Footer Manager:', error);
            }

            // Initialize template system
            try {
                if (typeof initializeTemplateSystem === 'function') {
                    if (initializeTemplateSystem()) {
                        console.log('Template system initialized successfully');
                        
                        // Apply default template
                        setTimeout(() => {
                            if (typeof applyDocumentTemplate === 'function') {
                                applyDocumentTemplate();
                            }
                        }, 100);
                    } else {
                        console.warn('Template system dependencies not available, continuing without template system');
                    }
                } else {
                    console.warn('initializeTemplateSystem function not defined, continuing without template system');
                }
            } catch (error) {
                console.error('Failed to initialize Template System:', error);
            }
        });

        // Make functions globally accessible
        window.removeFile = removeFile;
        window.showDetailedProgress = showDetailedProgress;
        window.hideDetailedProgress = hideDetailedProgress;
        window.cancelProgress = cancelProgress;
        window.getProgressState = getProgressState;
        window.isProgressActive = isProgressActive;
        window.applyFontSize = applyFontSize;
        window.applyLineHeight = applyLineHeight;
        window.applyTheme = applyTheme;
        window.toggleEditMode = toggleEditMode;
        window.toggleBusinessFormatting = toggleBusinessFormatting;
        window.updateReportPreview = updateReportPreview;
        window.applyDocumentTemplate = applyDocumentTemplate;
        window.showTemplatePreview = showTemplatePreview;
        window.selectTemplateFromPreview = selectTemplateFromPreview;
        window.closeTemplatePreview = closeTemplatePreview;
    </script>
</body>
</html>
