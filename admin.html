<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理ダッシュボード - クライアント向けレポート生成</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>管理ダッシュボード</h1>
            <p>システム使用状況とユーザー統計</p>
        </header>

        <!-- Stats Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-6); margin-bottom: var(--space-8);">
            <div class="card">
                <h3 style="color: var(--color-primary); margin-bottom: var(--space-2);">総ユーザー数</h3>
                <div id="totalUsers" style="font-size: var(--font-size-3xl); font-weight: 700; color: var(--color-gray-900);">-</div>
            </div>
            <div class="card">
                <h3 style="color: var(--color-primary); margin-bottom: var(--space-2);">総リクエスト数</h3>
                <div id="totalRequests" style="font-size: var(--font-size-3xl); font-weight: 700; color: var(--color-gray-900);">-</div>
            </div>
            <div class="card">
                <h3 style="color: var(--color-primary); margin-bottom: var(--space-2);">生成レポート数</h3>
                <div id="totalReports" style="font-size: var(--font-size-3xl); font-weight: 700; color: var(--color-gray-900);">-</div>
            </div>
            <div class="card">
                <h3 style="color: var(--color-primary); margin-bottom: var(--space-2);">総ファイル数</h3>
                <div id="totalFiles" style="font-size: var(--font-size-3xl); font-weight: 700; color: var(--color-gray-900);">-</div>
            </div>
        </div>

        <!-- Usage Chart -->
        <div class="card">
            <h2 style="margin-bottom: var(--space-6); color: var(--color-gray-900);">過去30日の使用状況</h2>
            <div id="usageChart" style="height: 300px; display: flex; align-items: center; justify-content: center; color: var(--color-gray-500);">
                データを読み込み中...
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="card">
            <h2 style="margin-bottom: var(--space-6); color: var(--color-gray-900);">最近のアクティビティ</h2>
            <div id="recentActivity" style="color: var(--color-gray-500);">
                データを読み込み中...
            </div>
        </div>

        <!-- Logout Button -->
        <div style="text-align: center; margin-top: var(--space-8);">
            <button onclick="logout()" class="btn btn-secondary">
                ログアウト
            </button>
        </div>
    </div>

    <script type="module">
        let currentUser = null;
        
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/me', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    currentUser = result.user;
                    
                    if (currentUser.role !== 'admin') {
                        alert('管理者権限が必要です');
                        window.location.href = '/';
                        return;
                    }
                    
                    loadDashboardData();
                } else {
                    window.location.href = '/login.html';
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/login.html';
            }
        }

        async function loadDashboardData() {
            try {
                // Load usage stats
                const statsResponse = await fetch('/api/admin/stats', {
                    credentials: 'include'
                });
                
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    updateStatsDisplay(stats);
                }

                // Load usage chart data
                const chartResponse = await fetch('/api/admin/usage-chart', {
                    credentials: 'include'
                });
                
                if (chartResponse.ok) {
                    const chartData = await chartResponse.json();
                    updateUsageChart(chartData);
                }

                // Load recent activity
                const activityResponse = await fetch('/api/admin/recent-activity', {
                    credentials: 'include'
                });
                
                if (activityResponse.ok) {
                    const activity = await activityResponse.json();
                    updateRecentActivity(activity);
                }

            } catch (error) {
                console.error('Failed to load dashboard data:', error);
            }
        }

        function updateStatsDisplay(stats) {
            document.getElementById('totalUsers').textContent = stats.total_users || 0;
            document.getElementById('totalRequests').textContent = stats.total_requests || 0;
            document.getElementById('totalReports').textContent = stats.total_reports || 0;
            document.getElementById('totalFiles').textContent = stats.total_files || 0;
        }

        function updateUsageChart(data) {
            const chartContainer = document.getElementById('usageChart');
            
            if (!data || data.length === 0) {
                chartContainer.innerHTML = '<p>データがありません</p>';
                return;
            }

            // Simple text-based chart for now
            let chartHTML = '<div style="display: flex; flex-direction: column; gap: var(--space-2); width: 100%;">';
            
            data.forEach(day => {
                const barWidth = Math.max(10, (day.total_requests / Math.max(...data.map(d => d.total_requests))) * 100);
                chartHTML += `
                    <div style="display: flex; align-items: center; gap: var(--space-3);">
                        <div style="min-width: 80px; font-size: var(--font-size-sm);">${day.date}</div>
                        <div style="flex: 1; background: var(--color-gray-200); height: 20px; border-radius: var(--radius-sm); position: relative;">
                            <div style="background: var(--color-primary); height: 100%; width: ${barWidth}%; border-radius: var(--radius-sm);"></div>
                        </div>
                        <div style="min-width: 60px; font-size: var(--font-size-sm); text-align: right;">${day.total_requests}</div>
                    </div>
                `;
            });
            
            chartHTML += '</div>';
            chartContainer.innerHTML = chartHTML;
        }

        function updateRecentActivity(activities) {
            const container = document.getElementById('recentActivity');
            
            if (!activities || activities.length === 0) {
                container.innerHTML = '<p>最近のアクティビティはありません</p>';
                return;
            }

            let activityHTML = '<div style="display: flex; flex-direction: column; gap: var(--space-3);">';
            
            activities.forEach(activity => {
                const timeAgo = getTimeAgo(activity.created_at);
                activityHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-3); background: var(--color-gray-50); border-radius: var(--radius-md);">
                        <div>
                            <strong>${activity.action}</strong>
                            ${activity.report_type ? ` - ${activity.report_type}` : ''}
                        </div>
                        <div style="font-size: var(--font-size-sm); color: var(--color-gray-500);">${timeAgo}</div>
                    </div>
                `;
            });
            
            activityHTML += '</div>';
            container.innerHTML = activityHTML;
        }

        function getTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'たった今';
            if (diffMins < 60) return `${diffMins}分前`;
            if (diffHours < 24) return `${diffHours}時間前`;
            return `${diffDays}日前`;
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/login.html';
            } catch (error) {
                console.error('Logout failed:', error);
                window.location.href = '/login.html';
            }
        }

        // Check authentication on page load
        checkAuth();
    </script>
</body>
</html>
