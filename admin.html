<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理ダッシュボード - クライアント向けレポート生成</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="/lib/frontend-error-handler.js"></script>
    <script>
        // Ensure errorHandler is available
        if (typeof window.errorHandler === 'undefined') {
            console.warn('ErrorHandler not loaded, creating fallback');
            window.errorHandler = {
                handleError: (error, context, showNotification = true) => {
                    console.error(`Error in ${context}:`, error);
                },
                handleApiResponse: async (response, context) => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response;
                },
                showLoading: (button, text) => {
                    if (button) {
                        button.disabled = true;
                        button.dataset.originalText = button.textContent;
                        button.textContent = text || 'Loading...';
                    }
                },
                hideLoading: (button) => {
                    if (button) {
                        button.disabled = false;
                        button.textContent = button.dataset.originalText || button.textContent;
                    }
                },
                showNotification: (message, type, duration) => {
                    console.log(`${type.toUpperCase()}: ${message}`);
                },
                getUserFriendlyMessage: (error, context) => {
                    return error.message || 'エラーが発生しました';
                }
            };
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
                <div>
                    <h1>管理ダッシュボード</h1>
                    <p>システム使用状況とユーザー統計</p>
                </div>
                <div style="display: flex; gap: var(--space-3);">
                    <button onclick="window.location.href='admin-usage-dashboard.html'" class="btn btn-primary">
                        📊 Usage Analytics
                    </button>
                    <button onclick="window.location.href='admin.html'" class="btn btn-secondary">
                        🏠 Dashboard
                    </button>
                </div>
            </div>
        </header>

        <!-- Stats Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-6); margin-bottom: var(--space-8);">
            <div class="card">
                <h3 style="color: var(--color-primary); margin-bottom: var(--space-2);">総ユーザー数</h3>
                <div id="totalUsers" style="font-size: var(--font-size-3xl); font-weight: 700; color: var(--color-gray-900);">-</div>
            </div>
            <div class="card">
                <h3 style="color: var(--color-primary); margin-bottom: var(--space-2);">総リクエスト数</h3>
                <div id="totalRequests" style="font-size: var(--font-size-3xl); font-weight: 700; color: var(--color-gray-900);">-</div>
            </div>
            <div class="card">
                <h3 style="color: var(--color-primary); margin-bottom: var(--space-2);">生成レポート数</h3>
                <div id="totalReports" style="font-size: var(--font-size-3xl); font-weight: 700; color: var(--color-gray-900);">-</div>
            </div>
            <div class="card">
                <h3 style="color: var(--color-primary); margin-bottom: var(--space-2);">総ファイル数</h3>
                <div id="totalFiles" style="font-size: var(--font-size-3xl); font-weight: 700; color: var(--color-gray-900);">-</div>
            </div>
        </div>

        <!-- User Statistics -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-8);">
            <div class="card">
                <h3 style="color: var(--color-purple-600); margin-bottom: var(--space-2);">管理者</h3>
                <div id="adminUsers" style="font-size: var(--font-size-xl); font-weight: 700; color: var(--color-gray-900);">-</div>
            </div>
            <div class="card">
                <h3 style="color: var(--color-blue-600); margin-bottom: var(--space-2);">チームメンバー</h3>
                <div id="teamMembers" style="font-size: var(--font-size-xl); font-weight: 700; color: var(--color-gray-900);">-</div>
            </div>
            <div class="card">
                <h3 style="color: var(--color-orange-600); margin-bottom: var(--space-2);">試用ユーザー</h3>
                <div id="trialUsers" style="font-size: var(--font-size-xl); font-weight: 700; color: var(--color-gray-900);">-</div>
            </div>
            <div class="card">
                <h3 style="color: var(--color-green-600); margin-bottom: var(--space-2);">有料ユーザー</h3>
                <div id="activeSubscriptions" style="font-size: var(--font-size-xl); font-weight: 700; color: var(--color-gray-900);">-</div>
            </div>
            <div class="card">
                <h3 style="color: var(--color-red-600); margin-bottom: var(--space-2);">期限切れ試用</h3>
                <div id="expiredTrials" style="font-size: var(--font-size-xl); font-weight: 700; color: var(--color-gray-900);">-</div>
            </div>
            <div class="card">
                <h3 style="color: var(--color-gray-600); margin-bottom: var(--space-2);">総ユーザー数</h3>
                <div id="totalUsersCount" style="font-size: var(--font-size-xl); font-weight: 700; color: var(--color-gray-900);">-</div>
            </div>
        </div>

        <!-- Team Member Management -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-6);">
                <h2 style="color: var(--color-gray-900); margin: 0;">チームメンバー管理</h2>
                <div style="display: flex; gap: var(--space-2);">
                    <button onclick="showCreateTeamMemberModal()" class="btn btn-primary">
                        新規メンバー追加
                    </button>
                    <button onclick="refreshTeamMembers()" class="btn btn-secondary">
                        更新
                    </button>
                </div>
            </div>
            
            <!-- Team Members List -->
            <div id="teamMembersList" style="color: var(--color-gray-500);">
                データを読み込み中...
            </div>
        </div>

        <!-- Usage Chart -->
        <div class="card">
            <h2 style="margin-bottom: var(--space-6); color: var(--color-gray-900);">過去30日の使用状況</h2>
            <div id="usageChart" style="height: 300px; display: flex; align-items: center; justify-content: center; color: var(--color-gray-500);">
                データを読み込み中...
            </div>
        </div>

        <!-- Token Usage Statistics -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-6);">
                <h2 style="color: var(--color-gray-900); margin: 0;">Token使用量統計</h2>
                <div style="display: flex; gap: var(--space-2);">
                    <select id="tokenTimeRange" onchange="loadTokenStats()" class="input-field" style="width: auto;">
                        <option value="7">過去7日</option>
                        <option value="30" selected>過去30日</option>
                        <option value="90">過去90日</option>
                    </select>
                    <button onclick="loadTokenStats()" class="btn btn-secondary">
                        更新
                    </button>
                </div>
            </div>
            
            <!-- Token Summary Stats -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-6);">
                <div style="background: var(--color-purple-50); padding: var(--space-4); border-radius: 6px;">
                    <div style="font-size: var(--font-size-sm); color: var(--color-purple-700); margin-bottom: var(--space-1);">総Token数</div>
                    <div id="totalTokens" style="font-size: var(--font-size-xl); font-weight: 600; color: var(--color-purple-900);">-</div>
                </div>
                <div style="background: var(--color-green-50); padding: var(--space-4); border-radius: 6px;">
                    <div style="font-size: var(--font-size-sm); color: var(--color-green-700); margin-bottom: var(--space-1);">推定コスト</div>
                    <div id="totalCost" style="font-size: var(--font-size-xl); font-weight: 600; color: var(--color-green-900);">-</div>
                </div>
                <div style="background: var(--color-blue-50); padding: var(--space-4); border-radius: 6px;">
                    <div style="font-size: var(--font-size-sm); color: var(--color-blue-700); margin-bottom: var(--space-1);">平均Token/リクエスト</div>
                    <div id="avgTokens" style="font-size: var(--font-size-xl); font-weight: 600; color: var(--color-blue-900);">-</div>
                </div>
                <div style="background: var(--color-orange-50); padding: var(--space-4); border-radius: 6px;">
                    <div style="font-size: var(--font-size-sm); color: var(--color-orange-700); margin-bottom: var(--space-1);">総リクエスト数</div>
                    <div id="totalRequests" style="font-size: var(--font-size-xl); font-weight: 600; color: var(--color-orange-900);">-</div>
                </div>
            </div>

            <!-- Report Type Breakdown -->
            <div style="margin-bottom: var(--space-6);">
                <h3 style="margin-bottom: var(--space-4); color: var(--color-gray-800);">レポート種別別使用量</h3>
                <div id="reportTypeStats" style="color: var(--color-gray-500);">
                    データを読み込み中...
                </div>
            </div>

            <!-- Top Users -->
            <div style="margin-bottom: var(--space-6);">
                <h3 style="margin-bottom: var(--space-4); color: var(--color-gray-800);">ユーザー別使用量（上位10位）</h3>
                <div id="userTokenStats" style="color: var(--color-gray-500);">
                    データを読み込み中...
                </div>
            </div>

            <!-- Recent Usage -->
            <div>
                <h3 style="margin-bottom: var(--space-4); color: var(--color-gray-800);">最近の使用履歴</h3>
                <div id="recentTokenUsage" style="color: var(--color-gray-500);">
                    データを読み込み中...
                </div>
            </div>
        </div>

        <!-- Custom Prompts Management -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-6);">
                <h2 style="color: var(--color-gray-900); margin: 0;">カスタムプロンプト管理</h2>
                <button onclick="refreshCustomPrompts()" class="btn btn-secondary">
                    更新
                </button>
            </div>
            
            <!-- Custom Prompts Stats -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-6);">
                <div style="background: var(--color-blue-50); padding: var(--space-4); border-radius: 6px;">
                    <div style="font-size: var(--font-size-sm); color: var(--color-blue-700); margin-bottom: var(--space-1);">総プロンプト数</div>
                    <div id="totalCustomPrompts" style="font-size: var(--font-size-xl); font-weight: 600; color: var(--color-blue-900);">-</div>
                </div>
                <div style="background: var(--color-green-50); padding: var(--space-4); border-radius: 6px;">
                    <div style="font-size: var(--font-size-sm); color: var(--color-green-700); margin-bottom: var(--space-1);">アクティブユーザー</div>
                    <div id="activePromptUsers" style="font-size: var(--font-size-xl); font-weight: 600; color: var(--color-green-900);">-</div>
                </div>
            </div>

            <!-- Custom Prompts List -->
            <div id="customPromptsList" style="color: var(--color-gray-500);">
                データを読み込み中...
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="card">
            <h2 style="margin-bottom: var(--space-6); color: var(--color-gray-900);">最近のアクティビティ</h2>
            <div id="recentActivity" style="color: var(--color-gray-500);">
                データを読み込み中...
            </div>
        </div>

        <!-- Logout Button -->
        <div style="text-align: center; margin-top: var(--space-8);">
            <button onclick="logout()" class="btn btn-secondary">
                ログアウト
            </button>
        </div>
    </div>

    <script type="module">
        let currentUser = null;
        
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/me-firebase', {
                    credentials: 'include'
                });
                
                // Use error handler for API response
                await window.errorHandler.handleApiResponse(response, 'authentication');
                
                const result = await response.json();
                if (result.success && result.user) {
                    currentUser = result.user;
                    
                    if (currentUser.role !== 'admin') {
                        window.errorHandler.showNotification('管理者権限が必要です', 'warning', 3000);
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 3000);
                        return;
                    }
                    
                    loadDashboardData();
                    loadCustomPromptsData();
                    loadTrialStats();
                    loadTokenStats();
                    loadTeamMembers();
                    loadUserStats();
                } else {
                    console.error('Invalid response format:', result);
                    window.location.href = '/login.html';
                }
            } catch (error) {
                // Enhanced error handling
                window.errorHandler.handleError(error, 'authentication', false);
                
                if (error.status === 403) {
                    window.errorHandler.showNotification('管理者権限が必要です', 'warning', 3000);
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 3000);
                } else if (error.status === 401) {
                    window.location.href = '/login.html';
                } else {
                    // Show error but don't redirect for network issues
                    window.errorHandler.showNotification(
                        'Unable to verify authentication. Please refresh the page.',
                        'warning'
                    );
                }
            }
        }

        async function loadDashboardData() {
            try {
                // Load usage stats with error handling
                try {
                    const statsResponse = await fetch('/api/admin/stats-firebase', {
                        credentials: 'include'
                    });
                    await window.errorHandler.handleApiResponse(statsResponse, 'admin-stats');
                    const stats = await statsResponse.json();
                    updateStatsDisplay(stats);
                } catch (error) {
                    window.errorHandler.handleError(error, 'admin-stats');
                    console.error('Failed to load stats:', error);
                }

                // Load usage chart data with error handling
                try {
                    const chartResponse = await fetch('/api/admin/usage-chart-firebase', {
                        credentials: 'include'
                    });
                    await window.errorHandler.handleApiResponse(chartResponse, 'admin-chart');
                    const chartData = await chartResponse.json();
                    updateUsageChart(chartData);
                } catch (error) {
                    window.errorHandler.handleError(error, 'admin-chart');
                    console.error('Failed to load chart data:', error);
                }

                // Load recent activity with error handling
                try {
                    const activityResponse = await fetch('/api/admin/recent-activity-firebase', {
                        credentials: 'include'
                    });
                    await window.errorHandler.handleApiResponse(activityResponse, 'admin-activity');
                    const activity = await activityResponse.json();
                    updateRecentActivity(activity);
                } catch (error) {
                    window.errorHandler.handleError(error, 'admin-activity');
                    console.error('Failed to load activity data:', error);
                }

            } catch (error) {
                window.errorHandler.handleError(error, 'admin-dashboard');
                window.errorHandler.showNotification('ダッシュボードデータの読み込みに失敗しました', 'error');
            }
        }

        function updateStatsDisplay(stats) {
            document.getElementById('totalUsers').textContent = stats.total_users || 0;
            document.getElementById('totalRequests').textContent = stats.total_requests || 0;
            document.getElementById('totalReports').textContent = stats.total_reports || 0;
            document.getElementById('totalFiles').textContent = stats.total_files || 0;
        }

        function updateUsageChart(data) {
            const chartContainer = document.getElementById('usageChart');
            
            if (!data || data.length === 0) {
                chartContainer.innerHTML = '<p>データがありません</p>';
                return;
            }

            // Simple text-based chart for now
            let chartHTML = '<div style="display: flex; flex-direction: column; gap: var(--space-2); width: 100%;">';
            
            data.forEach(day => {
                const barWidth = Math.max(10, (day.total_requests / Math.max(...data.map(d => d.total_requests))) * 100);
                chartHTML += `
                    <div style="display: flex; align-items: center; gap: var(--space-3);">
                        <div style="min-width: 80px; font-size: var(--font-size-sm);">${day.date}</div>
                        <div style="flex: 1; background: var(--color-gray-200); height: 20px; border-radius: var(--radius-sm); position: relative;">
                            <div style="background: var(--color-primary); height: 100%; width: ${barWidth}%; border-radius: var(--radius-sm);"></div>
                        </div>
                        <div style="min-width: 60px; font-size: var(--font-size-sm); text-align: right;">${day.total_requests}</div>
                    </div>
                `;
            });
            
            chartHTML += '</div>';
            chartContainer.innerHTML = chartHTML;
        }

        function updateRecentActivity(activities) {
            const container = document.getElementById('recentActivity');
            
            if (!activities || activities.length === 0) {
                container.innerHTML = '<p>最近のアクティビティはありません</p>';
                return;
            }

            let activityHTML = '<div style="display: flex; flex-direction: column; gap: var(--space-3);">';
            
            activities.forEach(activity => {
                const timeAgo = getTimeAgo(activity.created_at);
                activityHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-3); background: var(--color-gray-50); border-radius: var(--radius-md);">
                        <div>
                            <strong>${activity.action}</strong>
                            ${activity.report_type ? ` - ${activity.report_type}` : ''}
                        </div>
                        <div style="font-size: var(--font-size-sm); color: var(--color-gray-500);">${timeAgo}</div>
                    </div>
                `;
            });
            
            activityHTML += '</div>';
            container.innerHTML = activityHTML;
        }

        function getTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'たった今';
            if (diffMins < 60) return `${diffMins}分前`;
            if (diffHours < 24) return `${diffHours}時間前`;
            return `${diffDays}日前`;
        }

        async function logout() {
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    console.log('Logout successful');
                } else {
                    console.error('Logout failed with status:', response.status);
                }
                
                // Always redirect to login regardless of logout success
                window.location.href = '/login.html';
            } catch (error) {
                console.error('Logout failed:', error);
                // Still redirect to login even if logout request failed
                window.location.href = '/login.html';
            }
        }

        async function loadTrialStats() {
            try {
                const response = await fetch('/api/admin/trial-stats', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        updateTrialStats(result.stats);
                    }
                }
            } catch (error) {
                console.error('Failed to load trial stats:', error);
            }
        }

        function updateTrialStats(stats) {
            document.getElementById('trialUsers').textContent = stats.trialUsers || 0;
            document.getElementById('expiredTrials').textContent = stats.expiredTrials || 0;
            document.getElementById('activeSubscriptions').textContent = stats.activeSubscriptions || 0;
            document.getElementById('conversionRate').textContent = (stats.trialConversionRate || 0) + '%';
        }

        async function loadCustomPromptsData() {
            try {
                // Load custom prompts statistics
                const statsResponse = await fetch('/api/admin/custom-prompts?stats=true', {
                    credentials: 'include'
                });

                if (statsResponse.ok) {
                    const statsResult = await statsResponse.json();
                    if (statsResult.success) {
                        updateCustomPromptsStats(statsResult.stats);
                    }
                }

                // Load custom prompts list
                const listResponse = await fetch('/api/admin/custom-prompts?limit=20', {
                    credentials: 'include'
                });

                if (listResponse.ok) {
                    const listResult = await listResponse.json();
                    if (listResult.success) {
                        displayCustomPromptsList(listResult.prompts);
                    }
                }
            } catch (error) {
                console.error('Failed to load custom prompts data:', error);
                document.getElementById('customPromptsList').innerHTML = '<p style="color: var(--color-red-600);">データの読み込みに失敗しました</p>';
            }
        }

        function updateCustomPromptsStats(stats) {
            document.getElementById('totalCustomPrompts').textContent = stats.totalPrompts || 0;
            document.getElementById('activePromptUsers').textContent = Object.keys(stats.userStats || {}).length || 0;
        }

        function displayCustomPromptsList(prompts) {
            const container = document.getElementById('customPromptsList');
            
            if (!prompts || prompts.length === 0) {
                container.innerHTML = '<p style="color: var(--color-gray-500);">カスタムプロンプトがありません</p>';
                return;
            }

            let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: var(--font-size-sm);">';
            html += `
                <thead>
                    <tr style="background: var(--color-gray-50); border-bottom: 2px solid var(--color-gray-200);">
                        <th style="padding: var(--space-3); text-align: left; font-weight: 600;">タイトル</th>
                        <th style="padding: var(--space-3); text-align: left; font-weight: 600;">ユーザー</th>
                        <th style="padding: var(--space-3); text-align: left; font-weight: 600;">作成日</th>
                        <th style="padding: var(--space-3); text-align: left; font-weight: 600;">タグ</th>
                        <th style="padding: var(--space-3); text-align: center; font-weight: 600;">操作</th>
                    </tr>
                </thead>
                <tbody>
            `;

            prompts.forEach(prompt => {
                const createdDate = formatAdminDate(prompt.createdAt);
                const tags = prompt.tags && prompt.tags.length > 0 ? prompt.tags.join(', ') : '-';
                
                html += `
                    <tr style="border-bottom: 1px solid var(--color-gray-200);">
                        <td style="padding: var(--space-3);">
                            <div style="font-weight: 500; margin-bottom: var(--space-1);">${escapeHtml(prompt.title)}</div>
                            ${prompt.description ? `<div style="color: var(--color-gray-600); font-size: var(--font-size-xs);">${escapeHtml(prompt.description)}</div>` : ''}
                        </td>
                        <td style="padding: var(--space-3);">${escapeHtml(prompt.userEmail || 'Unknown')}</td>
                        <td style="padding: var(--space-3);">${createdDate}</td>
                        <td style="padding: var(--space-3);">${escapeHtml(tags)}</td>
                        <td style="padding: var(--space-3); text-align: center;">
                            <button onclick="viewPromptContent('${prompt.id}')" class="admin-btn admin-btn-view" title="内容を表示">
                                👁️
                            </button>
                            <button onclick="deleteAdminPrompt('${prompt.id}', '${escapeHtml(prompt.title)}')" class="admin-btn admin-btn-delete" title="削除">
                                🗑️
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        async function refreshCustomPrompts() {
            document.getElementById('customPromptsList').innerHTML = '<p style="color: var(--color-gray-500);">データを読み込み中...</p>';
            await loadCustomPromptsData();
        }

        async function viewPromptContent(promptId) {
            try {
                const response = await fetch('/api/admin/custom-prompts', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const prompt = result.prompts.find(p => p.id === promptId);
                        if (prompt) {
                            showPromptModal(prompt);
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to load prompt content:', error);
                alert('プロンプト内容の読み込みに失敗しました');
            }
        }

        function showPromptModal(prompt) {
            const modal = document.createElement('div');
            modal.className = 'admin-modal';
            modal.innerHTML = `
                <div class="admin-modal-content">
                    <div class="admin-modal-header">
                        <h3>${escapeHtml(prompt.title)}</h3>
                        <button onclick="closePromptModal()" class="admin-modal-close">&times;</button>
                    </div>
                    <div class="admin-modal-body">
                        <div style="margin-bottom: var(--space-4);">
                            <strong>ユーザー:</strong> ${escapeHtml(prompt.userEmail || 'Unknown')}
                        </div>
                        ${prompt.description ? `
                            <div style="margin-bottom: var(--space-4);">
                                <strong>説明:</strong> ${escapeHtml(prompt.description)}
                            </div>
                        ` : ''}
                        ${prompt.tags && prompt.tags.length > 0 ? `
                            <div style="margin-bottom: var(--space-4);">
                                <strong>タグ:</strong> ${prompt.tags.map(tag => `<span class="admin-tag">${escapeHtml(tag)}</span>`).join(' ')}
                            </div>
                        ` : ''}
                        <div style="margin-bottom: var(--space-4);">
                            <strong>作成日:</strong> ${formatAdminDate(prompt.createdAt)}
                        </div>
                        <div>
                            <strong>プロンプト内容:</strong>
                            <textarea readonly style="width: 100%; height: 200px; margin-top: var(--space-2); padding: var(--space-3); border: 1px solid var(--color-gray-300); border-radius: 4px; font-family: monospace; font-size: var(--font-size-sm);">${escapeHtml(prompt.content)}</textarea>
                        </div>
                    </div>
                    <div class="admin-modal-footer">
                        <button onclick="closePromptModal()" class="btn btn-secondary">閉じる</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closePromptModal() {
            const modal = document.querySelector('.admin-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function deleteAdminPrompt(promptId, promptTitle) {
            if (!confirm(`「${promptTitle}」を削除しますか？\n\nこの操作は取り消せません。`)) {
                return;
            }

            try {
                const response = await fetch('/api/admin/custom-prompts', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ promptId })
                });

                const result = await response.json();

                if (result.success) {
                    alert('プロンプトを削除しました');
                    await refreshCustomPrompts();
                } else {
                    alert('削除に失敗しました: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Delete prompt error:', error);
                alert('削除中にエラーが発生しました');
            }
        }

        function formatAdminDate(timestamp) {
            if (!timestamp) return '-';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function loadTokenStats() {
            try {
                const timeRange = document.getElementById('tokenTimeRange')?.value || '30';
                const response = await fetch(`/api/admin/token-stats?timeRange=${timeRange}`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        updateTokenStats(result.stats);
                    }
                } else {
                    console.error('Failed to load token stats:', response.status);
                }
            } catch (error) {
                console.error('Failed to load token stats:', error);
                document.getElementById('totalTokens').textContent = 'エラー';
                document.getElementById('totalCost').textContent = 'エラー';
                document.getElementById('avgTokens').textContent = 'エラー';
                document.getElementById('totalRequests').textContent = 'エラー';
            }
        }

        function updateTokenStats(stats) {
            // Update summary stats
            document.getElementById('totalTokens').textContent = formatNumber(stats.summary.totalTokens);
            document.getElementById('totalCost').textContent = '$' + parseFloat(stats.summary.totalCost).toFixed(4);
            document.getElementById('avgTokens').textContent = formatNumber(stats.summary.averageTokensPerRequest);
            document.getElementById('totalRequests').textContent = formatNumber(stats.summary.totalRecords);

            // Update report type stats
            displayReportTypeStats(stats.reportTypeStats);

            // Update user stats
            displayUserTokenStats(stats.userStats);

            // Update recent usage
            displayRecentTokenUsage(stats.recentUsage);
        }

        function displayReportTypeStats(reportTypeStats) {
            const container = document.getElementById('reportTypeStats');
            
            if (!reportTypeStats || Object.keys(reportTypeStats).length === 0) {
                container.innerHTML = '<p style="color: var(--color-gray-500);">データがありません</p>';
                return;
            }

            let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: var(--font-size-sm);">';
            html += `
                <thead>
                    <tr style="background: var(--color-gray-50); border-bottom: 2px solid var(--color-gray-200);">
                        <th style="padding: var(--space-3); text-align: left; font-weight: 600;">レポート種別</th>
                        <th style="padding: var(--space-3); text-align: right; font-weight: 600;">リクエスト数</th>
                        <th style="padding: var(--space-3); text-align: right; font-weight: 600;">総Token数</th>
                        <th style="padding: var(--space-3); text-align: right; font-weight: 600;">推定コスト</th>
                        <th style="padding: var(--space-3); text-align: right; font-weight: 600;">平均Token</th>
                    </tr>
                </thead>
                <tbody>
            `;

            Object.entries(reportTypeStats).forEach(([reportType, stats]) => {
                const avgTokens = stats.count > 0 ? Math.round(stats.totalTokens / stats.count) : 0;
                html += `
                    <tr style="border-bottom: 1px solid var(--color-gray-200);">
                        <td style="padding: var(--space-3);">${getReportTypeName(reportType)}</td>
                        <td style="padding: var(--space-3); text-align: right;">${formatNumber(stats.count)}</td>
                        <td style="padding: var(--space-3); text-align: right;">${formatNumber(stats.totalTokens)}</td>
                        <td style="padding: var(--space-3); text-align: right;">$${parseFloat(stats.totalCost).toFixed(4)}</td>
                        <td style="padding: var(--space-3); text-align: right;">${formatNumber(avgTokens)}</td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function displayUserTokenStats(userStats) {
            const container = document.getElementById('userTokenStats');
            
            if (!userStats || Object.keys(userStats).length === 0) {
                container.innerHTML = '<p style="color: var(--color-gray-500);">データがありません</p>';
                return;
            }

            // Sort users by total tokens and take top 10
            const sortedUsers = Object.entries(userStats)
                .sort(([,a], [,b]) => b.totalTokens - a.totalTokens)
                .slice(0, 10);

            let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: var(--font-size-sm);">';
            html += `
                <thead>
                    <tr style="background: var(--color-gray-50); border-bottom: 2px solid var(--color-gray-200);">
                        <th style="padding: var(--space-3); text-align: left; font-weight: 600;">ユーザー</th>
                        <th style="padding: var(--space-3); text-align: right; font-weight: 600;">リクエスト数</th>
                        <th style="padding: var(--space-3); text-align: right; font-weight: 600;">総Token数</th>
                        <th style="padding: var(--space-3); text-align: right; font-weight: 600;">推定コスト</th>
                        <th style="padding: var(--space-3); text-align: right; font-weight: 600;">平均Token</th>
                    </tr>
                </thead>
                <tbody>
            `;

            sortedUsers.forEach(([userId, stats]) => {
                const avgTokens = stats.count > 0 ? Math.round(stats.totalTokens / stats.count) : 0;
                html += `
                    <tr style="border-bottom: 1px solid var(--color-gray-200);">
                        <td style="padding: var(--space-3);">${escapeHtml(stats.email)}</td>
                        <td style="padding: var(--space-3); text-align: right;">${formatNumber(stats.count)}</td>
                        <td style="padding: var(--space-3); text-align: right;">${formatNumber(stats.totalTokens)}</td>
                        <td style="padding: var(--space-3); text-align: right;">$${parseFloat(stats.totalCost).toFixed(4)}</td>
                        <td style="padding: var(--space-3); text-align: right;">${formatNumber(avgTokens)}</td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function displayRecentTokenUsage(recentUsage) {
            const container = document.getElementById('recentTokenUsage');
            
            if (!recentUsage || recentUsage.length === 0) {
                container.innerHTML = '<p style="color: var(--color-gray-500);">データがありません</p>';
                return;
            }

            let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: var(--font-size-sm);">';
            html += `
                <thead>
                    <tr style="background: var(--color-gray-50); border-bottom: 2px solid var(--color-gray-200);">
                        <th style="padding: var(--space-3); text-align: left; font-weight: 600;">日時</th>
                        <th style="padding: var(--space-3); text-align: left; font-weight: 600;">ユーザー</th>
                        <th style="padding: var(--space-3); text-align: left; font-weight: 600;">レポート種別</th>
                        <th style="padding: var(--space-3); text-align: right; font-weight: 600;">Token数</th>
                        <th style="padding: var(--space-3); text-align: right; font-weight: 600;">コスト</th>
                        <th style="padding: var(--space-3); text-align: center; font-weight: 600;">モデル</th>
                    </tr>
                </thead>
                <tbody>
            `;

            recentUsage.slice(0, 20).forEach(usage => {
                const date = formatAdminDate(usage.createdAt);
                html += `
                    <tr style="border-bottom: 1px solid var(--color-gray-200);">
                        <td style="padding: var(--space-3);">${date}</td>
                        <td style="padding: var(--space-3);">${escapeHtml(usage.userEmail || 'Unknown')}</td>
                        <td style="padding: var(--space-3);">${getReportTypeName(usage.reportType)}</td>
                        <td style="padding: var(--space-3); text-align: right;">${formatNumber(usage.totalTokens)}</td>
                        <td style="padding: var(--space-3); text-align: right;">$${parseFloat(usage.estimatedCost || 0).toFixed(6)}</td>
                        <td style="padding: var(--space-3); text-align: center;">
                            <span style="background: var(--color-blue-100); color: var(--color-blue-800); padding: 2px 6px; border-radius: 4px; font-size: var(--font-size-xs);">
                                ${usage.model || 'gpt-4o'}
                            </span>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function getReportTypeName(reportType) {
            const names = {
                'jp_investment_4part': '投資分析（4部構成）',
                'jp_tax_strategy': '税務戦略（減価償却）',
                'jp_inheritance_strategy': '相続対策戦略',
                'custom': 'カスタムプロンプト'
            };
            return names[reportType] || reportType;
        }

        function formatNumber(num) {
            if (num === undefined || num === null) return '0';
            return new Intl.NumberFormat('ja-JP').format(num);
        }

        // Team Member Management
        async function loadUserStats() {
            try {
                const response = await fetch('/api/admin/team-members?stats=true', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        updateUserStats(result.stats);
                    }
                }
            } catch (error) {
                console.error('Failed to load user stats:', error);
            }
        }

        function updateUserStats(stats) {
            document.getElementById('adminUsers').textContent = stats.adminUsers || 0;
            document.getElementById('teamMembers').textContent = stats.teamMembers || 0;
            document.getElementById('totalUsersCount').textContent = stats.totalUsers || 0;
        }

        async function loadTeamMembers() {
            try {
                const response = await fetch('/api/admin/team-members', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        displayTeamMembers(result.users);
                    }
                }
            } catch (error) {
                console.error('Failed to load team members:', error);
                document.getElementById('teamMembersList').innerHTML = '<p style="color: var(--color-red-600);">データの読み込みに失敗しました</p>';
            }
        }

        function displayTeamMembers(users) {
            const container = document.getElementById('teamMembersList');
            
            if (!users || users.length === 0) {
                container.innerHTML = '<p style="color: var(--color-gray-500);">ユーザーがいません</p>';
                return;
            }

            let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: var(--font-size-sm);">';
            html += `
                <thead>
                    <tr style="background: var(--color-gray-50); border-bottom: 2px solid var(--color-gray-200);">
                        <th style="padding: var(--space-3); text-align: left; font-weight: 600;">名前</th>
                        <th style="padding: var(--space-3); text-align: left; font-weight: 600;">メール</th>
                        <th style="padding: var(--space-3); text-align: center; font-weight: 600;">ロール</th>
                        <th style="padding: var(--space-3); text-align: center; font-weight: 600;">ステータス</th>
                        <th style="padding: var(--space-3); text-align: left; font-weight: 600;">作成日</th>
                        <th style="padding: var(--space-3); text-align: center; font-weight: 600;">操作</th>
                    </tr>
                </thead>
                <tbody>
            `;

            users.forEach(user => {
                const createdDate = formatAdminDate(user.createdAt);
                const roleDisplay = getRoleDisplay(user.role);
                const statusDisplay = getStatusDisplay(user);
                
                html += `
                    <tr style="border-bottom: 1px solid var(--color-gray-200);">
                        <td style="padding: var(--space-3);">${escapeHtml(user.name || 'Unknown')}</td>
                        <td style="padding: var(--space-3);">${escapeHtml(user.email)}</td>
                        <td style="padding: var(--space-3); text-align: center;">
                            <span class="role-badge role-${user.role}">${roleDisplay}</span>
                        </td>
                        <td style="padding: var(--space-3); text-align: center;">
                            <span class="status-badge ${user.isActive ? 'status-active' : 'status-inactive'}">${statusDisplay}</span>
                        </td>
                        <td style="padding: var(--space-3);">${createdDate}</td>
                        <td style="padding: var(--space-3); text-align: center;">
                            <button onclick="editUser('${user.id}')" class="admin-btn admin-btn-view" title="編集">
                                ✏️
                            </button>
                            ${user.isActive ? `
                                <button onclick="deactivateUser('${user.id}', '${escapeHtml(user.name || user.email)}')" class="admin-btn admin-btn-delete" title="無効化">
                                    🚫
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function getRoleDisplay(role) {
            const roles = {
                'admin': '管理者',
                'team_member': 'チームメンバー',
                'user': '一般ユーザー'
            };
            return roles[role] || role;
        }

        function getStatusDisplay(user) {
            if (!user.isActive) return '無効';
            
            switch (user.subscriptionStatus) {
                case 'trial': return '試用中';
                case 'active': return '有料';
                case 'team_access': return 'チーム';
                case 'trial_expired': return '期限切れ';
                default: return '不明';
            }
        }

        function showCreateTeamMemberModal() {
            document.getElementById('createTeamMemberModal').style.display = 'flex';
        }

        function closeCreateTeamMemberModal() {
            document.getElementById('createTeamMemberModal').style.display = 'none';
            document.getElementById('createTeamMemberForm').reset();
        }

        async function createTeamMember() {
            const form = document.getElementById('createTeamMemberForm');
            const formData = new FormData(form);
            
            const memberData = {
                name: formData.get('memberName'),
                email: formData.get('memberEmail'),
                password: formData.get('memberPassword'),
                permissions: {
                    canGenerateReports: formData.get('canGenerateReports') === 'on',
                    canManageCustomPrompts: formData.get('canManageCustomPrompts') === 'on',
                    canViewAllReports: formData.get('canViewAllReports') === 'on',
                    canViewAnalytics: formData.get('canViewAnalytics') === 'on',
                    maxReportsPerMonth: parseInt(formData.get('maxReportsPerMonth')) || 100
                }
            };

            try {
                const response = await fetch('/api/admin/team-members', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(memberData)
                });

                const result = await response.json();

                if (result.success) {
                    alert('チームメンバーを作成しました');
                    closeCreateTeamMemberModal();
                    await loadTeamMembers();
                    await loadUserStats();
                } else {
                    alert('作成に失敗しました: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Create team member error:', error);
                alert('作成中にエラーが発生しました');
            }
        }

        async function editUser(userId) {
            try {
                const response = await fetch('/api/admin/team-members', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const user = result.users.find(u => u.id === userId);
                        if (user) {
                            showEditUserModal(user);
                        }
                    }
                }
            } catch (error) {
                console.error('Edit user error:', error);
                alert('ユーザー情報の取得に失敗しました');
            }
        }

        function showEditUserModal(user) {
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserRole').value = user.role;
            
            // Show/hide team permissions section
            const permissionsSection = document.getElementById('teamPermissionsSection');
            if (user.role === 'team_member') {
                permissionsSection.style.display = 'block';
                const permissions = user.teamPermissions || {};
                document.getElementById('editCanGenerateReports').checked = permissions.canGenerateReports !== false;
                document.getElementById('editCanManageCustomPrompts').checked = permissions.canManageCustomPrompts !== false;
                document.getElementById('editCanViewAllReports').checked = permissions.canViewAllReports || false;
                document.getElementById('editCanViewAnalytics').checked = permissions.canViewAnalytics || false;
                document.getElementById('editMaxReportsPerMonth').value = permissions.maxReportsPerMonth || 100;
            } else {
                permissionsSection.style.display = 'none';
            }
            
            document.getElementById('editUserModal').style.display = 'flex';
            
            // Add role change listener
            document.getElementById('editUserRole').onchange = function() {
                if (this.value === 'team_member') {
                    permissionsSection.style.display = 'block';
                } else {
                    permissionsSection.style.display = 'none';
                }
            };
        }

        function closeEditUserModal() {
            document.getElementById('editUserModal').style.display = 'none';
        }

        async function updateUser() {
            const userId = document.getElementById('editUserId').value;
            const role = document.getElementById('editUserRole').value;
            
            let permissions = {};
            if (role === 'team_member') {
                permissions = {
                    canGenerateReports: document.getElementById('editCanGenerateReports').checked,
                    canManageCustomPrompts: document.getElementById('editCanManageCustomPrompts').checked,
                    canViewAllReports: document.getElementById('editCanViewAllReports').checked,
                    canViewAnalytics: document.getElementById('editCanViewAnalytics').checked,
                    maxReportsPerMonth: parseInt(document.getElementById('editMaxReportsPerMonth').value) || 100
                };
            }

            try {
                const response = await fetch('/api/admin/team-members', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ userId, role, permissions })
                });

                const result = await response.json();

                if (result.success) {
                    alert('ユーザーを更新しました');
                    closeEditUserModal();
                    await loadTeamMembers();
                    await loadUserStats();
                } else {
                    alert('更新に失敗しました: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Update user error:', error);
                alert('更新中にエラーが発生しました');
            }
        }

        async function deactivateUser(userId, userName) {
            if (!confirm(`「${userName}」を無効化しますか？\n\nこの操作により、ユーザーはログインできなくなります。`)) {
                return;
            }

            try {
                const response = await fetch('/api/admin/team-members', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ userId })
                });

                const result = await response.json();

                if (result.success) {
                    alert('ユーザーを無効化しました');
                    await loadTeamMembers();
                    await loadUserStats();
                } else {
                    alert('無効化に失敗しました: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Deactivate user error:', error);
                alert('無効化中にエラーが発生しました');
            }
        }

        async function refreshTeamMembers() {
            document.getElementById('teamMembersList').innerHTML = '<p style="color: var(--color-gray-500);">データを読み込み中...</p>';
            await loadTeamMembers();
            await loadUserStats();
        }

        // Check authentication on page load
        checkAuth();
    </script>

    <style>
        .admin-btn {
            background: none;
            border: 1px solid var(--color-gray-300);
            padding: var(--space-1) var(--space-2);
            margin: 0 2px;
            border-radius: 4px;
            cursor: pointer;
            font-size: var(--font-size-sm);
            transition: all 0.2s;
        }

        .admin-btn:hover {
            background-color: var(--color-gray-50);
        }

        .admin-btn-view {
            color: var(--color-blue-600);
            border-color: var(--color-blue-300);
        }

        .admin-btn-view:hover {
            background-color: var(--color-blue-50);
        }

        .admin-btn-delete {
            color: var(--color-red-600);
            border-color: var(--color-red-300);
        }

        .admin-btn-delete:hover {
            background-color: var(--color-red-50);
        }

        .admin-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .admin-modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .admin-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-6);
            border-bottom: 1px solid var(--color-gray-200);
        }

        .admin-modal-header h3 {
            margin: 0;
            font-size: var(--font-size-lg);
            font-weight: 600;
        }

        .admin-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--color-gray-500);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .admin-modal-close:hover {
            color: var(--color-gray-700);
        }

        .admin-modal-body {
            padding: var(--space-6);
        }

        .admin-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-3);
            padding: var(--space-6);
            border-top: 1px solid var(--color-gray-200);
        }

        .admin-tag {
            background-color: var(--color-blue-100);
            color: var(--color-blue-800);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: var(--font-size-xs);
            margin-right: var(--space-1);
        }

        .role-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: var(--font-size-xs);
            font-weight: 600;
        }

        .role-admin {
            background-color: var(--color-purple-100);
            color: var(--color-purple-800);
        }

        .role-team_member {
            background-color: var(--color-blue-100);
            color: var(--color-blue-800);
        }

        .role-user {
            background-color: var(--color-gray-100);
            color: var(--color-gray-800);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: var(--font-size-xs);
            font-weight: 600;
        }

        .status-active {
            background-color: var(--color-green-100);
            color: var(--color-green-800);
        }

        .status-inactive {
            background-color: var(--color-red-100);
            color: var(--color-red-800);
        }

        .form-group {
            margin-bottom: var(--space-4);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-1);
            font-weight: 600;
            color: var(--color-gray-700);
        }

        .input-field {
            width: 100%;
            padding: var(--space-2);
            border: 1px solid var(--color-gray-300);
            border-radius: 4px;
            font-size: var(--font-size-sm);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
    </style>

    <!-- Create Team Member Modal -->
    <div id="createTeamMemberModal" class="admin-modal" style="display: none;">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h3>新規チームメンバー追加</h3>
                <button onclick="closeCreateTeamMemberModal()" class="admin-modal-close">&times;</button>
            </div>
            <div class="admin-modal-body">
                <form id="createTeamMemberForm">
                    <div class="form-group">
                        <label for="memberName" class="form-label">名前</label>
                        <input type="text" id="memberName" name="memberName" class="input-field" required>
                    </div>
                    <div class="form-group">
                        <label for="memberEmail" class="form-label">メールアドレス</label>
                        <input type="email" id="memberEmail" name="memberEmail" class="input-field" required>
                    </div>
                    <div class="form-group">
                        <label for="memberPassword" class="form-label">パスワード</label>
                        <input type="password" id="memberPassword" name="memberPassword" class="input-field" required minlength="8">
                    </div>
                    
                    <h4 style="margin: var(--space-4) 0 var(--space-2) 0;">権限設定</h4>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: var(--space-2);">
                            <input type="checkbox" id="canGenerateReports" name="canGenerateReports" checked>
                            <span>レポート生成</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: var(--space-2);">
                            <input type="checkbox" id="canManageCustomPrompts" name="canManageCustomPrompts" checked>
                            <span>カスタムプロンプト管理</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: var(--space-2);">
                            <input type="checkbox" id="canViewAllReports" name="canViewAllReports">
                            <span>全レポート閲覧</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: var(--space-2);">
                            <input type="checkbox" id="canViewAnalytics" name="canViewAnalytics">
                            <span>分析データ閲覧</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label for="maxReportsPerMonth" class="form-label">月間レポート生成上限</label>
                        <input type="number" id="maxReportsPerMonth" name="maxReportsPerMonth" class="input-field" value="100" min="1" max="1000">
                    </div>
                </form>
            </div>
            <div class="admin-modal-footer">
                <button onclick="closeCreateTeamMemberModal()" class="btn btn-secondary">キャンセル</button>
                <button onclick="createTeamMember()" class="btn btn-primary">作成</button>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="admin-modal" style="display: none;">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h3>ユーザー編集</h3>
                <button onclick="closeEditUserModal()" class="admin-modal-close">&times;</button>
            </div>
            <div class="admin-modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId" name="editUserId">
                    
                    <div class="form-group">
                        <label for="editUserRole" class="form-label">ロール</label>
                        <select id="editUserRole" name="editUserRole" class="input-field">
                            <option value="user">一般ユーザー</option>
                            <option value="team_member">チームメンバー</option>
                            <option value="admin">管理者</option>
                        </select>
                    </div>
                    
                    <div id="teamPermissionsSection" style="display: none;">
                        <h4 style="margin: var(--space-4) 0 var(--space-2) 0;">チームメンバー権限</h4>
                        
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: var(--space-2);">
                                <input type="checkbox" id="editCanGenerateReports" name="editCanGenerateReports">
                                <span>レポート生成</span>
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: var(--space-2);">
                                <input type="checkbox" id="editCanManageCustomPrompts" name="editCanManageCustomPrompts">
                                <span>カスタムプロンプト管理</span>
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: var(--space-2);">
                                <input type="checkbox" id="editCanViewAllReports" name="editCanViewAllReports">
                                <span>全レポート閲覧</span>
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: var(--space-2);">
                                <input type="checkbox" id="editCanViewAnalytics" name="editCanViewAnalytics">
                                <span>分析データ閲覧</span>
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label for="editMaxReportsPerMonth" class="form-label">月間レポート生成上限</label>
                            <input type="number" id="editMaxReportsPerMonth" name="editMaxReportsPerMonth" class="input-field" min="1" max="1000">
                        </div>
                    </div>
                </form>
            </div>
            <div class="admin-modal-footer">
                <button onclick="closeEditUserModal()" class="btn btn-secondary">キャンセル</button>
                <button onclick="updateUser()" class="btn btn-primary">更新</button>
            </div>
        </div>
    </div>
</body>
</html>
