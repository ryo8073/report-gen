<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新規登録 - クライアント向けレポート生成</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="/lib/frontend-error-handler.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>新規登録</h1>
            <p>アカウントを作成してレポート生成を開始</p>
            
            <!-- Trial Information -->
            <div style="background: linear-gradient(135deg, #e0f2fe, #81d4fa); border: 1px solid #29b6f6; border-radius: 8px; padding: var(--space-4); margin-top: var(--space-4); color: #01579b;">
                <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                    <strong>🎉 2週間無料トライアル</strong>
                </div>
                <div style="font-size: var(--font-size-sm);">
                    <div>✓ 15回まで無料でレポート生成</div>
                    <div>✓ 全機能をお試しいただけます</div>
                    <div>✓ クレジットカード登録不要</div>
                </div>
            </div>
        </header>

        <!-- Registration Form -->
        <div class="card" style="max-width: 400px; margin: 0 auto;">
            <form id="registerForm">
                <!-- Name -->
                <div class="form-group">
                    <label for="name" class="form-label">
                        お名前
                    </label>
                    <input 
                        type="text" 
                        id="name" 
                        name="name" 
                        class="input-field"
                        placeholder="山田太郎"
                        required
                    >
                </div>

                <!-- Email -->
                <div class="form-group">
                    <label for="email" class="form-label">
                        メールアドレス
                    </label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        class="input-field"
                        placeholder="your@email.com"
                        autocomplete="username"
                        required
                    >
                </div>

                <!-- Password -->
                <div class="form-group">
                    <label for="password" class="form-label">
                        パスワード
                    </label>
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        class="input-field"
                        placeholder="8文字以上（大文字・小文字・数字を含む）"
                        autocomplete="new-password"
                        required
                    >
                    <div style="margin-top: var(--space-2);">
                        <p style="font-size: var(--font-size-xs); color: var(--color-gray-500);">
                            パスワードは8文字以上で、大文字・小文字・数字を含む必要があります
                        </p>
                    </div>
                </div>

                <!-- Confirm Password -->
                <div class="form-group">
                    <label for="confirmPassword" class="form-label">
                        パスワード確認
                    </label>
                    <input 
                        type="password" 
                        id="confirmPassword" 
                        name="confirmPassword" 
                        class="input-field"
                        placeholder="パスワードを再入力"
                        autocomplete="new-password"
                        required
                    >
                </div>

                <!-- Submit Button -->
                <div style="text-align: center; margin-top: var(--space-8);">
                    <button type="submit" id="registerBtn" class="btn btn-primary">
                        新規登録
                    </button>
                </div>
            </form>

            <!-- Links -->
            <div style="text-align: center; margin-top: var(--space-6);">
                <p style="color: var(--color-gray-600); font-size: var(--font-size-sm);">
                    すでにアカウントをお持ちの方は
                    <a href="/login.html" style="color: var(--color-primary); text-decoration: none; font-weight: 500;">
                        ログイン
                    </a>
                </p>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusSection" class="hidden status-section">
            <div class="alert-content">
                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 alert-icon"></div>
                <span id="statusText">アカウント作成中...</span>
            </div>
        </div>

        <div id="errorSection" class="hidden error-section">
            <div class="alert-content">
                <svg class="alert-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                </svg>
                <span id="errorText"></span>
            </div>
        </div>

        <div id="successSection" class="hidden success-section">
            <div class="alert-content">
                <svg class="alert-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                <span id="successText">アカウント作成成功！ログインページにリダイレクト中...</span>
            </div>
        </div>
    </div>

    <script type="module">
        // Form submission
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const name = formData.get('name');
            const email = formData.get('email');
            const password = formData.get('password');
            const confirmPassword = formData.get('confirmPassword');

            // Client-side validation
            if (password !== confirmPassword) {
                showError('パスワードが一致しません');
                return;
            }

            if (password.length < 8) {
                showError('パスワードは8文字以上である必要があります');
                return;
            }

            if (!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(password)) {
                showError('パスワードは大文字・小文字・数字を含む必要があります');
                return;
            }

            try {
                showStatus('アカウント作成中...');
                hideError();
                hideSuccess();

                const response = await fetch('/api/auth/register-firebase', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    body: JSON.stringify({ name, email, password }),
                    credentials: 'include'
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'アカウント作成に失敗しました');
                }

                showSuccess('アカウント作成成功！ログインページにリダイレクト中...');
                hideStatus();

                // Redirect to login page after successful registration
                setTimeout(() => {
                    window.location.href = '/login.html';
                }, 2000);

            } catch (error) {
                console.error('Registration error:', error);
                showError(`登録エラー: ${error.message}`);
                hideStatus();
            }
        });

        function showStatus(message) {
            document.getElementById('statusText').textContent = message;
            document.getElementById('statusSection').classList.remove('hidden');
        }

        function hideStatus() {
            document.getElementById('statusSection').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorSection').classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorSection').classList.add('hidden');
        }

        function showSuccess(message) {
            document.getElementById('successText').textContent = message;
            document.getElementById('successSection').classList.remove('hidden');
        }

        function hideSuccess() {
            document.getElementById('successSection').classList.add('hidden');
        }

        // Check if already logged in
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/me-firebase', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    // Already logged in, redirect to main page
                    window.location.href = '/';
                }
            } catch (error) {
                // Not logged in, stay on registration page
                console.log('Not authenticated');
            }
        }

        // Check authentication on page load
        checkAuth();
    </script>
</body>
</html>
