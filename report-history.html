<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>レポート履歴</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="/lib/frontend-error-handler.js"></script>
    <script>
        // Ensure errorHandler is available
        if (typeof window.errorHandler === 'undefined') {
            console.warn('ErrorHandler not loaded, creating fallback');
            window.errorHandler = {
                handleError: (error, context, showNotification = true) => {
                    console.error(`Error in ${context}:`, error);
                    if (showNotification) {
                        alert(`エラーが発生しました: ${error.message || error}`);
                    }
                },
                handleApiResponse: async (response, context) => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response;
                },
                showLoading: (button, text) => {
                    if (button) {
                        button.disabled = true;
                        button.dataset.originalText = button.textContent;
                        button.textContent = text || 'Loading...';
                    }
                },
                hideLoading: (button) => {
                    if (button) {
                        button.disabled = false;
                        button.textContent = button.dataset.originalText || button.textContent;
                    }
                },
                showNotification: (message, type, duration) => {
                    console.log(`${type.toUpperCase()}: ${message}`);
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        padding: 12px 20px;
                        background: ${type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : '#ef4444'};
                        color: white;
                        border-radius: 6px;
                        z-index: 10000;
                        font-size: 14px;
                    `;
                    notification.textContent = message;
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), duration || 3000);
                },
                getUserFriendlyMessage: (error, context) => {
                    return error.message || 'エラーが発生しました';
                }
            };
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>レポート履歴</h1>
            <p>過去に生成した投資分析レポートを確認・管理できます</p>
            <div style="margin-top: var(--space-4); display: flex; gap: var(--space-3); justify-content: center; flex-wrap: wrap;">
                <a href="/" class="btn btn-secondary" style="text-decoration: none;">
                    ← メインページに戻る
                </a>
                <a href="/investment-analysis.html" class="btn btn-primary" style="text-decoration: none;">
                    新しい投資分析を作成
                </a>
            </div>
        </header>

        <!-- Filter and Search -->
        <div class="card">
            <div style="display: flex; gap: var(--space-4); align-items: end; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                    <label for="searchQuery" class="form-label">検索</label>
                    <input 
                        type="text" 
                        id="searchQuery" 
                        class="input-field" 
                        placeholder="レポートタイトルや内容で検索..."
                    >
                </div>
                <div style="min-width: 150px;">
                    <label for="reportTypeFilter" class="form-label">レポート種別</label>
                    <select id="reportTypeFilter" class="input-field">
                        <option value="">すべて</option>
                        <option value="basic">基本分析</option>
                        <option value="intermediate">中級分析</option>
                        <option value="advanced">上級分析</option>
                    </select>
                </div>
                <div style="min-width: 150px;">
                    <label for="dateFilter" class="form-label">期間</label>
                    <select id="dateFilter" class="input-field">
                        <option value="">すべて</option>
                        <option value="today">今日</option>
                        <option value="week">過去1週間</option>
                        <option value="month">過去1ヶ月</option>
                        <option value="quarter">過去3ヶ月</option>
                    </select>
                </div>
                <button id="searchBtn" class="btn btn-primary">
                    検索
                </button>
            </div>
        </div>

        <!-- Report List -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-6);">
                <h2 style="margin: 0; font-size: var(--font-size-xl); font-weight: 600;">レポート一覧</h2>
                <div style="display: flex; gap: var(--space-2); align-items: center;">
                    <span id="reportCount" style="font-size: var(--font-size-sm); color: var(--color-gray-600);">
                        読み込み中...
                    </span>
                    <button id="refreshBtn" class="btn btn-secondary" style="padding: var(--space-2) var(--space-3);">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
                        </svg>
                        更新
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingSection" class="status-section">
                <div class="alert-content">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 alert-icon"></div>
                    <span>レポート履歴を読み込み中...</span>
                </div>
            </div>

            <!-- Report List Container -->
            <div id="reportListContainer">
                <!-- Reports will be inserted here -->
            </div>

            <!-- Pagination -->
            <div id="paginationContainer" class="hidden" style="margin-top: var(--space-6); text-align: center;">
                <div style="display: flex; justify-content: center; align-items: center; gap: var(--space-2);">
                    <button id="prevPageBtn" class="btn btn-secondary" disabled>
                        ← 前のページ
                    </button>
                    <span id="pageInfo" style="padding: 0 var(--space-4); color: var(--color-gray-600);">
                        1 / 1
                    </span>
                    <button id="nextPageBtn" class="btn btn-secondary" disabled>
                        次のページ →
                    </button>
                </div>
            </div>
        </div>

        <!-- Error Messages -->
        <div id="errorSection" class="hidden error-section">
            <div class="alert-content">
                <svg class="alert-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                </svg>
                <span id="errorText"></span>
            </div>
        </div>
    </div>

    <!-- Report Detail Modal -->
    <div id="reportModal" class="modal hidden">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <h3 id="modalReportTitle">レポート詳細</h3>
                <button type="button" class="modal-close" onclick="closeReportModal()">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div id="modalReportContent">
                    <!-- Report content will be inserted here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="copyReportContent()">
                    コピー
                </button>
                <button type="button" class="btn btn-secondary" onclick="downloadReportContent()">
                    ダウンロード
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeReportModal()">
                    閉じる
                </button>
            </div>
        </div>
    </div>

    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-6);
            border-bottom: 1px solid var(--color-gray-200);
        }

        .modal-header h3 {
            margin: 0;
            font-size: var(--font-size-lg);
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--color-gray-500);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: var(--color-gray-700);
        }

        .modal-body {
            padding: var(--space-6);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-3);
            padding: var(--space-6);
            border-top: 1px solid var(--color-gray-200);
        }

        .report-item {
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-4);
            background: white;
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .report-item:hover {
            border-color: var(--color-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .report-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-3);
        }

        .report-item-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--color-gray-900);
            margin-bottom: var(--space-1);
        }

        .report-item-meta {
            font-size: var(--font-size-sm);
            color: var(--color-gray-500);
        }

        .report-item-type {
            background: var(--color-primary-light);
            color: var(--color-primary);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: 600;
        }

        .report-item-summary {
            color: var(--color-gray-700);
            line-height: 1.6;
            margin-bottom: var(--space-3);
        }

        .report-item-actions {
            display: flex;
            gap: var(--space-2);
            justify-content: flex-end;
        }

        .report-action-btn {
            background: none;
            border: 1px solid var(--color-gray-300);
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--color-gray-700);
        }

        .report-action-btn:hover {
            background-color: var(--color-gray-50);
            border-color: var(--color-gray-400);
        }

        .report-action-btn.primary {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .report-action-btn.primary:hover {
            background: var(--color-primary-hover);
            border-color: var(--color-primary-hover);
        }

        .report-action-btn.danger {
            color: var(--color-error);
            border-color: var(--color-error);
        }

        .report-action-btn.danger:hover {
            background: var(--color-error-light);
        }

        .empty-state {
            text-align: center;
            padding: var(--space-12) var(--space-6);
            color: var(--color-gray-500);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: var(--space-4);
            color: var(--color-gray-300);
        }
    </style>

    <script type="module">
        // Authentication check
        let currentUser = null;
        let currentPage = 1;
        let totalPages = 1;
        let currentReports = [];
        let currentModalReport = null;
        
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/me-firebase', {
                    credentials: 'include'
                });
                
                await window.errorHandler.handleApiResponse(response, 'authentication');
                
                const result = await response.json();
                if (result.success && result.user) {
                    currentUser = result.user;
                    updateUIForLoggedInUser();
                    loadReports();
                } else {
                    console.error('Invalid response format:', result);
                    window.location.href = '/login.html';
                }
            } catch (error) {
                window.errorHandler.handleError(error, 'authentication', false);
                
                if (error.status === 401 || error.status === 403) {
                    window.location.href = '/login.html';
                } else {
                    window.errorHandler.showNotification(
                        'Unable to verify authentication. Please refresh the page.',
                        'warning'
                    );
                }
            }
        }

        function updateUIForLoggedInUser() {
            const header = document.querySelector('.header p');
            header.innerHTML = `こんにちは、${currentUser.name}さん！過去に生成した投資分析レポートを確認・管理できます`;
        }

        async function loadReports(page = 1) {
            try {
                showLoading();
                hideError();

                const searchQuery = document.getElementById('searchQuery').value;
                const reportTypeFilter = document.getElementById('reportTypeFilter').value;
                const dateFilter = document.getElementById('dateFilter').value;

                const params = new URLSearchParams({
                    page: page.toString(),
                    limit: '10'
                });

                if (searchQuery) params.append('search', searchQuery);
                if (reportTypeFilter) params.append('reportType', reportTypeFilter);
                if (dateFilter) params.append('dateFilter', dateFilter);

                const response = await fetch(`/api/reports/history?${params}`, {
                    credentials: 'include'
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || `HTTP ${response.status}: ${response.statusText}`);
                }

                currentReports = result.reports || [];
                currentPage = result.pagination?.currentPage || 1;
                totalPages = result.pagination?.totalPages || 1;

                displayReports(currentReports);
                updatePagination();
                updateReportCount(result.pagination?.totalCount || 0);

            } catch (error) {
                window.errorHandler.handleError(error, 'load-reports');
                showError('レポート履歴の読み込みに失敗しました');
            } finally {
                hideLoading();
            }
        }

        function displayReports(reports) {
            const container = document.getElementById('reportListContainer');

            if (reports.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                        </svg>
                        <h3 style="margin-bottom: var(--space-2);">レポートがありません</h3>
                        <p style="margin-bottom: var(--space-4);">まだ投資分析レポートが生成されていません。</p>
                        <a href="/investment-analysis.html" class="btn btn-primary" style="text-decoration: none;">
                            新しい投資分析を作成
                        </a>
                    </div>
                `;
                return;
            }

            container.innerHTML = reports.map(report => `
                <div class="report-item" onclick="openReportModal('${report.id}')">
                    <div class="report-item-header">
                        <div>
                            <div class="report-item-title">${escapeHtml(report.title || '投資分析レポート')}</div>
                            <div class="report-item-meta">
                                ${formatDate(report.createdAt)} | 
                                ${report.metadata?.processingTime ? `処理時間: ${report.metadata.processingTime}秒` : ''}
                            </div>
                        </div>
                        <div class="report-item-type">
                            ${getReportTypeLabel(report.reportType)}
                        </div>
                    </div>
                    <div class="report-item-summary">
                        ${truncateText(extractSummary(report.content), 200)}
                    </div>
                    <div class="report-item-actions" onclick="event.stopPropagation()">
                        <button class="report-action-btn primary" onclick="openReportModal('${report.id}')">
                            詳細表示
                        </button>
                        <button class="report-action-btn" onclick="downloadReport('${report.id}')">
                            ダウンロード
                        </button>
                        <button class="report-action-btn danger" onclick="deleteReport('${report.id}', '${escapeHtml(report.title || '投資分析レポート')}')">
                            削除
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function getReportTypeLabel(reportType) {
            const labels = {
                'basic': '基本分析',
                'intermediate': '中級分析',
                'advanced': '上級分析',
                'investment_analysis': '投資分析'
            };
            return labels[reportType] || '投資分析';
        }

        function extractSummary(content) {
            if (!content) return 'レポート内容なし';
            
            // Remove markdown formatting and get first few sentences
            const plainText = content
                .replace(/#{1,6}\s+/g, '')
                .replace(/\*\*(.*?)\*\*/g, '$1')
                .replace(/\*(.*?)\*/g, '$1')
                .replace(/\n+/g, ' ')
                .trim();
            
            return plainText;
        }

        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function formatDate(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString('ja-JP', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updatePagination() {
            const paginationContainer = document.getElementById('paginationContainer');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const pageInfo = document.getElementById('pageInfo');

            if (totalPages <= 1) {
                paginationContainer.classList.add('hidden');
                return;
            }

            paginationContainer.classList.remove('hidden');
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
            pageInfo.textContent = `${currentPage} / ${totalPages}`;
        }

        function updateReportCount(count) {
            const reportCount = document.getElementById('reportCount');
            reportCount.textContent = `${count}件のレポート`;
        }

        async function openReportModal(reportId) {
            try {
                const report = currentReports.find(r => r.id === reportId);
                if (!report) {
                    // Fetch individual report if not in current list
                    const response = await fetch(`/api/reports/${reportId}`, {
                        credentials: 'include'
                    });
                    
                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.error || 'レポートの取得に失敗しました');
                    }
                    
                    currentModalReport = result.report;
                } else {
                    currentModalReport = report;
                }

                document.getElementById('modalReportTitle').textContent = 
                    currentModalReport.title || '投資分析レポート';
                
                document.getElementById('modalReportContent').innerHTML = `
                    <div style="margin-bottom: var(--space-4);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2);">
                            <span class="report-item-type">${getReportTypeLabel(currentModalReport.reportType)}</span>
                            <span style="font-size: var(--font-size-sm); color: var(--color-gray-500);">
                                ${formatDate(currentModalReport.createdAt)}
                            </span>
                        </div>
                        ${currentModalReport.metadata ? `
                            <div style="font-size: var(--font-size-sm); color: var(--color-gray-600); margin-bottom: var(--space-3);">
                                ${currentModalReport.metadata.processingTime ? `処理時間: ${currentModalReport.metadata.processingTime}秒` : ''}
                                ${currentModalReport.metadata.apiCost ? ` | 推定コスト: ${currentModalReport.metadata.apiCost}` : ''}
                            </div>
                        ` : ''}
                    </div>
                    <div style="
                        border: 1px solid var(--color-gray-300); 
                        border-radius: 6px; 
                        padding: var(--space-4); 
                        background: var(--color-gray-50);
                        max-height: 400px;
                        overflow-y: auto;
                        font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif;
                        line-height: 1.6;
                    ">
                        ${formatReportContent(currentModalReport.content || 'レポート内容なし')}
                    </div>
                `;

                document.getElementById('reportModal').classList.remove('hidden');

            } catch (error) {
                window.errorHandler.handleError(error, 'open-report');
                showError('レポートの表示に失敗しました');
            }
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.add('hidden');
            currentModalReport = null;
        }

        function formatReportContent(content) {
            return content
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^# (.*$)/gm, '<h1 style="font-size: var(--font-size-xl); font-weight: 700; margin: var(--space-4) 0 var(--space-2) 0; color: var(--color-gray-900); border-bottom: 2px solid var(--color-primary); padding-bottom: var(--space-2);">$1</h1>')
                .replace(/^## (.*$)/gm, '<h2 style="font-size: var(--font-size-lg); font-weight: 600; margin: var(--space-3) 0 var(--space-2) 0; color: var(--color-primary);">$1</h2>')
                .replace(/^### (.*$)/gm, '<h3 style="font-size: var(--font-size-md); font-weight: 600; margin: var(--space-2) 0 var(--space-1) 0; color: var(--color-gray-700);">$1</h3>');
        }

        function copyReportContent() {
            if (!currentModalReport) return;
            
            navigator.clipboard.writeText(currentModalReport.content);
            window.errorHandler.showNotification('レポート内容をコピーしました', 'success', 2000);
        }

        function downloadReportContent() {
            if (!currentModalReport) return;
            
            const blob = new Blob([currentModalReport.content], { type: 'text/markdown; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentModalReport.title || 'investment_report'}_${new Date().toISOString().slice(0, 10)}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            window.errorHandler.showNotification('レポートをダウンロードしました', 'success', 2000);
        }

        async function downloadReport(reportId) {
            try {
                const report = currentReports.find(r => r.id === reportId);
                if (!report) return;

                const blob = new Blob([report.content], { type: 'text/markdown; charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${report.title || 'investment_report'}_${new Date().toISOString().slice(0, 10)}.md`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                window.errorHandler.showNotification('レポートをダウンロードしました', 'success', 2000);

            } catch (error) {
                window.errorHandler.handleError(error, 'download-report');
                showError('レポートのダウンロードに失敗しました');
            }
        }

        async function deleteReport(reportId, reportTitle) {
            if (!confirm(`「${reportTitle}」を削除しますか？この操作は取り消せません。`)) {
                return;
            }

            try {
                const response = await fetch(`/api/reports/${reportId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'レポートの削除に失敗しました');
                }

                window.errorHandler.showNotification('レポートを削除しました', 'success', 2000);
                
                // Reload current page
                await loadReports(currentPage);

            } catch (error) {
                window.errorHandler.handleError(error, 'delete-report');
                showError('レポートの削除に失敗しました');
            }
        }

        function showLoading() {
            document.getElementById('loadingSection').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingSection').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorSection').classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorSection').classList.add('hidden');
        }

        // Event listeners
        document.getElementById('searchBtn').addEventListener('click', () => {
            loadReports(1);
        });

        document.getElementById('refreshBtn').addEventListener('click', () => {
            loadReports(currentPage);
        });

        document.getElementById('prevPageBtn').addEventListener('click', () => {
            if (currentPage > 1) {
                loadReports(currentPage - 1);
            }
        });

        document.getElementById('nextPageBtn').addEventListener('click', () => {
            if (currentPage < totalPages) {
                loadReports(currentPage + 1);
            }
        });

        // Search on Enter key
        document.getElementById('searchQuery').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadReports(1);
            }
        });

        // Auto-search on filter change
        document.getElementById('reportTypeFilter').addEventListener('change', () => {
            loadReports(1);
        });

        document.getElementById('dateFilter').addEventListener('change', () => {
            loadReports(1);
        });

        // Check authentication on page load
        checkAuth();

        // Make functions globally accessible
        window.openReportModal = openReportModal;
        window.closeReportModal = closeReportModal;
        window.copyReportContent = copyReportContent;
        window.downloadReportContent = downloadReportContent;
        window.downloadReport = downloadReport;
        window.deleteReport = deleteReport;
    </script>
</body>
</html>