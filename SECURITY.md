# セキュリティガイド

## 🔐 認証システム

### パスワードセキュリティ
- **bcrypt** を使用した強力なパスワードハッシュ化（salt rounds: 12）
- パスワード要件：8文字以上、大文字・小文字・数字を含む
- パスワードは平文で保存されません

### セッション管理
- **JWT** ベースのセッショントークン
- 7日間の有効期限
- HTTP-only クッキーでセキュアに保存
- セッション無効化機能

### レート制限
- 認証エンドポイント：15分間に5回まで
- IPアドレスベースの制限
- 自動的な古い試行のクリーンアップ

## 🛡️ データ保護

### データベースセキュリティ
- **SQLite** データベース（本番環境では PostgreSQL 推奨）
- パスワードハッシュのみ保存
- 個人情報の最小化

### 暗号化
- パスワード：bcrypt ハッシュ
- セッショントークン：JWT 署名
- HTTPS 通信（本番環境必須）

## 🔒 セキュリティヘッダー

```javascript
// 自動設定されるセキュリティヘッダー
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block
Referrer-Policy: strict-origin-when-cross-origin
Permissions-Policy: geolocation=(), microphone=(), camera=()
```

## 📊 使用状況追跡

### 追跡される情報
- ユーザーID（匿名化可能）
- アクションタイプ（ログイン、レポート生成等）
- ファイル数・サイズ
- IPアドレス
- タイムスタンプ

### プライバシー保護
- 個人を特定できる情報は最小限
- 管理者のみが統計データにアクセス可能
- データ保持期間の設定可能

## 🚨 セキュリティベストプラクティス

### 本番環境での設定
1. **強力なJWTシークレット**を設定
2. **HTTPS**を有効化
3. **環境変数**で機密情報を管理
4. **定期的なセッションクリーンアップ**
5. **ログ監視**の実装

### 推奨設定
```bash
# 本番環境の環境変数
JWT_SECRET=your-very-strong-secret-key-here
NODE_ENV=production
FRONTEND_URL=https://yourdomain.com
```

## 🔍 監査ログ

### ログされるイベント
- ユーザー登録・ログイン
- レポート生成
- セッション作成・削除
- 管理者アクセス

### ログ形式
```json
{
  "user_id": 123,
  "action": "report_generated",
  "report_type": "jp_investment_4part",
  "file_count": 2,
  "file_size": 1024000,
  "ip_address": "192.168.1.1",
  "created_at": "2024-01-01T00:00:00Z"
}
```

## 🛠️ セキュリティチェックリスト

### 開発環境
- [ ] 強力なパスワード要件
- [ ] レート制限の実装
- [ ] セキュリティヘッダーの設定
- [ ] 入力検証の実装

### 本番環境
- [ ] HTTPS の有効化
- [ ] 強力なJWTシークレット
- [ ] データベースのセキュアな設定
- [ ] 定期的なセキュリティ更新
- [ ] ログ監視の実装

## 🔧 トラブルシューティング

### よくある問題
1. **認証エラー**: セッショントークンの有効期限確認
2. **レート制限**: 15分待機後に再試行
3. **CORS エラー**: FRONTEND_URL の設定確認

### セキュリティインシデント対応
1. 影響範囲の特定
2. セッションの一括無効化
3. ログの分析
4. 必要に応じてユーザー通知
