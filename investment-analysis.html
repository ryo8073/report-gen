<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•è³‡åˆ†æãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="/lib/frontend-error-handler.js"></script>
    <script src="/lib/enhanced-error-handler.js"></script>
    <script>
        // Ensure errorHandler is available
        if (typeof window.errorHandler === 'undefined') {
            console.warn('ErrorHandler not loaded, creating fallback');
            window.errorHandler = {
                handleError: (error, context, showNotification = true) => {
                    console.error(`Error in ${context}:`, error);
                    if (showNotification) {
                        alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message || error}`);
                    }
                },
                handleApiResponse: async (response, context) => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response;
                },
                showLoading: (button, text) => {
                    if (button) {
                        button.disabled = true;
                        button.dataset.originalText = button.textContent;
                        button.textContent = text || 'Loading...';
                    }
                },
                hideLoading: (button) => {
                    if (button) {
                        button.disabled = false;
                        button.textContent = button.dataset.originalText || button.textContent;
                    }
                },
                showNotification: (message, type, duration) => {
                    console.log(`${type.toUpperCase()}: ${message}`);
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        padding: 12px 20px;
                        background: ${type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : '#ef4444'};
                        color: white;
                        border-radius: 6px;
                        z-index: 10000;
                        font-size: 14px;
                    `;
                    notification.textContent = message;
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), duration || 3000);
                },
                getUserFriendlyMessage: (error, context) => {
                    return error.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                }
            };
        }
    </script>
    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--space-6);
            border-bottom: 1px solid var(--color-gray-200);
        }

        .modal-header h3 {
            margin: 0;
            font-size: var(--font-size-xl);
            font-weight: 600;
        }

        .modal-body {
            padding: 0;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Not Available Modal -->
    <div id="notAvailableModal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 style="color: #dc2626;">ğŸš§ æ©Ÿèƒ½æº–å‚™ä¸­</h3>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: var(--space-4);">
                    <svg width="64" height="64" fill="#f59e0b" viewBox="0 0 20 20" style="margin-bottom: var(--space-4);">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                    <h4 style="font-size: var(--font-size-lg); margin-bottom: var(--space-3); color: var(--color-gray-800);">
                        æŠ•è³‡åˆ†æãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã¯ç¾åœ¨æº–å‚™ä¸­ã§ã™
                    </h4>
                    <p style="color: var(--color-gray-600); margin-bottom: var(--space-4); line-height: 1.6;">
                        ã“ã®æ©Ÿèƒ½ã¯<strong style="color: var(--color-primary);">ã€ŒProformerä¸å‹•ç”£æŠ•è³‡è¨ºæ–­ãƒ—ãƒ­Â®ã€</strong>ã«ã¦æä¾›äºˆå®šã§ã™ã€‚<br>
                        ã‚ˆã‚Šè©³ç´°ã§å°‚é–€çš„ãªæŠ•è³‡åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’ãŠæ¥½ã—ã¿ã«ï¼
                    </p>
                    <p style="color: var(--color-gray-500); font-size: var(--font-size-sm); margin-bottom: var(--space-6);">
                        ç¾åœ¨ã¯ä¸€èˆ¬çš„ãªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚
                    </p>
                    <div style="display: flex; gap: var(--space-3); justify-content: center;">
                        <button onclick="goToMainPage()" class="btn btn-primary">
                            ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸
                        </button>
                        <button onclick="closeModal()" class="btn btn-secondary">
                            ã“ã®ãƒšãƒ¼ã‚¸ã‚’è¦‹ã‚‹
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>æŠ•è³‡åˆ†æãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</h1>
            <p>æŠ•è³‡ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ã€AIã«ã‚ˆã‚‹è©³ç´°ãªåˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã™</p>
            <div style="margin-top: var(--space-4);">
                <a href="/" class="btn btn-secondary" style="text-decoration: none;">
                    â† ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
                </a>
            </div>
        </header>

        <!-- Investment Data Input Form -->
        <div class="card">
            <form id="investmentForm">
                <!-- Report Type Selection -->
                <div class="form-group">
                    <label for="reportType" class="form-label">
                        ãƒ¬ãƒãƒ¼ãƒˆç¨®åˆ¥
                    </label>
                    <select id="reportType" name="reportType" class="input-field" required>
                        <option value="">ãƒ¬ãƒãƒ¼ãƒˆç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="basic">åŸºæœ¬åˆ†æãƒ¬ãƒãƒ¼ãƒˆ</option>
                        <option value="intermediate">ä¸­ç´šåˆ†æãƒ¬ãƒãƒ¼ãƒˆ</option>
                        <option value="advanced">ä¸Šç´šåˆ†æãƒ¬ãƒãƒ¼ãƒˆ</option>
                    </select>
                    <div style="margin-top: var(--space-2); font-size: var(--font-size-xs); color: var(--color-gray-500);">
                        <strong>åŸºæœ¬:</strong> ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªæ¦‚è¦ã¨åŸºæœ¬çš„ãªæ¨å¥¨äº‹é …<br>
                        <strong>ä¸­ç´š:</strong> ãƒªã‚¹ã‚¯åˆ†æã¨è©³ç´°ãªè³‡ç”£é…åˆ†ææ¡ˆ<br>
                        <strong>ä¸Šç´š:</strong> é«˜åº¦ãªæˆ¦ç•¥åˆ†æã¨å¸‚å ´äºˆæ¸¬ã‚’å«ã‚€åŒ…æ‹¬çš„ãƒ¬ãƒãƒ¼ãƒˆ
                    </div>
                </div>

                <!-- Investment Goals -->
                <div class="form-group">
                    <label for="investmentGoals" class="form-label">
                        æŠ•è³‡ç›®æ¨™
                    </label>
                    <textarea 
                        id="investmentGoals" 
                        name="investmentGoals" 
                        rows="3" 
                        class="input-field"
                        placeholder="ä¾‹ï¼š5å¹´å¾Œã«ä½å®…è³¼å…¥è³‡é‡‘ã¨ã—ã¦1000ä¸‡å††ã‚’ç›®æ¨™ã«ã—ã¦ã„ã¾ã™ã€‚å®‰å®šã—ãŸæˆé•·ã‚’é‡è¦–ã—ãŸã„ã§ã™ã€‚"
                        required
                    ></textarea>
                </div>

                <!-- Risk Tolerance -->
                <div class="form-group">
                    <label for="riskTolerance" class="form-label">
                        ãƒªã‚¹ã‚¯è¨±å®¹åº¦
                    </label>
                    <select id="riskTolerance" name="riskTolerance" class="input-field" required>
                        <option value="">ãƒªã‚¹ã‚¯è¨±å®¹åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="conservative">ä¿å®ˆçš„ï¼ˆä½ãƒªã‚¹ã‚¯ãƒ»ä½ãƒªã‚¿ãƒ¼ãƒ³ï¼‰</option>
                        <option value="moderate">ä¸­ç¨‹åº¦ï¼ˆãƒãƒ©ãƒ³ã‚¹é‡è¦–ï¼‰</option>
                        <option value="aggressive">ç©æ¥µçš„ï¼ˆé«˜ãƒªã‚¹ã‚¯ãƒ»é«˜ãƒªã‚¿ãƒ¼ãƒ³ï¼‰</option>
                        <option value="very_aggressive">éå¸¸ã«ç©æ¥µçš„ï¼ˆæœ€é«˜ãƒªã‚¹ã‚¯ãƒ»æœ€é«˜ãƒªã‚¿ãƒ¼ãƒ³ï¼‰</option>
                    </select>
                </div>

                <!-- Time Horizon -->
                <div class="form-group">
                    <label for="timeHorizon" class="form-label">
                        æŠ•è³‡æœŸé–“
                    </label>
                    <select id="timeHorizon" name="timeHorizon" class="input-field" required>
                        <option value="">æŠ•è³‡æœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="short">çŸ­æœŸï¼ˆ1å¹´æœªæº€ï¼‰</option>
                        <option value="medium">ä¸­æœŸï¼ˆ1-5å¹´ï¼‰</option>
                        <option value="long">é•·æœŸï¼ˆ5-10å¹´ï¼‰</option>
                        <option value="very_long">è¶…é•·æœŸï¼ˆ10å¹´ä»¥ä¸Šï¼‰</option>
                    </select>
                </div>

                <!-- Current Portfolio -->
                <div class="form-group">
                    <label for="currentPortfolio" class="form-label">
                        ç¾åœ¨ã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª
                    </label>
                    <textarea 
                        id="currentPortfolio" 
                        name="currentPortfolio" 
                        rows="6" 
                        class="input-field"
                        placeholder="ç¾åœ¨ã®æŠ•è³‡çŠ¶æ³ã‚’è©³ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ä¾‹ï¼š
- æ—¥æœ¬æ ªå¼: 300ä¸‡å††ï¼ˆãƒˆãƒ¨ã‚¿è‡ªå‹•è»Šã€ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—ãªã©ï¼‰
- ç±³å›½æ ªå¼: 200ä¸‡å††ï¼ˆAppleã€Microsoftã€S&P500 ETFãªã©ï¼‰
- å‚µåˆ¸: 100ä¸‡å††ï¼ˆæ—¥æœ¬å›½å‚µã€ç±³å›½å‚µåˆ¸ETFï¼‰
- ç¾é‡‘ãƒ»é é‡‘: 400ä¸‡å††
- ãã®ä»–: ä¸å‹•ç”£æŠ•è³‡ä¿¡è¨—ï¼ˆREITï¼‰50ä¸‡å††"
                        required
                    ></textarea>
                </div>

                <!-- Investment Amount -->
                <div class="form-group">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
                        <div>
                            <label for="totalInvestment" class="form-label">ç·æŠ•è³‡é¡ï¼ˆä¸‡å††ï¼‰</label>
                            <input 
                                type="number" 
                                id="totalInvestment" 
                                name="totalInvestment" 
                                class="input-field" 
                                placeholder="1000" 
                                min="0"
                                required
                            >
                        </div>
                        <div>
                            <label for="monthlyInvestment" class="form-label">æœˆæ¬¡æŠ•è³‡é¡ï¼ˆä¸‡å††ï¼‰</label>
                            <input 
                                type="number" 
                                id="monthlyInvestment" 
                                name="monthlyInvestment" 
                                class="input-field" 
                                placeholder="10" 
                                min="0"
                            >
                        </div>
                    </div>
                </div>

                <!-- Focus Areas -->
                <div class="form-group">
                    <label class="form-label">åˆ†æé‡ç‚¹é …ç›®ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-2); margin-top: var(--space-2);">
                        <label style="display: flex; align-items: center; gap: var(--space-2);">
                            <input type="checkbox" name="focusAreas" value="risk_analysis" style="margin: 0;">
                            ãƒªã‚¹ã‚¯åˆ†æ
                        </label>
                        <label style="display: flex; align-items: center; gap: var(--space-2);">
                            <input type="checkbox" name="focusAreas" value="diversification" style="margin: 0;">
                            åˆ†æ•£æŠ•è³‡
                        </label>
                        <label style="display: flex; align-items: center; gap: var(--space-2);">
                            <input type="checkbox" name="focusAreas" value="growth_potential" style="margin: 0;">
                            æˆé•·æ€§åˆ†æ
                        </label>
                        <label style="display: flex; align-items: center; gap: var(--space-2);">
                            <input type="checkbox" name="focusAreas" value="market_trends" style="margin: 0;">
                            å¸‚å ´å‹•å‘
                        </label>
                        <label style="display: flex; align-items: center; gap: var(--space-2);">
                            <input type="checkbox" name="focusAreas" value="tax_efficiency" style="margin: 0;">
                            ç¨å‹™åŠ¹ç‡
                        </label>
                        <label style="display: flex; align-items: center; gap: var(--space-2);">
                            <input type="checkbox" name="focusAreas" value="cost_analysis" style="margin: 0;">
                            ã‚³ã‚¹ãƒˆåˆ†æ
                        </label>
                    </div>
                </div>

                <!-- Additional Information -->
                <div class="form-group">
                    <label for="additionalInfo" class="form-label">
                        è¿½åŠ æƒ…å ±ãƒ»ç‰¹åˆ¥ãªè¦æœ›
                    </label>
                    <textarea 
                        id="additionalInfo" 
                        name="additionalInfo" 
                        rows="4" 
                        class="input-field"
                        placeholder="ãã®ä»–ã®æŠ•è³‡ã«é–¢ã™ã‚‹æƒ…å ±ã‚„ç‰¹åˆ¥ãªåˆ†æè¦æœ›ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ä¾‹ï¼š
- ESGæŠ•è³‡ã«èˆˆå‘³ãŒã‚ã‚‹
- ç‰¹å®šã®æ¥­ç•Œã‚’é¿ã‘ãŸã„
- é…å½“é‡è¦–ã®æŠ•è³‡æˆ¦ç•¥ã‚’æ¤œè¨ä¸­
- æµ·å¤–æŠ•è³‡ã®æ¯”ç‡ã‚’å¢—ã‚„ã—ãŸã„"
                    ></textarea>
                </div>

                <!-- Generate Button -->
                <div style="text-align: center; margin-top: var(--space-8);">
                    <button type="submit" id="generateBtn" class="btn btn-primary">
                        æŠ•è³‡åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
                    </button>
                </div>
            </form>
        </div>

        <!-- Status/Progress -->
        <div id="statusSection" class="hidden status-section">
            <div class="alert-content">
                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 alert-icon"></div>
                <span id="statusText">æŠ•è³‡åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­...</span>
            </div>
        </div>

        <!-- Results -->
        <div id="resultsSection" class="hidden results-section">
            <div class="results-header">
                <h2 class="results-title">æŠ•è³‡åˆ†æãƒ¬ãƒãƒ¼ãƒˆ</h2>
                <div class="results-actions">
                    <button id="copyBtn" class="btn btn-secondary">
                        ã‚³ãƒ”ãƒ¼
                    </button>
                    <button id="downloadBtn" class="btn btn-secondary">
                        .md ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </button>
                    <button id="saveReportBtn" class="btn btn-primary">
                        ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜
                    </button>
                </div>
            </div>
            <div id="preview" class="results-preview prose">
                <!-- Preview content will be inserted here -->
            </div>
        </div>

        <!-- Error Messages -->
        <div id="errorSection" class="hidden error-section">
            <div class="alert-content">
                <svg class="alert-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                </svg>
                <span id="errorText"></span>
            </div>
        </div>
    </div>

    <script type="module">
        // Authentication check
        let currentUser = null;
        
        // Trial site - no authentication needed
        function checkAuth() {
            console.log('Investment analysis page loaded - authentication disabled for trial');
        }

        function updateUIForLoggedInUser() {
            // No user-specific UI needed for trial
        }

        // Check authentication on page load
        checkAuth();

        // Form submission with enhanced progress tracking
        document.getElementById('investmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            // Collect form data
            const investmentData = {
                reportType: formData.get('reportType'),
                investmentGoals: formData.get('investmentGoals'),
                riskTolerance: formData.get('riskTolerance'),
                timeHorizon: formData.get('timeHorizon'),
                currentPortfolio: formData.get('currentPortfolio'),
                totalInvestment: formData.get('totalInvestment'),
                monthlyInvestment: formData.get('monthlyInvestment'),
                additionalInfo: formData.get('additionalInfo'),
                focusAreas: formData.getAll('focusAreas')
            };

            // Validate required fields
            if (!investmentData.reportType || !investmentData.investmentGoals || 
                !investmentData.riskTolerance || !investmentData.timeHorizon || 
                !investmentData.currentPortfolio || !investmentData.totalInvestment) {
                window.enhancedErrorHandler.showNotification(
                    'å¿…é ˆé …ç›®ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„',
                    'error',
                    5000,
                    {
                        userActions: [
                            'ãƒ¬ãƒãƒ¼ãƒˆç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„',
                            'æŠ•è³‡ç›®æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
                            'ãƒªã‚¹ã‚¯è¨±å®¹åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„',
                            'æŠ•è³‡æœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„',
                            'ç¾åœ¨ã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
                            'ç·æŠ•è³‡é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'
                        ]
                    }
                );
                return;
            }

            const submitBtn = document.querySelector('button[type="submit"]');
            let progressId = null;
            
            try {
                // Show enhanced progress tracking
                const reportTypeLabels = {
                    'basic': 'åŸºæœ¬åˆ†æ',
                    'intermediate': 'ä¸­ç´šåˆ†æ', 
                    'advanced': 'ä¸Šç´šåˆ†æ'
                };

                const estimatedTimes = {
                    'basic': '30-60ç§’',
                    'intermediate': '60-90ç§’',
                    'advanced': '90-120ç§’'
                };

                progressId = window.enhancedErrorHandler.showProgress(
                    `${reportTypeLabels[investmentData.reportType]}ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­...`,
                    {
                        steps: [
                            'æŠ•è³‡ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œè¨¼ä¸­',
                            'AIåˆ†æã‚¨ãƒ³ã‚¸ãƒ³ã«é€ä¿¡ä¸­',
                            'ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªåˆ†æã‚’å®Ÿè¡Œä¸­',
                            'ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­',
                            'ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜ä¸­'
                        ],
                        estimatedTime: estimatedTimes[investmentData.reportType]
                    }
                );

                // Show loading state on button
                window.enhancedErrorHandler.showLoading(submitBtn, 'ç”Ÿæˆä¸­...');
                hideError();
                hideResults();

                // Update progress - validation step
                window.enhancedErrorHandler.updateProgress(progressId, 'æŠ•è³‡ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œè¨¼ä¸­...', 0);

                // Simulate progress updates
                setTimeout(() => {
                    window.enhancedErrorHandler.updateProgress(progressId, 'AIåˆ†æã‚¨ãƒ³ã‚¸ãƒ³ã«é€ä¿¡ä¸­...', 1);
                }, 1000);

                setTimeout(() => {
                    window.enhancedErrorHandler.updateProgress(progressId, 'ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªåˆ†æã‚’å®Ÿè¡Œä¸­...', 2);
                }, 3000);

                const response = await fetch('/api/generate-investment-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    credentials: 'include',
                    body: JSON.stringify(investmentData)
                });

                // Update progress - generating report
                window.enhancedErrorHandler.updateProgress(progressId, 'ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­...', 3);

                const result = await response.json();
                
                if (!response.ok) {
                    // Handle enhanced error response
                    if (result.error && typeof result.error === 'object') {
                        window.enhancedErrorHandler.handleEnhancedError(result, 'investment-report-generation');
                    } else {
                        throw new Error(result.error || `HTTP ${response.status}: ${response.statusText}`);
                    }
                    return;
                }

                // Update progress - saving report
                window.enhancedErrorHandler.updateProgress(progressId, 'ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜ä¸­...', 4);

                // Simulate final save step
                setTimeout(() => {
                    displayResults(result);
                    window.enhancedErrorHandler.hideProgress(progressId);
                    
                    // Show success notification with report details
                    const reportInfo = result.data || result;
                    const processingTime = reportInfo.metadata?.processingTime || 0;
                    
                    window.enhancedErrorHandler.showNotification(
                        'æŠ•è³‡åˆ†æãƒ¬ãƒãƒ¼ãƒˆãŒæ­£å¸¸ã«ç”Ÿæˆã•ã‚Œã¾ã—ãŸ',
                        'success',
                        5000,
                        {
                            userActions: [
                                `å‡¦ç†æ™‚é–“: ${processingTime}ç§’`,
                                `ãƒ¬ãƒãƒ¼ãƒˆç¨®åˆ¥: ${reportTypeLabels[investmentData.reportType]}`,
                                'ãƒ¬ãƒãƒ¼ãƒˆã¯è‡ªå‹•çš„ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ'
                            ]
                        }
                    );
                }, 1000);

            } catch (error) {
                console.error('Report generation error:', error);
                
                if (progressId) {
                    window.enhancedErrorHandler.hideProgress(progressId);
                }
                
                // Use enhanced error handling
                window.enhancedErrorHandler.handleEnhancedError(error, 'investment-report-generation');
                
            } finally {
                window.enhancedErrorHandler.hideLoading(submitBtn);
            }
        });

        function showStatus(message) {
            document.getElementById('statusText').textContent = message;
            document.getElementById('statusSection').classList.remove('hidden');
        }

        function hideStatus() {
            document.getElementById('statusSection').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorSection').classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorSection').classList.add('hidden');
        }

        function hideResults() {
            document.getElementById('resultsSection').classList.add('hidden');
        }

        function displayResults(result) {
            const preview = document.getElementById('preview');
            const content = result.report || result.content || '';
            
            if (!content) {
                preview.innerHTML = '<p style="color: var(--color-red-600);">ãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸãŒã€å†…å®¹ã‚’è¡¨ç¤ºã§ãã¾ã›ã‚“ã€‚</p>';
                document.getElementById('resultsSection').classList.remove('hidden');
                return;
            }

            // Display the report content
            preview.innerHTML = `
                <div style="margin-bottom: var(--space-4);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2);">
                        <span style="font-size: var(--font-size-sm); color: var(--color-gray-600);">
                            ç”Ÿæˆã•ã‚ŒãŸæŠ•è³‡åˆ†æãƒ¬ãƒãƒ¼ãƒˆ
                        </span>
                        <div style="font-size: var(--font-size-xs); color: var(--color-gray-500);">
                            ${result.metadata ? `
                                ç”Ÿæˆæ—¥æ™‚: ${new Date(result.metadata.createdAt).toLocaleString('ja-JP')}
                                ${result.metadata.processingTime ? `<br>å‡¦ç†æ™‚é–“: ${result.metadata.processingTime}ç§’` : ''}
                            ` : ''}
                        </div>
                    </div>
                    <div 
                        id="reportContent" 
                        style="
                            border: 1px solid var(--color-gray-300); 
                            border-radius: 6px; 
                            padding: var(--space-4); 
                            background: white;
                            min-height: 400px;
                            font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif;
                            line-height: 1.6;
                        "
                    >${formatReportContent(content)}</div>
                </div>
            `;
            
            document.getElementById('resultsSection').classList.remove('hidden');

            // Store report data for saving
            window.currentReport = {
                content: content,
                metadata: result.metadata || {},
                investmentData: result.investmentData || {}
            };

            // Update button functionality
            setupResultButtons(content);
        }

        function formatReportContent(content) {
            // Simple markdown-like formatting
            return content
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^# (.*$)/gm, '<h1 style="font-size: var(--font-size-xl); font-weight: 700; margin: var(--space-4) 0 var(--space-2) 0; color: var(--color-gray-900); border-bottom: 2px solid var(--color-primary); padding-bottom: var(--space-2);">$1</h1>')
                .replace(/^## (.*$)/gm, '<h2 style="font-size: var(--font-size-lg); font-weight: 600; margin: var(--space-3) 0 var(--space-2) 0; color: var(--color-primary);">$1</h2>')
                .replace(/^### (.*$)/gm, '<h3 style="font-size: var(--font-size-md); font-weight: 600; margin: var(--space-2) 0 var(--space-1) 0; color: var(--color-gray-700);">$1</h3>');
        }

        function setupResultButtons(content) {
            // Copy functionality
            const copyBtn = document.getElementById('copyBtn');
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(content);
                
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'ã‚³ãƒ”ãƒ¼æ¸ˆã¿';
                copyBtn.style.background = 'var(--color-success)';
                copyBtn.style.color = 'white';
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = '';
                    copyBtn.style.color = '';
                }, 2000);
            };

            // Download functionality
            const downloadBtn = document.getElementById('downloadBtn');
            downloadBtn.onclick = () => {
                const blob = new Blob([content], { type: 'text/markdown; charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `investment_analysis_${new Date().toISOString().slice(0, 10)}.md`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                const originalText = downloadBtn.textContent;
                downloadBtn.textContent = 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿';
                setTimeout(() => downloadBtn.textContent = originalText, 2000);
            };

            // Save report functionality
            const saveReportBtn = document.getElementById('saveReportBtn');
            saveReportBtn.onclick = saveReport;
        }

        async function saveReport() {
            if (!window.currentReport) {
                showError('ä¿å­˜ã™ã‚‹ãƒ¬ãƒãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const saveBtn = document.getElementById('saveReportBtn');
            
            try {
                window.errorHandler.showLoading(saveBtn, 'ä¿å­˜ä¸­...');

                const response = await fetch('/api/reports/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        title: `æŠ•è³‡åˆ†æãƒ¬ãƒãƒ¼ãƒˆ - ${new Date().toLocaleDateString('ja-JP')}`,
                        reportType: 'investment_analysis',
                        content: window.currentReport.content,
                        metadata: window.currentReport.metadata,
                        investmentData: window.currentReport.investmentData
                    })
                });

                const result = await response.json();

                if (result.success) {
                    window.errorHandler.showNotification('ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success', 2000);
                    
                    // Update button to show saved state
                    saveBtn.textContent = 'ä¿å­˜æ¸ˆã¿';
                    saveBtn.style.background = 'var(--color-success)';
                    saveBtn.style.color = 'white';
                    
                    setTimeout(() => {
                        saveBtn.textContent = 'ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜';
                        saveBtn.style.background = '';
                        saveBtn.style.color = '';
                    }, 3000);
                } else {
                    throw new Error(result.error || 'ãƒ¬ãƒãƒ¼ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

            } catch (error) {
                window.errorHandler.handleError(error, 'report-save');
                showError('ãƒ¬ãƒãƒ¼ãƒˆã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            } finally {
                window.errorHandler.hideLoading(saveBtn);
            }
        }

        // Modal functions
        function closeModal() {
            document.getElementById('notAvailableModal').classList.add('hidden');
        }

        function goToMainPage() {
            window.location.href = '/';
        }

        // Show modal on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Show the modal immediately when page loads
            document.getElementById('notAvailableModal').classList.remove('hidden');
        });

        // Make functions globally accessible
        window.showError = showError;
        window.hideError = hideError;
        window.closeModal = closeModal;
        window.goToMainPage = goToMainPage;
    </script>
</body>
</html>